<!--
==================================================================================
IMPORTANT: READ ME BEFORE EDITING ANYTHING ON THIS CODE
==================================================================================

There are 6 UI displays for different device/orientation combinations:

1. DESKTOP (Default code)
   - Section: "DESKTOP DEVICE STYLES"
   - Same for GitHub Pages and Apps Script

2. TABLET PORTRAIT ORIENTATION
   - Section: "TABLET PORTRAIT - Reduced sizes (75% of mobile portrait)"
   - Same for GitHub Pages and Apps Script

3. TABLET LANDSCAPE ORIENTATION
   - Section: Combined in "LANDSCAPE MODE" with tablet-specific selectors
   - Same for GitHub Pages and Apps Script

4. MOBILE PORTRAIT ORIENTATION - Apps Script
   - Sections: "DEVICE-BASED MOBILE & TABLET STYLES"
              "PORTRAIT MODE - Larger text, bigger buttons"

5. MOBILE PORTRAIT ORIENTATION - GitHub Pages
   - Section: "GITHUB PAGES MOBILE PORTRAIT - 50% scaled down"
   - This is the MAIN UI difference between GitHub Pages and Apps Script

6. MOBILE LANDSCAPE ORIENTATION
   - Section: Combined in "LANDSCAPE MODE" with mobile-specific selectors
   - GitHub Pages has minor fixes (padding, flex-direction) in a separate area
   - Essentially same UI for GitHub Pages and Apps Script

NOTE: The LANDSCAPE MODE section is COMBINED for both Mobile and Tablet.
      They share one section with different CSS selectors:
      - Mobile: body.mobile-device.landscape
      - Tablet: body.tablet-device.landscape

DETECTION SYSTEM (working correctly):
- Device detection: mobile-device / tablet-device / desktop-device
- GitHub Pages detection: html.github-pages class
- Orientation detection: portrait / landscape classes

==================================================================================
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Catalogue web application">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#46599c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Catalogue">

    <!-- PWA Manifest - Static file for GitHub Pages -->
    <link rel="manifest" href="./manifest.json">

    <!-- API Configuration and Client (GitHub Pages Migration) -->
    <script src="./api-config.js"></script>
    <script src="./api-client.js"></script>

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">

    <title>Catalogue</title>

    <!-- GitHub Pages Detection - Add marker class -->
    <script>
      (function() {
        const isGitHubPages = window.location.hostname.includes('github.io');
        if (isGitHubPages) {
          document.documentElement.classList.add('github-pages');
          console.log('üåê GitHub Pages detected - applying specific mobile portrait styles');
        }
      })();
    </script>

    <!-- CRITICAL: Device Detection - Must run FIRST in head -->
    <script>
      (function() {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const touchPoints = navigator.maxTouchPoints || 0;

        console.log('üîç User Agent:', ua);
        console.log('üîç Touch Points:', touchPoints);

        // Detect tablets:
        // 1. Traditional tablet user agents (iPad, Android tablets, Kindle, etc.)
        const hasTabletUA = /ipad|android(?!.*mobile)|tablet|kindle|silk|playbook/i.test(ua);

        // 2. iPad in desktop mode (reports as Macintosh but has touch)
        const isiPadDesktopMode = /macintosh/i.test(ua) && touchPoints >= 1;

        const isTablet = hasTabletUA || isiPadDesktopMode;

        // Detect mobile phones
        const isMobile = /android.*mobile|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(ua);

        console.log('üìä Detection results - isTablet:', isTablet, ', isMobile:', isMobile);

        const deviceClass = isTablet ? 'tablet-device' : (isMobile ? 'mobile-device' : 'desktop-device');

        // Immediately set on HTML (blocks before page renders)
        // Remove other device classes but preserve other classes like 'github-pages'
        document.documentElement.classList.remove('mobile-device', 'tablet-device', 'desktop-device');
        document.documentElement.classList.add(deviceClass);
        document.documentElement.setAttribute('data-device', deviceClass);
        console.log('üîß Device class set on HTML (blocking):', deviceClass);

        // Set on body as soon as it's available (early, before full DOM load)
        function setBodyClass() {
          if (document.body) {
            // Remove other device classes but preserve other classes
            document.body.classList.remove('mobile-device', 'tablet-device', 'desktop-device');
            document.body.classList.add(deviceClass);
            console.log('‚úÖ Device: ' + deviceClass + ' (body class set early)');
            updateOrientation();
          } else {
            setTimeout(setBodyClass, 1);
          }
        }

        // Define orientation function
        function updateOrientation() {
          if (!document.body) return;

          document.body.classList.remove('landscape', 'portrait');
          const isLandscape = window.innerWidth > window.innerHeight;
          if (isLandscape) {
            document.body.classList.add('landscape');
            document.documentElement.setAttribute('data-orientation', 'landscape');
            console.log('üì± Orientation: Landscape');
          } else {
            document.body.classList.add('portrait');
            document.documentElement.setAttribute('data-orientation', 'portrait');
            console.log('üì± Orientation: Portrait');
          }

          // Move tab switcher based on orientation
          handleTabSwitcherPosition();

          // Reset and recalculate table widths if in table view
          const grid = document.getElementById('gridView');
          if (grid && grid.classList.contains('table-view')) {
            const table = document.querySelector('.data-table');
            const shell = document.querySelector('.shell');
            const topHeader = document.querySelector('.top-header');
            const filtersRow = document.querySelector('.filters-row');

            // CRITICAL: For GitHub Pages mobile, completely re-render the table view
            // This is necessary because table column widths get cached and don't update
            // properly when orientation changes, even with forced reflows
            const isGitHubPages = document.documentElement.classList.contains('github-pages');
            const isMobile = document.body.classList.contains('mobile-device');

            if (isGitHubPages && isMobile) {
              console.log('üîÑ Re-rendering table view for orientation change on GitHub Pages mobile');

              // IMMEDIATE reset of table widths before re-render
              if (typeof resetTableWidths === 'function') {
                resetTableWidths();
              }

              // Wait for orientation CSS to fully apply, then re-render
              setTimeout(() => {
                // Re-render based on current view type to preserve correct rendering
                if (currentView === "layer" && currentLayerIndex >= 0) {
                  // In layer view - re-render the layer
                  const layerName = layerConfig[currentLayerIndex].layerName;
                  const parentFilter = navigationStack.length > 0
                    ? navigationStack[navigationStack.length - 1].itemName
                    : null;
                  renderLayerView(currentLayerIndex, parentFilter);
                } else if (typeof renderList === 'function' && currentDisplayedItems && currentDisplayedItems.length > 0) {
                  // In main list view - re-render the list
                  renderList(currentDisplayedItems);
                } else if (typeof applyFiltersAndSorting === 'function') {
                  // Fallback: re-apply filters and sorting (for main layer)
                  applyFiltersAndSorting();
                }

                // Scroll to top-left to ensure clean state after orientation change
                requestAnimationFrame(() => {
                  window.scrollTo(0, 0);
                });
              }, 100); // Short delay to let CSS settle
            } else {
              // Non-GitHub Pages or desktop: Use normal width sync approach
              // IMMEDIATE reset: Remove ALL fixed widths so elements can resize naturally
              if (typeof resetTableWidths === 'function') {
                resetTableWidths();
              }

              // Force immediate reflow on ALL elements to clear cached dimensions
              if (table) void table.offsetWidth;
              if (shell) {
                void shell.offsetWidth;
                // Clear shell width immediately to prevent stale width from blocking natural resize
                shell.style.width = '';
                shell.style.minWidth = '';
              }
              if (topHeader) void topHeader.offsetWidth;
              if (filtersRow) void filtersRow.offsetWidth;

              // Wait for CSS orientation changes to fully apply
              setTimeout(() => {
                // Force another complete layout recalculation
                if (table) void table.offsetWidth;
                if (shell) void shell.offsetWidth;
                if (topHeader) void topHeader.offsetWidth;
                if (filtersRow) void filtersRow.offsetWidth;

                // Final RAF before syncing
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    // Ensure one more reflow before reading dimensions
                    if (table) void table.offsetWidth;
                    if (shell) void shell.offsetWidth;

                    if (typeof syncTableWidthToHeaders === 'function') {
                      console.log('üîÑ Syncing table widths after orientation change');
                      syncTableWidthToHeaders();
                    }
                  });
                });
              }, 150);
            }
          }
        }

        // Handle moving tab switcher between header and bottom bar
        function handleTabSwitcherPosition() {
          const tabSwitcher = document.getElementById('tabSwitcherWrapper');
          const bottomBarContent = document.getElementById('bottomBarContent');
          const centerBlock = document.querySelector('.top-header .center-block');

          // Only proceed if all elements exist
          if (!tabSwitcher || !bottomBarContent || !centerBlock) return;

          const deviceClass = document.body.className.split(' ')[0]; // mobile-device, tablet-device, or desktop-device
          const isMobileOrTablet = deviceClass === 'mobile-device' || deviceClass === 'tablet-device';
          const isPortrait = document.body.classList.contains('portrait');

          if (isMobileOrTablet && isPortrait) {
            // Move to bottom bar in portrait mode
            if (tabSwitcher.parentElement !== bottomBarContent) {
              bottomBarContent.appendChild(tabSwitcher);
              console.log('üì± Moved tab switcher to bottom bar');
            }
          } else {
            // Move back to header in landscape or desktop
            if (tabSwitcher.parentElement !== centerBlock) {
              centerBlock.appendChild(tabSwitcher);
              console.log('üì± Moved tab switcher to header');
            }
          }
        }

        // Make both functions globally available
        window.handleTabSwitcherPosition = handleTabSwitcherPosition;

        // Start setting body class immediately
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setBodyClass);
        } else {
          setBodyClass();
        }

        // Listen for orientation changes
        if (typeof window !== 'undefined') {
          window.addEventListener('resize', updateOrientation);
          window.addEventListener('orientationchange', updateOrientation);
        }

        // Make updateOrientation globally available
        window.updateOrientation = updateOrientation;
      })();
    </script>

    <style>
      :root {
        --bg: #f3f4fb;
        --surface: #ffffff;
        --surface-soft: #f7f7ff;
        --primary: #2563eb;
        --primary-soft: #e0ebff;
        --primary-dark: #1d4ed8;
        --danger: #ef4444;
        --text-main: #111827;
        --text-soft: #6b7280;
        --border-soft: #e5e7eb;
        --radius-lg: 18px;
        --radius-md: 10px;
        --radius-pill: 999px;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      /* Hide or style scrollbars */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
      }

      *::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      *::-webkit-scrollbar-track {
        background: transparent;
      }

      *::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }

      *::-webkit-scrollbar-thumb:hover {
        background-color: rgba(148, 163, 184, 0.5);
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        /* overflow-x: hidden; REMOVED - breaks position: sticky */
        border: none;
        outline: none;
      }

      body {
        padding: 18px 0 32px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
          "Segoe UI", sans-serif;
        background: radial-gradient(
          circle at top left,
          #e8f0ff,
          #f9fafb 42%,
          #eef2ff
        );
        color: var(--text-main);
        min-height: 100vh;
        /* Disable pinch-zoom globally to prevent viewport zoom */
        touch-action: pan-y pan-x;
      }

      .shell {
        max-width: 100%;
        width: 100%;
        margin: 0 auto;
        padding: 0 24px;
        border: none;
        outline: none;
        overflow: visible; /* Allow dropdowns to extend beyond container */
      }

      /* Top header ----------------------------------------------------------- */

      .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px 14px;
        border-radius: 20px;
        background: linear-gradient(135deg, #ffffffcc, #f3f4fffe);
        box-shadow: 0 16px 40px rgba(148, 163, 184, 0.28);
        backdrop-filter: blur(16px);
        margin-bottom: 18px;
        position: relative;
        z-index: 2000;
      }

      .center-block {
        display: flex;
        flex: 1;
        justify-content: center;
        align-items: center;
        padding: 0 20px;
      }

      /* Tab Switcher Styles */
      .tab-switcher-wrapper {
        position: relative;
        display: inline-block;
      }

      .tab-switcher-btn {
        height: 38px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: linear-gradient(135deg, #ffffff, #f8f9ff);
        font-size: 14px;
        font-weight: 600;
        padding: 0 18px;
        outline: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        white-space: nowrap;
        color: var(--text-main);
        box-shadow: 0 4px 12px rgba(148, 163, 184, 0.2);
        transition: all 0.2s ease;
      }

      .tab-switcher-btn:hover {
        background: linear-gradient(135deg, #f8f9ff, #e5edff);
        box-shadow: 0 6px 16px rgba(148, 163, 184, 0.3);
        transform: translateY(-1px);
      }

      .tab-switcher-btn:focus {
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
        border-color: #93c5fd;
      }

      .tab-switcher-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        min-width: 220px;
        background: white;
        border-radius: 14px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.25);
        padding: 8px;
        display: none;
        z-index: 10000;
        max-height: 400px;
        overflow-y: auto;
      }

      .tab-switcher-menu.show {
        display: block;
      }

      .tab-menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
        transition: background 0.15s ease;
        font-weight: 500;
      }

      .tab-menu-item:hover {
        background: #f3f4f6;
      }

      .tab-menu-item.active {
        background: linear-gradient(135deg, #e0e7ff, #dbeafe);
        color: #4338ca;
        font-weight: 600;
      }

      .tab-menu-item.active::before {
        content: '‚úì';
        font-weight: 700;
        color: #4338ca;
      }

      .left-block {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 12px;
      }

      .app-logo {
        height: 48px;
        width: auto;
        object-fit: contain;
      }

      .app-text-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .app-name {
        font-weight: 700;
        font-size: 22px;
        letter-spacing: 0.02em;
      }

      .user-role {
        font-size: 13px;
        color: var(--text-soft);
      }

      .catalog-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 3px;
      }

      .catalog-label {
        font-size: 13px;
        color: var(--text-soft);
      }

      .catalog-name {
        font-size: 15px;
        font-weight: 600;
      }

      .right-block {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        font-size: 13px;
        color: var(--text-soft);
      }

      .right-block > div:first-of-type {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px 4px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 10px 25px rgba(148, 163, 184, 0.35);
      }

      .user-email {
        font-weight: 500;
        color: var(--text-main);
      }

      .profile-badge {
        padding: 0 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #ffffff;
        background: linear-gradient(135deg, #6366f1, #2563eb);
      }

      /* Filters row --------------------------------------------------------- */

      .filters-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        margin-bottom: 14px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 10px 30px rgba(148, 163, 184, 0.35);
        gap: 12px;
        position: relative;
        z-index: 1000;
      }

      .filters-left {
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
      }

      .filters-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .dropdown-wrapper {
        position: relative;
        display: inline-block;
      }

      .btn-toolbar {
        height: 34px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #f3f4ff;
        font-size: 13px;
        padding: 0 14px;
        outline: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        white-space: nowrap;
      }

      .btn-toolbar:hover {
        background: #e5edff;
      }

      .btn-toolbar:focus {
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
        border-color: #93c5fd;
      }

      /* Search input */
      .search-wrapper {
        position: relative;
        display: inline-block;
      }

      .search-input {
        height: 34px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #ffffff;
        font-size: 13px;
        padding: 0 35px 0 14px;
        outline: none;
        width: 200px;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
        border-color: #93c5fd;
        width: 250px;
      }

      .search-input::placeholder {
        color: #9ca3af;
      }

      .clear-search-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: none;
        background: #e5e7eb;
        color: #6b7280;
        font-size: 12px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
      }

      .clear-search-btn:hover {
        background: #d1d5db;
        color: #374151;
      }

      .btn-primary {
        border: none;
        border-radius: 999px;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        font-weight: 500;
        padding: 0 16px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
      }

      .btn-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        border-radius: 999px;
        background: #2563eb;
        color: white;
        font-size: 10px;
        font-weight: 600;
      }

      /* Dropdown menus */
      .dropdown-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        min-width: 200px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.25);
        padding: 8px;
        display: none;
        z-index: 10000;
        max-height: 320px;
        overflow-y: auto;
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown-section {
        padding: 8px 0;
      }

      .dropdown-section:not(:last-child) {
        border-bottom: 1px solid #f3f4f6;
      }

      .dropdown-section-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        padding: 4px 10px;
        margin-bottom: 4px;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        transition: background 0.15s ease;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item.selected {
        background: #e0e7ff;
        color: #4338ca;
        font-weight: 500;
      }

      .dropdown-item input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid #d1d5db;
        background: white;
        position: relative;
      }

      .dropdown-item input[type="checkbox"]:checked {
        background: var(--primary);
        border-color: var(--primary);
      }

      .dropdown-item input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 6px 0;
      }

      .dropdown-actions {
        display: flex;
        gap: 6px;
        padding: 6px 4px 2px;
      }

      .dropdown-btn {
        flex: 1;
        padding: 5px 10px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .dropdown-btn:hover {
        background: #f9fafb;
      }

      .dropdown-btn.primary {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      .dropdown-btn.primary:hover {
        background: #1d4ed8;
      }

      /* Filter panels ------------------------------------------------------- */

      .filter-panel {
        position: fixed;
        z-index: 50;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.25);
      }

      .filter-panel-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 14px 16px 10px;
        width: 260px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
      }

      .filter-panel-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .filter-list {
        max-height: 180px;
        overflow-y: auto;
        font-size: 13px;
      }

      .filter-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .filter-panel-footer {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .chip-btn {
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: var(--surface-soft);
        font-size: 12px;
        padding: 4px 10px;
        cursor: pointer;
      }

      .chip-btn.primary {
        background: #2563eb;
        color: white;
        border: none;
      }

      /* Cards --------------------------------------------------------------- */

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 18px;
        margin-top: 8px;
      }

      .card {
        overflow: hidden;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 18px 40px rgba(148, 163, 184, 0.45);
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 22px 50px rgba(148, 163, 184, 0.6);
      }

      /* Progressive loading image wrapper - Square for all devices/orientations */
      .card-img-wrapper {
        position: relative;
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        background: #e5e7eb;
      }

      /* Card Style: Rectangle - wider aspect ratio */
      .card.style-rectangle .card-img-wrapper {
        aspect-ratio: 16 / 9;
      }

      /* Card Style: Circle - circular images with no padding */
      .card.style-circle {
        background: transparent;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .card.style-circle:hover {
        transform: none;
        box-shadow: none;
      }

      .card.style-circle .card-img-wrapper {
        aspect-ratio: 1 / 1;
        border-radius: 50%;
      }

      .card.style-circle .card-img {
        border-radius: 50%;
      }

      .card.style-circle .card-body {
        padding: 0;
        text-align: center;
        background: transparent;
        width: 100%;
      }

      .card.style-circle .card-name {
        font-size: 14px;
        font-weight: 600;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }

      .card.style-circle .card-sub {
        font-size: 12px;
        color: var(--text-soft);
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }

      .card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
      }

      .card-img.placeholder {
        filter: blur(20px);
        transform: scale(1.1);
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .card-img.full {
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .card-img.full.loaded {
        opacity: 1;
      }

      .card-body {
        padding: 10px 11px 12px;
      }

      .card-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .card-sub {
        font-size: 12px;
        color: var(--text-soft);
      }

      /* List View ----------------------------------------------------------- */
      .list-view {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
      }

      /* List Style: Simple - single column (default) */
      .list-view.style-simple {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* List Style: Double - 2 columns */
      .list-view.style-double {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* List Style: Triple - 3 columns */
      .list-view.style-triple {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        max-width: 100%;
        overflow-x: hidden;
      }

      .list-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        padding: 5px 12px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(148, 163, 184, 0.2);
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
        min-width: 0;
        max-width: 100%;
      }

      .list-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(148, 163, 184, 0.3);
      }

      .list-item-img-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        min-width: 100px;
        overflow: hidden;
        border-radius: 8px;
        background: #e5e7eb;
        flex-shrink: 0;
      }

      .list-item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
        overflow: hidden;
      }

      .list-item-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-main);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .list-item-sub {
        font-size: 14px;
        color: var(--text-soft);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Table View ---------------------------------------------------------- */
      .data-table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.02em;
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
      }

      .data-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background 0.12s ease;
      }

      .data-table tbody tr:hover {
        background: #f8fafc;
      }

      .data-table tbody tr:last-child {
        border-bottom: none;
      }

      .data-table td {
        padding: 12px 16px;
        font-size: 14px;
        color: var(--text-main);
      }

      /* Expanded row styles */
      .data-table tbody tr.row-expanded {
        background: #f0f9ff;
        border-left: 3px solid #3b82f6;
      }

      .data-table tbody tr.expanded-content-row {
        cursor: default;
        background: #f9fafb;
      }

      .data-table tbody tr.expanded-content-row:hover {
        background: #f9fafb;
      }

      .data-table tbody tr.expanded-content-row td {
        padding: 0;
      }

      /* Detail two-column grid for expanded view */
      .detail-two-column-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 16px;
        background: #e2e8f0;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #cbd5e1;
      }

      /* Table column headers with filter/sort controls */
      .table-header-cell {
        position: relative;
        padding: 10px 32px 10px 16px;
        cursor: pointer;
        user-select: none;
      }

      .table-header-cell:hover {
        filter: brightness(1.15);
      }

      .table-header-cell.sorted-asc::after {
        content: " ‚Üë";
        opacity: 0.8;
      }

      .table-header-cell.sorted-desc::after {
        content: " ‚Üì";
        opacity: 0.8;
      }

      /* Filter indicator badge */
      .filter-indicator {
        display: inline-block;
        margin-left: 6px;
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        font-size: 10px;
        font-weight: 700;
        vertical-align: middle;
      }

      /* Table cell image */
      .table-cell-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        display: block;
      }

      /* Table cell link */
      .table-cell-link {
        color: #6366f1;
        text-decoration: none;
        font-weight: 500;
      }

      .table-cell-link:hover {
        text-decoration: underline;
      }

      .table-column-menu {
        position: absolute; /* Absolute positioning relative to header cell - sticks with sticky header */
        top: 100%; /* Position below the header cell */
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 220px;
        max-width: 300px;
        max-height: 500px; /* Max height before internal scroll */
        overflow-y: auto; /* Scroll menu content if too long */
        z-index: 10000;
        display: none;
      }

      .table-column-menu.active {
        display: block;
      }

      /* Ensure table view doesn't clip the menus */
      .table-view {
        margin-top: 8px;
        /* All overflow removed - ANY overflow creates a scroll container that breaks position: sticky */
        /* Menus use position:absolute relative to header cells */
        /* For horizontal scrolling of wide tables, the table itself will handle it via display */
        position: relative;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px 12px 12px 12px; /* Rounded top corners */
        overflow: visible !important;
        box-shadow: 0 4px 12px rgba(148, 163, 184, 0.2);
      }

      .data-table thead {
        color: white;
      }

      .data-table thead tr:first-child th:first-child {
        border-top-left-radius: 12px;
      }

      .data-table thead tr:first-child th:last-child {
        border-top-right-radius: 12px;
      }

      .data-table tbody {
        overflow: visible !important;
      }

      .table-menu-section {
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .table-menu-section:last-child {
        border-bottom: none;
      }

      .table-menu-title {
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .table-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        transition: background 0.1s ease;
      }

      .table-menu-item:hover {
        background: #f3f4f6;
      }

      .table-filter-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
      }

      .table-filter-checkbox:hover {
        background: #f3f4f6;
      }

      .table-filter-checkbox input[type="checkbox"] {
        cursor: pointer;
      }

      .table-menu-button {
        width: 100%;
        padding: 8px 12px;
        background: transparent;
        border: none;
        text-align: left;
        font-size: 13px;
        color: #6366f1;
        cursor: pointer;
        font-weight: 500;
      }

      .table-menu-button:hover {
        background: #f3f4f6;
      }

      .table-menu-button-row {
        display: flex;
        gap: 8px;
        padding: 0 4px;
      }

      .table-menu-button-row .table-menu-button {
        flex: 1;
        text-align: center;
        border-radius: 6px;
      }

      .table-menu-items-row {
        display: flex;
        gap: 4px;
      }

      .table-menu-items-row .table-menu-item {
        flex: 1;
        text-align: center;
      }

      /* Portrait mode: Make Close/Clear buttons smaller for mobile and tablet */
      body.mobile-device.portrait .table-menu-button-row .table-menu-button,
      body.tablet-device.portrait .table-menu-button-row .table-menu-button {
        font-size: 20px !important;
        padding: 10px 20px !important;
        min-height: auto !important;
      }

      /* Portrait mode: Make table rows and text 1.5x bigger for mobile and tablet */
      body.mobile-device.portrait .data-table th,
      body.tablet-device.portrait .data-table th {
        padding: 21px 24px;
        font-size: 21px;
      }

      body.mobile-device.portrait .data-table td,
      body.tablet-device.portrait .data-table td {
        padding: 18px 24px;
        font-size: 21px;
      }

      body.mobile-device.portrait .table-cell-img,
      body.tablet-device.portrait .table-cell-img {
        width: 90px;
        height: 90px;
      }

      /* Detail view --------------------------------------------------------- */

      #detailView {
        display: none;
        margin-top: 8px;
        padding: 18px 20px 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: var(--shadow-soft);
      }

      /* Reduce gap between search bar and detail content - only portrait and desktop */
      body.portrait .shell:has(#detailView[style*="display: block"]) .filters-row,
      body.desktop-device .shell:has(#detailView[style*="display: block"]) .filters-row {
        margin-bottom: 8px !important;
      }

      .detail-layout {
        display: grid;
        grid-template-columns: minmax(0, 480px) minmax(0, 1fr);
        gap: 18px;
        position: relative;
      }

      /* When there's no image, make content full width on desktop */
      .detail-layout.no-image {
        grid-template-columns: 1fr;
      }

      .detail-img-wrapper {
        position: relative;
        width: 100%;
        overflow: hidden;
        border-radius: 16px;
        background: transparent;
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
      }

      .detail-img {
        width: 100%;
        height: auto;
        object-fit: contain;
        border-radius: 16px;
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
        display: block;
      }

      .detail-img.placeholder {
        filter: blur(20px);
        transform: scale(1.1);
        position: absolute;
        top: 0;
        left: 0;
        box-shadow: none !important;
      }

      .detail-img.full {
        position: relative;
        opacity: 0;
        transition: opacity 0.4s ease;
        box-shadow: none !important;
      }

      .detail-img.full.loaded {
        opacity: 1;
      }

      /* Hide placeholder when full image is loaded */
      .detail-img.full.loaded ~ .detail-img.placeholder {
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      #detailImgContainer {
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
      }

      /* Navigation arrow buttons for detail view */
      .nav-arrow-btn {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid #e2e8f0;
        color: #1e293b;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
      }

      .nav-arrow-btn:hover {
        background: #ffffff;
        border-color: #cbd5e1;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        transform: translateY(-50%) scale(1.05);
      }

      .nav-arrow-btn:active {
        transform: translateY(-50%) scale(0.95);
      }

      .nav-arrow-left {
        left: 12px;
      }

      .nav-arrow-right {
        right: 12px;
      }

      .detail-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .detail-name {
        font-size: 20px;
        font-weight: 700;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-top: 4px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-topcorner {
        font-size: 14px;
        color: #6b7280;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-meta {
        font-size: 12px;
        color: var(--text-soft);
        margin-bottom: 8px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-field {
        margin-bottom: 6px;
        font-size: 13px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
      }

      .detail-label {
        font-weight: 600;
      }

      .detail-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }

      .btn-secondary,
      .btn-danger {
        border-radius: 999px;
        border: none;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
      }

      .btn-secondary {
        background: #f3f4ff;
        color: #374151;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .link-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 12px;
        border-radius: 999px;
        background: #ecfdf5;
        color: #047857;
        font-size: 14px;
        font-weight: 700;
        text-decoration: none;
      }

      .back-btn {
        border-radius: 999px;
        border: none;
        background: #e5edff;
        color: #1d4ed8;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      /* Add/Edit & Columns modals ------------------------------------------- */

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
        z-index: 20000; /* Above everything including bottom-bar (9999), top-header, filters-row */
      }

      .modal-card {
        width: 360px;
        max-height: 80vh;
        overflow-y: auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 16px 18px 14px;
        box-shadow: 0 22px 55px rgba(15, 23, 42, 0.6);
      }

      .modal-box {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px 28px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        max-height: 90vh;
        overflow-y: auto;
        min-width: 480px;
      }

      .modal-card h3 {
        margin: 0 0 10px;
        font-size: 16px;
      }

      .modal-card label {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-soft);
      }

      .modal-card input {
        width: 100%;
        margin: 3px 0 10px;
        padding: 7px 9px;
        border-radius: 9px;
        border: 1px solid #d1d5db;
        font-size: 13px;
        outline: none;
      }

      .modal-card input:focus {
        border-color: #93c5fd;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #111827;
      }

      .modal-close-x {
        background: transparent;
        border: none;
        font-size: 24px;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .modal-close-x:hover {
        background: #f3f4f6;
        color: #374151;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-body label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
        margin-top: 16px;
      }

      .modal-body label:first-child {
        margin-top: 0;
      }

      .modal-body input[type="text"],
      .modal-body input[type="date"],
      .modal-body select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #111827;
        background: #ffffff;
        transition: all 0.2s;
        outline: none;
      }

      .modal-body input[type="text"]:focus,
      .modal-body input[type="date"]:focus,
      .modal-body select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .modal-body input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.6;
        padding: 4px;
        border-radius: 4px;
      }

      .modal-body input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
        background-color: #f3f4f6;
      }

      .modal-body input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #2563eb;
      }

      .modal-body label.checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
        cursor: pointer;
        font-weight: 400;
        color: #4b5563;
      }

      .modal-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .btn-text {
        border: none;
        background: transparent;
        font-size: 13px;
        color: #6b7280;
        cursor: pointer;
      }

      /* Fullscreen image viewer --------------------------------------------- */

      #imgOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.88);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        /* Prevent pinch-zoom to avoid zooming the viewport */
        touch-action: pan-y pan-x;
        /* Disable all background interactions */
        pointer-events: none;
      }

      #imgOverlayInner {
        position: relative;
        max-width: 100vw;
        max-height: 100vh;
        padding: 0;
        /* Prevent pinch-zoom to avoid zooming the viewport */
        touch-action: pan-y pan-x;
      }

      #imgOverlayTransform {
        position: relative;
        display: inline-block;
        /* Enable smooth zoom transforms */
        transform-origin: center center;
        will-change: transform;
        /* Prevent default pinch-zoom behavior - we handle it with JS */
        touch-action: none;
        /* Re-enable pointer events for the image and close button */
        pointer-events: auto;
      }

      #imgOverlayImg {
        display: block;
        max-width: 100vw;
        max-height: 100vh;
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        border-radius: 0;
        box-shadow: none;
        cursor: zoom-in;
        /* Prevent default pinch-zoom behavior - we handle it with JS */
        touch-action: none;
        user-select: none;
        -webkit-user-drag: none;
      }

      #imgOverlayClose {
        position: absolute;
        top: 12px;
        right: 12px;
        border: none;
        border-radius: 999px;
        padding: 4px 9px;
        background: rgba(15, 23, 42, 0.75);
        color: #e5e7eb;
        font-size: 16px;
        cursor: pointer;
        z-index: 10;
        pointer-events: auto;
      }

      #imgOverlayClose:hover {
        background: rgba(15, 23, 42, 0.95);
      }

      /* Custom Toast Notifications ------------------------------------------ */
      
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }

      .toast {
        background: white;
        border-radius: 12px;
        padding: 14px 18px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.35);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 280px;
        max-width: 400px;
        pointer-events: auto;
        animation: toastSlideIn 0.3s ease;
        border-left: 4px solid #2563eb;
      }

      .toast.success {
        border-left-color: #10b981;
      }

      .toast.error {
        border-left-color: #ef4444;
      }

      .toast.warning {
        border-left-color: #f59e0b;
      }

      .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
      }

      .toast-content {
        flex: 1;
        font-size: 14px;
        color: #374151;
      }

      .toast-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        flex-shrink: 0;
      }

      .toast-close:hover {
        background: #f3f4f6;
        color: #374151;
      }

      @keyframes toastSlideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes toastSlideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .toast.hiding {
        animation: toastSlideOut 0.3s ease;
      }

      /* Custom Confirm Dialog ----------------------------------------------- */
      
      .confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
      }

      .confirm-overlay.show {
        display: flex;
      }

      .confirm-dialog {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.4);
        animation: scaleIn 0.2s ease;
      }

      .confirm-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #111827;
      }

      .confirm-message {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .confirm-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .confirm-btn.cancel {
        background: #f3f4f6;
        color: #374151;
      }

      .confirm-btn.cancel:hover {
        background: #e5e7eb;
      }

      .confirm-btn.confirm {
        background: #ef4444;
        color: white;
      }

      .confirm-btn.confirm:hover {
        background: #dc2626;
      }

      /* Custom Prompt Dialog (for text input) ------------------------------- */
      
      .prompt-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
      }

      .prompt-overlay.show {
        display: flex;
      }

      .prompt-box,
      .prompt-dialog {
        background: white;
        border-radius: 16px;
        padding: 28px;
        max-width: 440px;
        width: 90%;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        animation: scaleIn 0.2s ease;
      }

      .prompt-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #111827;
      }

      .prompt-message {
        font-size: 15px;
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .prompt-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 20px;
        outline: none;
      }

      .prompt-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .prompt-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .prompt-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .prompt-btn.cancel {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
      }

      .prompt-btn.cancel:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
      }

      .prompt-btn.confirm {
        background: #2563eb;
        color: white;
      }

      .prompt-btn.confirm:hover {
        background: #1d4ed8;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Login Screen ---------------------------------------------------- */

      #loginScreen {
        display: none;
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top left, #e8f0ff, #f9fafb 42%, #eef2ff);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      #loginScreen.show {
        display: flex;
      }

      .login-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.2);
      }

      .login-header {
        text-align: center;
        margin-bottom: 32px;
      }

      .login-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
      }

      .login-subtitle {
        font-size: 14px;
        color: var(--text-soft);
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .login-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .login-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
      }

      .login-input {
        padding: 12px 16px;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        font-size: 15px;
        outline: none;
        transition: all 0.2s ease;
      }

      .login-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .login-input::placeholder {
        color: #9ca3af;
      }

      .login-btn {
        padding: 14px 24px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .login-btn-primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
      }

      .login-btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
      }

      .login-btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .login-btn-secondary {
        background: #f3f4f6;
        color: var(--text-main);
      }

      .login-btn-secondary:hover {
        background: #e5e7eb;
      }

      .login-message {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 16px;
      }

      .login-message.success {
        background: #ecfdf5;
        color: #047857;
        border: 1px solid #a7f3d0;
      }

      .login-message.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .login-step {
        display: none;
      }

      .login-step.active {
        display: block;
      }

      .login-back-btn {
        margin-top: 16px;
        text-align: center;
      }

      .login-back-btn button {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 13px;
        text-decoration: underline;
      }

      .login-back-btn button:hover {
        color: var(--primary-dark);
      }

      .login-loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* ==================== LOADING SCREEN ==================== */

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 20px;
      }

      .loading-image {
        max-height: 25vh;
        max-width: 80vw;
        object-fit: contain;
      }

      .loading-text {
        font-size: 18px;
        color: #374151;
        font-weight: 500;
        margin-top: 10px;
      }

      .loading-spinner-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
      }

      .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      /* ==================== RESPONSIVE DESIGN ==================== */

      /* Tablet and below (768px) */
      @media (max-width: 768px) {
        .shell {
          padding: 0 12px;
        }

        /* Stack header blocks vertically on tablets */
        .top-header {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }

        .right-block {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          width: 100%;
        }

        /* Detail view: single column on tablets */
        .detail-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        /* Adjust grid for tablets: 3-4 columns */
        .grid {
          grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          gap: 16px;
        }

        /* Make modals more mobile-friendly */
        .modal-box {
          max-width: 90vw !important;
          min-width: auto !important;
        }
      }

      /* ==================== DEVICE-BASED MOBILE & TABLET STYLES ==================== */
      /* Using device detection instead of media queries */
      /* These selectors apply ONLY to actual mobile/tablet devices */

      body.mobile-device .shell,
      body.tablet-device .shell {
        padding: 0 20px;
      }

      body.mobile-device .top-header,
      body.tablet-device .top-header {
        padding: 20px 20px;
        margin-bottom: 20px;
      }

      /* Hide navigation arrow buttons on mobile - use swipe instead */
      body.mobile-device .nav-arrow-btn,
      body.tablet-device .nav-arrow-btn {
        display: none !important;
      }

      /* LARGER TEXT SIZES FOR MOBILE - PORTRAIT */
      body.mobile-device .app-name,
      body.tablet-device .app-name {
        font-size: 30px !important;
        font-weight: 700 !important;
      }

      body.mobile-device .catalog-name,
      body.tablet-device .catalog-name {
        font-size: 25px !important;
        font-weight: 600 !important;
      }

      body.mobile-device .catalog-label,
      body.mobile-device .user-role,
      body.tablet-device .catalog-label,
      body.tablet-device .user-role {
        font-size: 18px !important;
      }

      body.mobile-device .user-email,
      body.tablet-device .user-email {
        font-size: 18px !important;
      }

      body.mobile-device .profile-badge,
      body.tablet-device .profile-badge {
        font-size: 16px !important;
        padding: 2px 10px !important;
      }

      /* Grid: 3 columns in PORTRAIT */
      body.mobile-device .grid,
      body.tablet-device .grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      /* Rectangle cards: 2 columns in mobile portrait */
      body.mobile-device .grid.grid-rectangle {
        grid-template-columns: repeat(2, 1fr);
      }

      /* BIGGER BUTTONS FOR PORTRAIT - 68px height */
      body.mobile-device .btn-toolbar,
      body.mobile-device .btn-primary,
      body.mobile-device .btn-secondary,
      body.tablet-device .btn-toolbar,
      body.tablet-device .btn-primary,
      body.tablet-device .btn-secondary {
        height: 68px !important;
        min-height: 68px !important;
        padding: 20px 28px !important;
        font-size: 19px !important;
        font-weight: 600 !important;
      }

      /* Logout button */
      body.mobile-device #logoutBtn,
      body.tablet-device #logoutBtn {
        height: 68px !important;
        min-height: 68px !important;
        padding: 0 28px !important;
        font-size: 18px !important;
      }

      /* Filter/Sort buttons */
      body.mobile-device #filterBtn,
      body.mobile-device #sortBtn,
      body.mobile-device #backToListBtn,
      body.tablet-device #filterBtn,
      body.tablet-device #sortBtn,
      body.tablet-device #backToListBtn {
        height: 68px !important;
        min-height: 68px !important;
        padding: 20px 28px !important;
        font-size: 19px !important;
      }

      /* Right toolbar buttons */
      body.mobile-device #sheetBtn,
      body.mobile-device #addBtn,
      body.tablet-device #sheetBtn,
      body.tablet-device #addBtn {
        height: 68px !important;
        min-height: 68px !important;
        padding: 20px 28px !important;
        font-size: 19px !important;
      }

      /* Search input on mobile */
      body.mobile-device .search-input,
      body.tablet-device .search-input {
        height: 68px !important;
        font-size: 19px !important;
        width: 100% !important;
        max-width: 300px;
        padding: 0 50px 0 20px !important;
      }

      body.mobile-device .search-input:focus,
      body.tablet-device .search-input:focus {
        width: 100% !important;
        max-width: 350px;
      }

      body.mobile-device .clear-search-btn,
      body.tablet-device .clear-search-btn {
        width: 32px !important;
        height: 32px !important;
        font-size: 18px !important;
        right: 12px !important;
      }

      /* Card text bigger */
      body.mobile-device .item-card,
      body.tablet-device .item-card {
        min-height: 180px;
        padding: 12px !important;
      }

      body.mobile-device .item-name,
      body.tablet-device .item-name {
        font-size: 22px !important;
        line-height: 1.4;
        font-weight: 600 !important;
      }

      body.mobile-device .item-subtitle,
      body.tablet-device .item-subtitle {
        font-size: 20px !important;
        margin-top: 6px !important;
      }

      /* Stack filters row on phones */
      body.mobile-device .filters-row,
      body.tablet-device .filters-row {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }

      /* Reduce filters-row padding and set minimal gap in mobile portrait */
      body.mobile-device.portrait .filters-row {
        padding: 2px 18px !important;
        gap: 2px !important;
      }

      /* Top-header: Reduce spacing to filters-row in mobile portrait */
      body.mobile-device.portrait .top-header {
        padding: 10px 20px !important;
        margin-bottom: 8px !important;
      }

      /* Mobile portrait: Reduce internal gaps in top-header */
      body.mobile-device.portrait .left-block {
        gap: 8px !important;
      }

      body.mobile-device.portrait .app-text-block {
        gap: 0px !important;
      }

      body.mobile-device .filters-left,
      body.mobile-device .filters-right,
      body.tablet-device .filters-left,
      body.tablet-device .filters-right {
        width: 100%;
        justify-content: flex-start;
      }

      /* Dropdown menus full width on mobile */
      body.mobile-device .dropdown-menu,
      body.tablet-device .dropdown-menu {
        left: 0;
        right: 0;
        width: 100%;
      }

      /* Modal adjustments for phones */
      body.mobile-device .modal-box,
      body.tablet-device .modal-box {
        padding: 20px;
        max-width: 95vw !important;
      }

      body.mobile-device .modal-header,
      body.tablet-device .modal-header {
        font-size: 18px;
      }

      /* Form inputs touch-friendly */
      body.mobile-device input[type="text"],
      body.mobile-device input[type="email"],
      body.mobile-device input[type="number"],
      body.mobile-device input[type="date"],
      body.mobile-device input[type="url"],
      body.mobile-device textarea,
      body.mobile-device select,
      body.tablet-device input[type="text"],
      body.tablet-device input[type="email"],
      body.tablet-device input[type="number"],
      body.tablet-device input[type="date"],
      body.tablet-device input[type="url"],
      body.tablet-device textarea,
      body.tablet-device select {
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      /* ==================== TABLET PORTRAIT - Reduced sizes (75% of mobile portrait) ==================== */

      /* Grid: 4 columns for tablet portrait */
      body.tablet-device.portrait .grid {
        grid-template-columns: repeat(4, 1fr);
      }

      /* Rectangle cards: 3 columns in tablet portrait */
      body.tablet-device.portrait .grid.grid-rectangle {
        grid-template-columns: repeat(3, 1fr);
      }

      /* Top-header padding: 20px ‚Üí 6px, margin-bottom: 20px ‚Üí 10px */
      body.tablet-device.portrait .top-header {
        padding: 6px 15px !important;
        margin-bottom: 10px !important;
      }

      /* Logo: 48px ‚Üí 36px */
      body.tablet-device.portrait .app-logo {
        width: 36px !important;
        height: 36px !important;
      }

      /* Header text sizes: 25% reduction */
      body.tablet-device.portrait .app-name {
        font-size: 23px !important;
      }

      body.tablet-device.portrait .catalog-name {
        font-size: 19px !important;
      }

      body.tablet-device.portrait .user-email {
        font-size: 14px !important;
      }

      body.tablet-device.portrait .catalog-label,
      body.tablet-device.portrait .user-role {
        font-size: 14px !important;
      }

      /* Search bar: 68px ‚Üí 51px, 19px ‚Üí 14px */
      body.tablet-device.portrait .search-input {
        height: 51px !important;
        font-size: 14px !important;
        padding: 0 50px 0 15px !important;
      }

      body.tablet-device.portrait .clear-search-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 14px !important;
      }

      /* Buttons: 68px ‚Üí 51px, padding and font reduced */
      body.tablet-device.portrait .btn-toolbar,
      body.tablet-device.portrait .btn-primary,
      body.tablet-device.portrait .btn-secondary {
        height: 51px !important;
        min-height: 51px !important;
        padding: 15px 21px !important;
        font-size: 14px !important;
      }

      body.tablet-device.portrait #logoutBtn {
        height: 51px !important;
        min-height: 51px !important;
        padding: 0 21px !important;
        font-size: 14px !important;
      }

      body.tablet-device.portrait #filterBtn,
      body.tablet-device.portrait #sortBtn,
      body.tablet-device.portrait #backToListBtn {
        height: 51px !important;
        min-height: 51px !important;
        padding: 15px 21px !important;
        font-size: 14px !important;
      }

      body.tablet-device.portrait #sheetBtn,
      body.tablet-device.portrait #addBtn {
        height: 51px !important;
        min-height: 51px !important;
      }

      /* Filters-row: Reduce padding, margin, and set minimal gap */
      body.tablet-device.portrait .filters-row {
        padding: 2px 12px !important;
        margin-bottom: 8px !important;
        gap: 2px !important;
      }

      /* Reduce gaps inside top-header for tablet portrait */
      body.tablet-device.portrait .left-block {
        gap: 6px !important;
      }

      body.tablet-device.portrait .app-text-block {
        gap: 0px !important;
      }

      /* Reduce gaps inside filters for tablet portrait */
      body.tablet-device.portrait .filters-left,
      body.tablet-device.portrait .filters-right {
        gap: 6px !important;
      }

      /* Card text sizes: 15% reduction from base */
      body.tablet-device.portrait .item-name {
        font-size: 14px !important;
      }

      body.tablet-device.portrait .item-subtitle {
        font-size: 13px !important;
      }

      /* Profile badge: smaller */
      body.tablet-device.portrait .profile-badge {
        font-size: 12px !important;
        padding: 2px 8px !important;
      }

      /* ==================== LANDSCAPE MODE - Smaller buttons, smaller text, 6 columns ==================== */
      /* Reduce paddings and header elements in landscape */
      body.mobile-device.landscape .shell,
      body.tablet-device.landscape .shell {
        padding: 0 10px;
      }

      body.mobile-device.landscape .top-header {
        padding: 4px 10px;
        margin-bottom: 6px;
        align-items: center;
        min-height: 68px;
      }

      /* Bigger top-header for tablet landscape - reduced by 25% */
      body.tablet-device.landscape .top-header {
        padding: 9px 11px;
        margin-bottom: 8px;
        align-items: center;
        min-height: 51px;
      }

      /* Logo size in landscape: 60px for mobile, 70px for tablet */
      body.mobile-device.landscape .app-logo {
        width: 60px;
        height: 60px;
        margin: 0;
      }

      body.tablet-device.landscape .app-logo {
        width: 53px;
        height: 53px;
        margin: 0;
      }

      body.mobile-device.landscape .left-block,
      body.tablet-device.landscape .left-block {
        gap: 6px;
      }

      /* Right-block: Put everything on one line (Signed in: email badge + Login button) */
      body.mobile-device.landscape .right-block,
      body.tablet-device.landscape .right-block {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }

      /* Filters-row: Keep buttons in same row, aligned to right */
      body.mobile-device.landscape .filters-row {
        padding: 2px 4px;
        margin-bottom: 0;
        align-items: center;
        flex-direction: row;
        justify-content: space-between;
      }

      /* Bigger filters-row for tablet landscape - reduced by 25% */
      body.tablet-device.landscape .filters-row {
        padding: 2px 11px;
        margin-bottom: 3px;
        align-items: center;
        flex-direction: row;
        justify-content: space-between;
      }

      /* Override mobile width: 100% for landscape - let items size naturally */
      body.mobile-device.landscape .filters-left,
      body.tablet-device.landscape .filters-left {
        width: auto;
        flex-shrink: 1;
      }

      /* Buttons stay in normal flow on the right side */
      body.mobile-device.landscape .filters-right,
      body.tablet-device.landscape .filters-right {
        width: auto;
        gap: 6px;
        flex-shrink: 0;
      }


      /* Smaller header text in MOBILE landscape */
      body.mobile-device.landscape .app-name {
        font-size: 16px !important;
      }

      body.mobile-device.landscape .catalog-label {
        font-size: 12px !important;
      }

      body.mobile-device.landscape .catalog-name {
        font-size: 14px !important;
      }

      body.mobile-device.landscape .user-role {
        font-size: 12px !important;
      }

      body.mobile-device.landscape .user-email {
        font-size: 12px !important;
      }

      body.mobile-device.landscape .profile-badge {
        font-size: 11px !important;
        padding: 2px 6px !important;
      }

      /* Bigger header text for TABLET landscape - reduced by 25% */
      body.tablet-device.landscape .app-name {
        font-size: 19px !important;
      }

      body.tablet-device.landscape .catalog-label {
        font-size: 13px !important;
      }

      body.tablet-device.landscape .catalog-name {
        font-size: 15px !important;
      }

      body.tablet-device.landscape .user-role {
        font-size: 13px !important;
      }

      body.tablet-device.landscape .user-email {
        font-size: 13px !important;
      }

      body.tablet-device.landscape .profile-badge {
        font-size: 12px !important;
        padding: 3px 8px !important;
      }

      /* Smaller search bar in MOBILE landscape */
      body.mobile-device.landscape .search-input {
        height: 36px !important;
        font-size: 14px !important;
        padding: 0 40px 0 12px !important;
      }

      body.mobile-device.landscape .clear-search-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 14px !important;
        right: 8px !important;
      }

      /* Bigger search bar for TABLET landscape - reduced by 25% */
      body.tablet-device.landscape .search-input {
        height: 36px !important;
        font-size: 14px !important;
        padding: 0 36px 0 12px !important;
      }

      body.tablet-device.landscape .clear-search-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 14px !important;
        right: 8px !important;
      }

      /* Breadcrumb styling for MOBILE landscape - reduce margins */
      body.mobile-device.landscape #breadcrumbNav {
        margin: 0 !important;
        padding: 0 !important;
      }

      /* Breadcrumb styling for TABLET landscape - reduced by 25% */
      body.tablet-device.landscape #breadcrumbNav {
        font-size: 20px !important;
        margin: 6px 0 !important;
        padding: 5px 0 !important;
        line-height: 1.5 !important;
      }

      body.tablet-device.landscape #breadcrumbNav a {
        padding: 5px 3px !important;
        font-size: 20px !important;
      }

      body.tablet-device.landscape #breadcrumbNav span {
        margin: 0 8px !important;
        font-size: 20px !important;
      }

      /* Grid: 6 columns in MOBILE LANDSCAPE */
      body.mobile-device.landscape .grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        margin-top: 8px;
      }

      /* Rectangle cards: 4 columns in mobile landscape */
      body.mobile-device.landscape .grid.grid-rectangle {
        grid-template-columns: repeat(4, 1fr);
      }

      /* Grid: 8 columns for TABLET LANDSCAPE */
      body.tablet-device.landscape .grid {
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        margin-top: 8px;
      }

      /* Rectangle cards: 4 columns in tablet landscape */
      body.tablet-device.landscape .grid.grid-rectangle {
        grid-template-columns: repeat(4, 1fr);
      }

      /* Detail view gap: 4px in landscape - reduce margin AND padding */
      body.mobile-device.landscape #detailView,
      body.tablet-device.landscape #detailView {
        margin-top: 0 !important;
        padding-top: 20px !important;
      }

      /* Keep buttons at current size - already configured below */

      /* SMALLER BUTTONS FOR MOBILE LANDSCAPE - 40px */
      body.mobile-device.landscape .btn-toolbar,
      body.mobile-device.landscape .btn-primary,
      body.mobile-device.landscape .btn-secondary,
      body.mobile-device.landscape .btn-danger,
      body.mobile-device.landscape #logoutBtn,
      body.mobile-device.landscape #filterBtn,
      body.mobile-device.landscape #sortBtn,
      body.mobile-device.landscape #backToListBtn,
      body.mobile-device.landscape #sheetBtn,
      body.mobile-device.landscape #addBtn {
        height: 40px !important;
        min-height: 40px !important;
        padding: 8px 16px !important;
        font-size: 14px !important;
      }

      /* BIGGER BUTTONS FOR TABLET LANDSCAPE - reduced by 25% */
      body.tablet-device.landscape .btn-toolbar,
      body.tablet-device.landscape .btn-primary,
      body.tablet-device.landscape .btn-secondary,
      body.tablet-device.landscape .btn-danger,
      body.tablet-device.landscape #logoutBtn,
      body.tablet-device.landscape #filterBtn,
      body.tablet-device.landscape #sortBtn,
      body.tablet-device.landscape #backToListBtn,
      body.tablet-device.landscape #sheetBtn,
      body.tablet-device.landscape #addBtn {
        height: 38px !important;
        min-height: 38px !important;
        padding: 9px 15px !important;
        font-size: 12px !important;
      }

      /* Smaller card text in MOBILE landscape */
      body.mobile-device.landscape .item-name {
        font-size: 15px !important;
      }

      body.mobile-device.landscape .item-subtitle {
        font-size: 14px !important;
      }

      body.mobile-device.landscape .item-card {
        min-height: 150px;
      }

      /* Bigger card text for TABLET landscape - reduced by 25% */
      body.tablet-device.landscape .item-name {
        font-size: 15px !important;
      }

      body.tablet-device.landscape .item-subtitle {
        font-size: 14px !important;
      }

      body.tablet-device.landscape .item-card {
        min-height: 128px;
      }

      /* Make card images square in TABLET landscape */
      body.tablet-device.landscape .card-img-wrapper {
        height: auto !important;
        aspect-ratio: 1 / 1 !important;
      }

      /* Rectangle cards: maintain 16:12 aspect ratio in tablet landscape */
      body.tablet-device.landscape .card.style-rectangle .card-img-wrapper {
        aspect-ratio: 16 / 12 !important;
        height: auto !important;
      }

      /* Detail view layout - MOBILE LANDSCAPE: Restore side-by-side */
      body.mobile-device.landscape .detail-layout {
        grid-template-columns: minmax(0, 360px) minmax(0, 1fr) !important;
        gap: 16px;
      }

      /* When there's no image, make content full width on mobile landscape */
      body.mobile-device.landscape .detail-layout.no-image {
        grid-template-columns: 1fr !important;
      }

      /* Detail view layout - TABLET LANDSCAPE: Bigger image column - reduced by 25% */
      body.tablet-device.landscape .detail-layout {
        grid-template-columns: minmax(0, 375px) minmax(0, 1fr) !important;
        gap: 15px;
      }

      /* When there's no image, make content full width on tablet landscape */
      body.tablet-device.landscape .detail-layout.no-image {
        grid-template-columns: 1fr !important;
      }

      body.mobile-device.landscape .detail-img,
      body.tablet-device.landscape .detail-img {
        height: auto !important;
        object-fit: contain !important;
      }

      /* Detail view text sizes - MOBILE LANDSCAPE */
      body.mobile-device.landscape .detail-name {
        font-size: 20px !important;
      }

      body.mobile-device.landscape .detail-subtitle {
        font-size: 16px !important;
      }

      body.mobile-device.landscape .detail-topcorner {
        font-size: 16px !important;
      }

      body.mobile-device.landscape .detail-meta {
        font-size: 16px !important;
      }

      body.mobile-device.landscape .detail-field {
        font-size: 15px !important;
      }

      body.mobile-device.landscape .detail-field-label {
        font-size: 15px !important;
      }

      body.mobile-device.landscape .detail-field-value {
        font-size: 15px !important;
      }

      /* Detail view text sizes - TABLET LANDSCAPE - reduced by 25% */
      body.tablet-device.landscape .detail-name {
        font-size: 23px !important;
      }

      body.tablet-device.landscape .detail-subtitle {
        font-size: 18px !important;
      }

      body.tablet-device.landscape .detail-topcorner {
        font-size: 17px !important;
      }

      body.tablet-device.landscape .detail-meta {
        font-size: 17px !important;
      }

      body.tablet-device.landscape .detail-field {
        font-size: 15px !important;
      }

      body.tablet-device.landscape .detail-field-label {
        font-size: 15px !important;
      }

      body.tablet-device.landscape .detail-field-value {
        font-size: 15px !important;
      }

      /* ==================== PORTRAIT MODE - Larger text, bigger buttons ==================== */
      /* Portrait mode shell padding */
      body.mobile-device.portrait .shell,
      body.tablet-device.portrait .shell {
        padding: 0 12px !important;
      }

      /* Logo 2x bigger in portrait mode (NOT WORKING FOR SOME REASON) */
      body.mobile-device.portrait .app-logo,
      body.tablet-device.portrait .app-logo {
        width: 96px !important;
        height: 96px !important;
        min-width: 96px !important;
        min-height: 96px !important;
        max-width: 96px !important;
        max-height: 96px !important;
        margin: 0 !important;
        object-fit: contain !important;
      }

      /* Ensure symmetrical margins - adjust container padding */
      body.mobile-device.portrait #detailView,
      body.tablet-device.portrait #detailView {
        padding: 16px !important;
        margin-left: 0;
        margin-right: 0;
        width: 100%;
        box-sizing: border-box;
      }

      /* Detail view layout - PORTRAIT: Use landscape-style side-by-side layout ONLY for Table + Open Detail View */
      body.mobile-device.portrait #detailView[data-table-open-detail="true"] .detail-layout {
        grid-template-columns: minmax(0, 360px) minmax(0, 1fr) !important;
        gap: 16px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      body.tablet-device.portrait #detailView[data-table-open-detail="true"] .detail-layout {
        grid-template-columns: minmax(0, 375px) minmax(0, 1fr) !important;
        gap: 16px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      /* Default PORTRAIT mode: Use single-column stacked layout for all other cases */
      body.mobile-device.portrait #detailView:not([data-table-open-detail="true"]) .detail-layout,
      body.tablet-device.portrait #detailView:not([data-table-open-detail="true"]) .detail-layout {
        grid-template-columns: 1fr !important;
        gap: 16px;
      }

      body.mobile-device.portrait .detail-two-column-grid,
      body.tablet-device.portrait .detail-two-column-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 16px;
      }

      body.mobile-device.portrait .detail-img-wrapper,
      body.tablet-device.portrait .detail-img-wrapper {
        width: 100% !important;
        max-width: 100% !important;
        max-height: none !important;
        box-sizing: border-box !important;
        margin: 0 !important;
      }

      body.mobile-device.portrait .detail-img,
      body.tablet-device.portrait .detail-img {
        width: 100% !important;
        height: auto !important;
        object-fit: contain !important;
        display: block;
        margin: 0 !important;
      }

      /* Ensure text wraps properly */
      body.mobile-device.portrait .detail-field,
      body.mobile-device.portrait .detail-name,
      body.mobile-device.portrait .detail-subtitle,
      body.mobile-device.portrait .detail-topcorner,
      body.mobile-device.portrait .detail-meta,
      body.tablet-device.portrait .detail-field,
      body.tablet-device.portrait .detail-name,
      body.tablet-device.portrait .detail-subtitle,
      body.tablet-device.portrait .detail-topcorner,
      body.tablet-device.portrait .detail-meta {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
      }

      /* Make image zoom close button MUCH bigger for portrait */
      body.mobile-device.portrait #imgOverlayClose,
      body.tablet-device.portrait #imgOverlayClose {
        font-size: 32px !important;
        padding: 8px 14px !important;
        top: 20px !important;
        right: 20px !important;
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Detail view text sizes - PORTRAIT */
      body.mobile-device.portrait .detail-container,
      body.tablet-device.portrait .detail-container {
        padding: 16px;
      }

      body.mobile-device.portrait .detail-name {
        font-size: 37.5px !important;
      }

      body.tablet-device.portrait .detail-name {
        font-size: 30px !important;
      }

      body.mobile-device.portrait .detail-subtitle {
        font-size: 31.25px !important;
      }

      body.tablet-device.portrait .detail-subtitle {
        font-size: 25px !important;
      }

      /* Make the text container positioned so Top Corner positions relative to it */
      body.mobile-device.portrait .detail-layout > div:not(#detailImgContainer),
      body.tablet-device.portrait .detail-layout > div:not(#detailImgContainer) {
        position: relative;
      }

      body.mobile-device.portrait .detail-topcorner {
        font-size: 31.25px !important;
        top: 0 !important;
        right: 0 !important;
      }

      body.tablet-device.portrait .detail-topcorner {
        font-size: 25px !important;
        top: 0 !important;
        right: 0 !important;
      }

      body.mobile-device.portrait .detail-meta,
      body.tablet-device.portrait .detail-meta {
        font-size: 25px !important;
      }

      body.mobile-device.portrait .detail-field {
        font-size: 27.5px !important;
      }

      body.tablet-device.portrait .detail-field {
        font-size: 22px !important;
      }

      body.mobile-device.portrait .detail-field-label {
        font-size: 27.5px !important;
      }

      body.tablet-device.portrait .detail-field-label {
        font-size: 22px !important;
      }

      body.mobile-device.portrait .detail-field-value {
        font-size: 27.5px !important;
      }

      body.tablet-device.portrait .detail-field-value {
        font-size: 22px !important;
      }

      /* Make external link buttons bigger in portrait */
      body.mobile-device.portrait .link-pill,
      body.tablet-device.portrait .link-pill {
        font-size: 24px !important;
        padding: 10px 18px !important;
      }

      /* Card adjustments - MUCH LARGER TEXT */
      body.mobile-device.portrait .item-card,
      body.tablet-device.portrait .item-card {
        min-height: 180px;
        padding: 12px !important;
      }

      body.mobile-device.portrait .card-name,
      body.tablet-device.portrait .card-name {
        font-size: 26px !important;
        line-height: 1.4;
        font-weight: 600 !important;
      }

      body.mobile-device.portrait .card-sub,
      body.tablet-device.portrait .card-sub {
        font-size: 22px !important;
      }

      /* List view text - 50% bigger in portrait */
      body.mobile-device.portrait .list-item-name,
      body.tablet-device.portrait .list-item-name {
        font-size: 24px !important;
      }

      body.mobile-device.portrait .list-item-sub,
      body.tablet-device.portrait .list-item-sub {
        font-size: 21px !important;
      }

      /* Make all buttons bigger in portrait */
      body.mobile-device.portrait button,
      body.mobile-device.portrait .btn,
      body.mobile-device.portrait .btn-primary,
      body.mobile-device.portrait .btn-secondary,
      body.mobile-device.portrait .btn-danger,
      body.mobile-device.portrait .back-btn,
      body.mobile-device.portrait .sort-btn,
      body.mobile-device.portrait .filter-pill,
      body.tablet-device.portrait button,
      body.tablet-device.portrait .btn,
      body.tablet-device.portrait .btn-primary,
      body.tablet-device.portrait .btn-secondary,
      body.tablet-device.portrait .btn-danger,
      body.tablet-device.portrait .back-btn,
      body.tablet-device.portrait .sort-btn,
      body.tablet-device.portrait .filter-pill {
        min-height: 80px !important;
        font-size: 28px !important;
        padding: 12px 24px !important;
      }

      /* Make Filter and Sort button text even bigger */
      body.mobile-device.portrait .btn-toolbar,
      body.mobile-device.portrait #filterBtn,
      body.mobile-device.portrait #sortBtn,
      body.mobile-device.portrait #backToListBtn,
      body.mobile-device.portrait #sheetBtn,
      body.mobile-device.portrait #addBtn,
      body.tablet-device.portrait .btn-toolbar,
      body.tablet-device.portrait #filterBtn,
      body.tablet-device.portrait #sortBtn,
      body.tablet-device.portrait #backToListBtn,
      body.tablet-device.portrait #sheetBtn,
      body.tablet-device.portrait #addBtn {
        font-size: 28px !important;
        min-height: 80px !important;
        padding: 12px 24px !important;
      }

      /* Exception: Keep Image Zoom Close Button at original size */
      body.mobile-device.portrait #imgOverlayClose,
      body.tablet-device.portrait #imgOverlayClose {
        font-size: 32px !important;
        padding: 8px 14px !important;
        min-width: 48px !important;
        min-height: 48px !important;
      }

      /* Form inputs bigger in portrait */
      body.mobile-device.portrait input[type="text"],
      body.mobile-device.portrait input[type="email"],
      body.mobile-device.portrait input[type="password"],
      body.mobile-device.portrait input[type="date"],
      body.mobile-device.portrait input[type="url"],
      body.mobile-device.portrait textarea,
      body.tablet-device.portrait input[type="text"],
      body.tablet-device.portrait input[type="email"],
      body.tablet-device.portrait input[type="password"],
      body.tablet-device.portrait input[type="date"],
      body.tablet-device.portrait input[type="url"],
      body.tablet-device.portrait textarea {
        font-size: 22px !important;
        min-height: 80px !important;
      }

      /* Dropdown menus bigger in portrait */
      body.mobile-device.portrait select,
      body.tablet-device.portrait select {
        font-size: 88px !important;
        min-height: 80px !important;
      }

      /* Dropdown menu content bigger in portrait */
      body.mobile-device.portrait .dropdown-menu,
      body.tablet-device.portrait .dropdown-menu {
        padding: 16px !important;
        max-height: 600px !important;
        min-width: 500px !important;
        width: auto !important;
      }

      body.mobile-device.portrait .dropdown-section-title,
      body.tablet-device.portrait .dropdown-section-title {
        font-size: 28px !important;
        padding: 12px 16px !important;
      }

      body.mobile-device.portrait .dropdown-item,
      body.tablet-device.portrait .dropdown-item {
        font-size: 36px !important;
        padding: 16px 20px !important;
        gap: 16px !important;
      }

      body.mobile-device.portrait .dropdown-item input[type="checkbox"],
      body.mobile-device.portrait .dropdown-item input[type="radio"],
      body.tablet-device.portrait .dropdown-item input[type="checkbox"],
      body.tablet-device.portrait .dropdown-item input[type="radio"] {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
      }

      body.mobile-device.portrait .dropdown-item input[type="checkbox"]:checked::after,
      body.tablet-device.portrait .dropdown-item input[type="checkbox"]:checked::after {
        top: 6px !important;
        left: 6px !important;
        width: 20px !important;
        height: 20px !important;
      }

      body.mobile-device.portrait .dropdown-item span,
      body.tablet-device.portrait .dropdown-item span {
        font-size: 36px !important;
      }

      /* Make Clear Filters button smaller */
      body.mobile-device.portrait .dropdown-btn,
      body.tablet-device.portrait .dropdown-btn {
        font-size: 34px !important;
        padding: 8px 16px !important;
      }

      /* Login screen adjustments */
      body.mobile-device.portrait .login-box,
      body.tablet-device.portrait .login-box {
        padding: 32px 24px;
        max-width: 95vw;
      }

      body.mobile-device.portrait .login-title,
      body.tablet-device.portrait .login-title {
        font-size: 24px;
      }

      /* Breadcrumb navigation - 2x bigger for easier touch navigation */
      body.mobile-device.portrait #breadcrumbNav,
      body.tablet-device.portrait #breadcrumbNav {
        font-size: 26px !important;
        margin: 12px 0 !important;
        padding: 8px 0 !important;
        line-height: 1.5 !important;
      }

      body.mobile-device.portrait #breadcrumbNav a,
      body.tablet-device.portrait #breadcrumbNav a {
        padding: 8px 4px !important;
        font-size: 26px !important;
      }

      body.mobile-device.portrait #breadcrumbNav span,
      body.tablet-device.portrait #breadcrumbNav span {
        margin: 0 12px !important;
        font-size: 26px !important;
      }

      /* ==================== BOTTOM BAR FOR PORTRAIT MODE ==================== */
      /* Bottom bar - hidden by default */
      .bottom-bar {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 9999;
      }

      /* Show bottom bar in portrait mode only */
      body.mobile-device.portrait .bottom-bar,
      body.tablet-device.portrait .bottom-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 -4px 20px rgba(15, 23, 42, 0.1);
        padding: 20px 20px 30px 20px;
        min-height: 100px;
      }

      .bottom-bar-content {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 600px;
      }

      /* Hide tab switcher from top header in portrait mode (when empty) */
      body.mobile-device.portrait .top-header .center-block:empty,
      body.tablet-device.portrait .top-header .center-block:empty {
        display: none !important;
      }

      /* Style tab switcher when in bottom bar (portrait mode) */
      body.mobile-device.portrait .bottom-bar-content #tabSwitcherWrapper,
      body.tablet-device.portrait .bottom-bar-content #tabSwitcherWrapper {
        position: relative;
        margin: 0;
      }

      /* Make tab switcher button bigger in portrait mode for easier touch */
      body.mobile-device.portrait .tab-switcher-btn,
      body.tablet-device.portrait .tab-switcher-btn {
        height: 70px !important;
        font-size: 32px !important;
        padding: 0 32px !important;
        min-height: 70px !important;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.3) !important;
      }

      /* Adjust tab menu position for bottom placement */
      body.mobile-device.portrait .tab-switcher-menu,
      body.tablet-device.portrait .tab-switcher-menu {
        top: auto !important;
        bottom: calc(100% + 12px) !important;
        max-height: 500px !important;
        font-size: 32px !important;
      }

      body.mobile-device.portrait .tab-menu-item,
      body.tablet-device.portrait .tab-menu-item {
        font-size: 32px !important;
        padding: 16px 20px !important;
        min-height: 70px !important;
      }

      /* Add bottom padding to shell to prevent content from being hidden */
      body.mobile-device.portrait .shell,
      body.tablet-device.portrait .shell {
        padding-bottom: 130px !important;
      }

      /* Add bottom padding to gridView to ensure last items are visible */
      body.mobile-device.portrait #gridView,
      body.tablet-device.portrait #gridView {
        padding-bottom: 20px !important;
      }

      /* ==================== DESKTOP DEVICE STYLES ==================== */
      /* Desktop: 12px side borders total */
      /* Multiple selectors for maximum compatibility */
      body.desktop-device,
      html.desktop-device body,
      html[data-device="desktop-device"] body {
        padding: 18px 0 32px !important;
      }

      body.desktop-device .shell,
      html.desktop-device .shell,
      html[data-device="desktop-device"] .shell {
        padding: 0 24px;
      }

      /* Grid: 25% smaller on desktop */
      body.desktop-device .grid,
      html.desktop-device .grid,
      html[data-device="desktop-device"] .grid {
        grid-template-columns: repeat(auto-fill, minmax(143px, 1fr));
        gap: 14px;
      }

      /* Rectangle cards: 2x bigger on desktop */
      body.desktop-device .grid.grid-rectangle,
      html.desktop-device .grid.grid-rectangle,
      html[data-device="desktop-device"] .grid.grid-rectangle {
        grid-template-columns: repeat(auto-fill, minmax(286px, 1fr));
      }

      /* Grid item text: 15% smaller on desktop */
      body.desktop-device .card-name,
      html.desktop-device .card-name,
      html[data-device="desktop-device"] .card-name {
        font-size: 12px !important;
      }

      body.desktop-device .card-sub,
      html.desktop-device .card-sub,
      html[data-device="desktop-device"] .card-sub {
        font-size: 10px !important;
      }

      /* Filters-row: Reduce top and bottom padding on desktop */
      body.desktop-device .filters-row,
      html.desktop-device .filters-row,
      html[data-device="desktop-device"] .filters-row {
        padding: 5px 18px !important;
      }

      /* Top-header: Reduce spacing to filters-row on desktop */
      body.desktop-device .top-header,
      html.desktop-device .top-header,
      html[data-device="desktop-device"] .top-header {
        padding: 8px 20px 6px !important;
        margin-bottom: 8px !important;
      }

      /* Desktop: Reduce internal gaps in top-header */
      body.desktop-device .left-block,
      html.desktop-device .left-block,
      html[data-device="desktop-device"] .left-block {
        gap: 8px !important;
      }

      body.desktop-device .app-text-block,
      html.desktop-device .app-text-block,
      html[data-device="desktop-device"] .app-text-block {
        gap: 0px !important;
      }

      /* Large desktop (1440px and up) - optimize for big screens - desktop only */
      @media (min-width: 1440px) {
        /* More columns on large screens - 25% smaller */
        body.desktop-device .grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 15px;
        }

        /* Rectangle cards: 2x bigger on large desktop */
        body.desktop-device .grid.grid-rectangle {
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
      }

      /* Ultra-wide (1920px and up) - desktop only */
      @media (min-width: 1920px) {
        body.desktop-device .grid {
          grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
          gap: 18px;
        }

        /* Rectangle cards: 2x bigger on ultra-wide */
        body.desktop-device .grid.grid-rectangle {
          grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
        }
      }


      /* ==================== PWA INSTALL BANNER (GitHub Pages Only) ==================== */
      /* Hidden by default, shown via JavaScript when beforeinstallprompt fires */

      html.github-pages .pwa-install-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, var(--pwa-theme-color, #36488a) 0%, var(--pwa-theme-color-dark, #2d3c73) 100%);
        color: white;
        z-index: 10000;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      html.github-pages .pwa-install-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        max-width: 600px;
        margin: 0 auto;
        gap: 16px;
      }

      html.github-pages .pwa-install-icon {
        font-size: 32px;
        flex-shrink: 0;
      }

      html.github-pages .pwa-install-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      html.github-pages .pwa-install-text strong {
        font-size: 16px;
        font-weight: 600;
      }

      html.github-pages .pwa-install-text span {
        font-size: 13px;
        opacity: 0.9;
      }

      html.github-pages .pwa-install-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-shrink: 0;
      }

      html.github-pages .pwa-install-btn {
        background: white;
        color: var(--pwa-theme-color, #36488a);
        border: none;
        padding: 10px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      html.github-pages .pwa-install-btn:hover {
        background: #f0f0f0;
        transform: scale(1.05);
      }

      html.github-pages .pwa-dismiss-btn {
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.5);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      html.github-pages .pwa-dismiss-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
      }

      /* Mobile adjustments for PWA banner */
      html.github-pages body.mobile-device .pwa-install-content {
        padding: 12px 16px;
        gap: 12px;
      }

      html.github-pages body.mobile-device .pwa-install-icon {
        font-size: 28px;
      }

      html.github-pages body.mobile-device .pwa-install-text strong {
        font-size: 14px;
      }

      html.github-pages body.mobile-device .pwa-install-text span {
        font-size: 12px;
      }

      html.github-pages body.mobile-device .pwa-install-btn {
        padding: 8px 18px;
        font-size: 13px;
      }

      html.github-pages body.mobile-device .pwa-dismiss-btn {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }

      /* Tablet adjustments */
      html.github-pages body.tablet-device .pwa-install-content {
        max-width: 700px;
        padding: 14px 24px;
      }

      /* GitHub Pages Mobile Portrait - 60% button size and touch bottom bar */
      html.github-pages body.mobile-device.portrait .pwa-install-banner {
        bottom: 53px !important; /* Touch the bottom bar/tab switcher */
      }

      html.github-pages body.mobile-device.portrait .pwa-install-content {
        padding: 5px 10px !important; /* 60% reduced height */
        gap: 7px !important;
        min-height: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .pwa-install-icon {
        font-size: 17px !important;
      }

      html.github-pages body.mobile-device.portrait .pwa-install-text strong {
        font-size: 8px !important;
      }

      html.github-pages body.mobile-device.portrait .pwa-install-text span {
        font-size: 7px !important;
      }

      html.github-pages body.mobile-device.portrait .pwa-install-btn {
        height: 18px !important;
        min-height: 18px !important;
        max-height: 18px !important;
        padding: 0 11px !important;
        font-size: 8px !important;
        line-height: 18px !important;
        border-radius: 10px !important;
        box-sizing: border-box !important;
      }

      html.github-pages body.mobile-device.portrait .pwa-dismiss-btn {
        width: 17px !important;
        min-width: 17px !important;
        max-width: 17px !important;
        height: 17px !important;
        min-height: 17px !important;
        max-height: 17px !important;
        font-size: 8px !important;
        border-width: 1px !important;
        border-radius: 50% !important;
        padding: 0 !important;
        line-height: 17px !important;
        box-sizing: border-box !important;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }


      /* ==================== GITHUB PAGES MOBILE PORTRAIT - 50% scaled down ==================== */
      /*  GitHub Pages renders mobile portrait at 2x size - scale down to 50% to match Apps Script */

      html.github-pages body.mobile-device.portrait .top-header {
        padding: 5px 10px 5px 10px !important;
        margin-bottom: 4px !important;
        position: relative !important;
        min-height: auto !important;
        height: auto !important;
        max-height: none !important;
        align-items: flex-start !important;
      }

      /* Ensure center-block doesn't create vertical space */
      html.github-pages body.mobile-device.portrait .center-block {
        display: none !important;
        height: 0 !important;
        min-height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        flex: 0 !important;
      }

      /* Remove internal margins/gaps that create vertical space */
      html.github-pages body.mobile-device.portrait .left-block {
        margin: 0 !important;
        gap: 5px !important;
        align-items: center !important;
      }

      html.github-pages body.mobile-device.portrait .app-text-block {
        margin: 0 !important;
        gap: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .catalog-row {
        margin: 0 !important;
        padding: 0 !important;
        gap: 3px !important;
        height: auto !important;
        min-height: 0 !important;
        line-height: 1 !important;
      }

      /* Position user info block in top right corner */
      html.github-pages body.mobile-device.portrait .right-block {
        position: absolute !important;
        top: 5px !important;
        right: 10px !important;
        flex-direction: column !important;
        align-items: flex-end !important;
        gap: 3px !important;
        z-index: 10 !important;
      }

      /* Reduce size of "Signed in" text and user pill */
      html.github-pages body.mobile-device.portrait .right-block > div:first-of-type {
        font-size: 8px !important;
        gap: 3px !important;
      }

      html.github-pages body.mobile-device.portrait .user-pill {
        padding: 2px 5px !important;
        font-size: 8px !important;
      }

      html.github-pages body.mobile-device.portrait .user-email {
        font-size: 8px !important;
      }

      html.github-pages body.mobile-device.portrait .profile-badge {
        font-size: 7px !important;
        padding: 1px 4px !important;
      }


      html.github-pages body.mobile-device.portrait .app-logo {
        width: 48px !important;
        height: 48px !important;
        min-width: 48px !important;
        min-height: 48px !important;
        max-width: 48px !important;
        max-height: 48px !important;
        margin: 0 !important;
        display: block !important;
      }

      /* Hide logo white square while loading */
      html.github-pages body.mobile-device.portrait .app-logo:not([src]),
      html.github-pages body.mobile-device.portrait .app-logo[src=""],
      html.github-pages body.mobile-device.portrait .app-logo[style*="display: none"] {
        visibility: hidden !important;
        opacity: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .app-name {
        font-size: 15px !important;
        line-height: 1 !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
      }

      html.github-pages body.mobile-device.portrait .catalog-name {
        font-size: 12.5px !important;
        line-height: 1 !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
      }

      html.github-pages body.mobile-device.portrait .catalog-label {
        font-size: 10px !important;
        line-height: 1 !important;
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
      }

      html.github-pages body.mobile-device.portrait .catalog-label,
      html.github-pages body.mobile-device.portrait .user-role {
        font-size: 9px !important;
      }

      html.github-pages body.mobile-device.portrait .user-email {
        font-size: 9px !important;
      }

      html.github-pages body.mobile-device.portrait .profile-badge {
        font-size: 8px !important;
        padding: 1px 5px !important;
      }

      html.github-pages body.mobile-device.portrait .btn-toolbar,
      html.github-pages body.mobile-device.portrait .btn-primary,
      html.github-pages body.mobile-device.portrait .btn-secondary {
        height: 26px !important;
        min-height: 26px !important;
        padding: 0 14px !important;
        font-size: 9.5px !important;
        line-height: 26px !important;
      }

      /* Delete button: same size as Edit button */
      html.github-pages body.mobile-device.portrait .btn-danger {
        height: 26px !important;
        min-height: 26px !important;
        padding: 0 14px !important;
        font-size: 9.5px !important;
        line-height: 26px !important;
      }

      html.github-pages body.mobile-device.portrait #logoutBtn {
        height: 18px !important;
        min-height: 18px !important;
        padding: 0 8px !important;
        font-size: 8px !important;
        line-height: 18px !important;
      }

      html.github-pages body.mobile-device.portrait #filterBtn,
      html.github-pages body.mobile-device.portrait #sortBtn,
      html.github-pages body.mobile-device.portrait #backToListBtn {
        height: 26px !important;
        min-height: 26px !important;
        padding: 0 14px !important;
        font-size: 9.5px !important;
        line-height: 26px !important;
      }

      html.github-pages body.mobile-device.portrait #sheetBtn,
      html.github-pages body.mobile-device.portrait #addBtn {
        height: 26px !important;
        min-height: 26px !important;
        padding: 0 14px !important;
        font-size: 9.5px !important;
        line-height: 26px !important;
      }

      html.github-pages body.mobile-device.portrait .search-wrapper,
      html.github-pages body.mobile-device.portrait #searchWrapper {
        height: 26px !important;
        min-height: 26px !important;
        max-height: 26px !important;
      }

      html.github-pages body.mobile-device.portrait .search-input,
      html.github-pages body.mobile-device.portrait #searchInput {
        height: 26px !important;
        min-height: 26px !important;
        max-height: 26px !important;
        font-size: 9.5px !important;
        padding: 0 13px 0 5px !important;
        width: 100% !important;
        max-width: 113px !important;
        line-height: 26px !important;
        box-sizing: border-box !important;
        border-width: 1px !important;
        vertical-align: middle !important;
      }

      html.github-pages body.mobile-device.portrait .clear-search-btn {
        width: 8px !important;
        height: 8px !important;
        font-size: 9px !important;
        right: 3px !important;
      }

      html.github-pages body.mobile-device.portrait .item-card {
        min-height: 90px;
        padding: 6px !important;
      }

      html.github-pages body.mobile-device.portrait .card-name {
        font-size: 10px !important;
      }

      html.github-pages body.mobile-device.portrait .card-sub {
        font-size: 9px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-name {
        font-size: 18.75px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-subtitle {
        font-size: 15.625px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-topcorner {
        font-size: 15.625px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-meta {
        font-size: 12.5px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-field {
        font-size: 13.75px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-field-label {
        font-size: 13.75px !important;
      }

      html.github-pages body.mobile-device.portrait .detail-field-value {
        font-size: 13.75px !important;
      }

      html.github-pages body.mobile-device.portrait .link-pill {
        font-size: 12px !important;
        padding: 5px 9px !important;
      }

      html.github-pages body.mobile-device.portrait #breadcrumbNav {
        font-size: 7.5px !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
      }

      html.github-pages body.mobile-device.portrait #breadcrumbNav a,
      html.github-pages body.mobile-device.portrait #breadcrumbNav span {
        font-size: 8px !important;
        padding: 0 2px !important;
        margin: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .filters-row {

        padding: 5px 9px !important;

        gap: 0.5px !important;
    
      }

    
      html.github-pages body.mobile-device.portrait .filters-left {
        gap: 0.2px !important;
        margin: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .filters-right {
        gap: 0.2px !important;
        margin: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .filters-row * {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
      }

      /* Bottom bar and tab switcher - 35% size */
      html.github-pages body.mobile-device.portrait .bottom-bar {
        padding: 7px 7px 11px 7px !important;
        min-height: 35px !important;
      }

      html.github-pages body.mobile-device.portrait .tab-switcher-btn {
        height: 25px !important;
        min-height: 25px !important;
        font-size: 11px !important;
        padding: 0 11px !important;
      }

      html.github-pages body.mobile-device.portrait .tab-switcher-menu {
        font-size: 11px !important;
        max-height: 175px !important;
      }

      html.github-pages body.mobile-device.portrait .tab-menu-item {
        font-size: 11px !important;
        padding: 6px 7px !important;
        min-height: 25px !important;
      }

      /* Fix body top padding for mobile devices */
      html.github-pages body.mobile-device.portrait {
        padding-top: 4px !important;
      }

      html.github-pages body.mobile-device.landscape {
        padding-top: 4px !important;
      }

      html.github-pages body.mobile-device.portrait .shell {
        padding: 0 6px 120px 6px !important; /* Increased from 46px to 120px to account for bottom bar (100px + buffer) */
      }

      html.github-pages body.mobile-device.landscape .shell {
        padding-left: 6px !important;
        padding-right: 6px !important;
      }

      html.github-pages body.mobile-device.portrait .top-header {
        margin-top: 0 !important;
      }

      html.github-pages body.mobile-device.landscape .top-header {
        margin-top: 0 !important;
        /* CRITICAL FIX: Override media query (max-width: 768px) that forces column layout */
        /* Keep header in row layout for all landscape widths, even below 768px */
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
      }

      /* Ensure left-block stays in row and doesn't center */
      html.github-pages body.mobile-device.landscape .left-block {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: flex-start !important;
      }

      /* Ensure right-block stays in row and aligns properly */
      html.github-pages body.mobile-device.landscape .right-block {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: flex-end !important;
        width: auto !important;
      }

      /* Grid gap - 50% size */
      html.github-pages body.mobile-device.portrait .grid {
        gap: 6px !important;
      }

      /* MOBILE PORTRAIT - List Type: Text 60% size, Images 60% size */
      html.github-pages body.mobile-device.portrait .list-view {
        gap: 5px !important;
      }

      html.github-pages body.mobile-device.portrait .list-view .list-item-name {
        font-size: 0.6em !important;
      }

      html.github-pages body.mobile-device.portrait .list-view .list-item-sub {
        font-size: 0.6em !important;
      }

      html.github-pages body.mobile-device.portrait .list-view .list-item-img-wrapper {
        width: 60px !important;
        height: 60px !important;
        min-width: 60px !important;
      }

      /* MOBILE PORTRAIT - Table Type: Text and Headers 60% size, Images 50% size */
      html.github-pages body.mobile-device.portrait .table-view .data-table td {
        font-size: 0.6em !important;
      }

      html.github-pages body.mobile-device.portrait .table-view .data-table th {
        font-size: 0.6em !important;
      }

      html.github-pages body.mobile-device.portrait .table-cell-img {
        width: 45px !important;
        height: 45px !important;
      }

      html.github-pages body.mobile-device.portrait .table-view .data-table td {
        padding: 4px 16px !important;
      }

      html.github-pages body.mobile-device.portrait .table-view .data-table th {
        padding: 4px 16px !important;
      }

      /* MOBILE PORTRAIT - Table dropdown menu sizing */
      html.github-pages body.mobile-device.portrait .table-menu-button-row .table-menu-button {
        font-size: 12px !important; /* 60% of base 20px */
        padding: 6px 12px !important; /* 60% of base 10px 20px */
      }

      html.github-pages body.mobile-device.portrait .table-column-menu {
        font-size: 0.9em !important; /* 90% for all dropdown content */
      }

      html.github-pages body.mobile-device.portrait .table-menu-title {
        font-size: 9.9px !important; /* 90% of base 11px */
      }

      html.github-pages body.mobile-device.portrait .table-menu-button:not(.table-menu-button-row .table-menu-button) {
        font-size: 11.7px !important; /* 90% of base 13px */
        padding: 7.2px 10.8px !important; /* 90% of base 8px 12px */
      }

      /* MOBILE PORTRAIT - Filter/Sort dropdown sizing (35% of actual size) */
      html.github-pages body.mobile-device.portrait .dropdown-menu {
        font-size: 0.35em !important; /* 35% base size */
      }

      html.github-pages body.mobile-device.portrait .dropdown-section-title {
        font-size: 8.82px !important; /* 90% of 9.8px (31.5% of 28px) */
        padding: 4.2px 5.6px !important;
      }

      html.github-pages body.mobile-device.portrait .dropdown-item {
        font-size: 11.34px !important; /* 90% of 12.6px (31.5% of 36px) */
        padding: 5.6px 7px !important;
        gap: 5.6px !important;
      }

      html.github-pages body.mobile-device.portrait .dropdown-item input[type="checkbox"],
      html.github-pages body.mobile-device.portrait .dropdown-item input[type="radio"] {
        width: 11.34px !important; /* 90% of 12.6px */
        height: 11.34px !important; /* 90% of 12.6px */
        min-width: 11.34px !important;
        min-height: 11.34px !important;
      }

      html.github-pages body.mobile-device.portrait .dropdown-item input[type="checkbox"]:checked::after {
        top: 1.89px !important; /* 90% of 2.1px */
        left: 1.89px !important; /* 90% of 2.1px */
        width: 6.3px !important; /* 90% of 7px */
        height: 6.3px !important; /* 90% of 7px */
      }

      html.github-pages body.mobile-device.portrait .dropdown-item span {
        font-size: 11.34px !important; /* 90% of 12.6px */
      }

      html.github-pages body.mobile-device.portrait .dropdown-btn {
        font-size: 10.71px !important; /* 90% of 11.9px */
        padding: 2.8px 5.6px !important;
        line-height: calc(10.71px + 2px) !important; /* Text height + 2px extra */
        min-height: calc(10.71px + 2px + 5.6px) !important; /* Line height + vertical padding */
      }

      /* MOBILE PORTRAIT - Filter/Sort dropdown: 150-200px width range */
      html.github-pages body.mobile-device.portrait .dropdown-menu {
        min-width: 150px !important;
        max-width: 200px !important;
        width: auto !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        font-size: 0.315em !important; /* 90% of 0.35em = 31.5% of original */
      }

      /* MOBILE LANDSCAPE - Filter/Sort dropdown: 160-230px width range */
      html.github-pages body.mobile-device.landscape .dropdown-menu {
        min-width: 160px !important;
        max-width: 230px !important;
        width: auto !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        font-size: 0.315em !important; /* 90% of 0.35em = 31.5% of original */
      }

      /* MOBILE (PORTRAIT & LANDSCAPE) - Dropdown items: allow text wrapping */
      html.github-pages body.mobile-device .dropdown-item {
        white-space: normal !important;
        word-wrap: break-word !important;
      }

      html.github-pages body.mobile-device .dropdown-item span {
        white-space: normal !important;
        word-wrap: break-word !important;
      }

      /* MOBILE (PORTRAIT & LANDSCAPE) - Dropdowns: align to LEFT to prevent overflow off screen */
      html.github-pages body.mobile-device .dropdown-menu {
        left: 0 !important;
        right: auto !important;
      }

      /* ALL DEVICES & ORIENTATIONS - Filter button dropdown: align LEFT edge with button LEFT edge */
      #filterWrapper .dropdown-menu,
      #filterBtn + .dropdown-menu {
        left: 0 !important;
        right: auto !important;
      }

      /* ALL DEVICES & ORIENTATIONS - Sort button dropdown: align RIGHT edge with button RIGHT edge */
      #sortWrapper .dropdown-menu,
      #sortBtn + .dropdown-menu {
        left: auto !important;
        right: 0 !important;
      }

      /* MOBILE PORTRAIT - Image close button: 60% of current size (GitHub Pages only) */
      html.github-pages body.mobile-device.portrait #imgOverlayClose {
        font-size: 19.2px !important; /* 60% of 32px */
        padding: 4.8px 8.4px !important; /* 60% of 8px 14px */
        min-width: 28.8px !important; /* 60% of 48px */
        min-height: 28.8px !important; /* 60% of 48px */
        top: 12px !important; /* 60% of 20px */
        right: 12px !important; /* 60% of 20px */
      }

      /* MOBILE PORTRAIT - Detail view gap: -14px (perfect alignment) */
      /* ONLY affects DETAIL view, NOT grid view */

      /* CRITICAL: detailView - negative margin to compensate for filters-row margin-bottom (14px) */
      /* Gap calculation: filters-row margin-bottom (14px) + detailView margin-top (-14px) = 0px (flush) */
      html.github-pages body.mobile-device.portrait #detailView#detailView {
        margin-top: -14px !important; /* Negative margin for flush alignment (14px - 14px = 0px) */
        margin-bottom: 0px !important;
        margin-left: 0px !important;
        margin-right: 0px !important;
        padding: 10px 16px 16px 16px !important; /* Internal padding: 10px top */
        padding-top: 10px !important; /* Space between container edge and items */
      }

      /* Backup rule with even higher specificity */
      html.github-pages body.mobile-device.portrait:not(.some-nonexistent-class) #detailView {
        margin-top: -14px !important; /* Negative margin for flush alignment */
        padding-top: 10px !important; /* Internal padding */
      }

      /* MOBILE PORTRAIT - Grid view gap: 5px BETWEEN containers (filters-row to gridView) */
      /* Gap calculation: filters-row margin-bottom (14px) + gridView margin-top (-9px) = 5px */
      html.github-pages body.mobile-device.portrait #gridView {
        margin-top: -9px !important; /* Negative margin to achieve 5px total gap (14px - 9px) */
      }

      /* MOBILE PORTRAIT - Add/Edit modal: Reduce text box sizes by 50% */
      html.github-pages body.mobile-device.portrait .modal-card input,
      html.github-pages body.mobile-device.portrait .modal-card textarea,
      html.github-pages body.mobile-device.portrait .modal-card select {
        padding: 3.5px 4.5px !important; /* 50% of 7px 9px */
        font-size: 6.5px !important; /* 50% of 13px */
        margin: 1.5px 0 5px !important; /* 50% of 3px 0 10px */
      }

      html.github-pages body.mobile-device.portrait .modal-card label {
        font-size: 6px !important; /* 50% of 12px */
      }

      html.github-pages body.mobile-device.portrait .modal-card h3 {
        font-size: 8px !important; /* 50% of 16px */
        margin: 0 0 5px !important; /* 50% of 0 0 10px */
      }

      /* MOBILE PORTRAIT - Edit/Add Item Modal (modal-box): Reduce all UI by 50% */
      html.github-pages body.mobile-device.portrait .modal-box {
        padding: 12px 14px !important; /* 50% of 24px 28px */
        border-radius: 8px !important; /* 50% of 16px */
        min-width: unset !important;
        width: 90% !important;
        max-width: 280px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-header,
      html.github-pages body.mobile-device.portrait #editModal .modal-header {
        margin-bottom: 5px !important;
        padding-bottom: 4px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-header h2,
      html.github-pages body.mobile-device.portrait #editModal .modal-header h2 {
        font-size: 15px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-close-x,
      html.github-pages body.mobile-device.portrait #editModal .modal-close-x {
        font-size: 16px !important;
        width: 20px !important;
        height: 20px !important;
        min-height: 20px !important;
        max-height: 20px !important;
        min-width: 20px !important;
        max-width: 20px !important;
        border-radius: 3px !important;
        padding: 0 !important;
        line-height: 1 !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body,
      html.github-pages body.mobile-device.portrait #editModal .modal-body {
        margin-bottom: 10px !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body label {
        font-size: 10px !important;
        margin-bottom: 3px !important;
        margin-top: 8px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body label:first-child {
        margin-top: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body input[type="text"],
      html.github-pages body.mobile-device.portrait .modal-body input[type="date"],
      html.github-pages body.mobile-device.portrait .modal-body select,
      html.github-pages body.mobile-device.portrait .modal-body textarea {
        padding: 5px 6px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
        min-height: unset !important;
        height: auto !important;
      }

      /* Stronger selectors for edit modal inputs */
      html.github-pages body.mobile-device.portrait #editModal input[type="text"],
      html.github-pages body.mobile-device.portrait #editModal input[type="date"],
      html.github-pages body.mobile-device.portrait #editModal select,
      html.github-pages body.mobile-device.portrait #editModal textarea {
        padding: 5px 6px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
        min-height: unset !important;
        height: auto !important;
        line-height: 1.2 !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body input[type="checkbox"] {
        width: 9px !important;
        height: 9px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-body label.checkbox-label {
        gap: 5px !important;
        margin-top: 6px !important;
        font-size: 10px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-footer {
        margin-top: 12px !important;
        padding-top: 8px !important;
        gap: 5px !important;
      }

      html.github-pages body.mobile-device.portrait .modal-footer .btn-primary,
      html.github-pages body.mobile-device.portrait .modal-footer .btn-secondary {
        height: 25px !important;
        min-height: 25px !important;
        padding: 0 10px !important;
        font-size: 10px !important;
        line-height: 25px !important;
        border-radius: 4px !important;
      }

      /* MOBILE PORTRAIT - Login Screen: Reduce buttons and inputs */
      html.github-pages body.mobile-device.portrait .login-btn,
      html.github-pages body.mobile-device.portrait #loginSendCodeBtn,
      html.github-pages body.mobile-device.portrait #loginVerifyBtn {
        padding: 14px 24px !important;
        font-size: 12px !important;
        min-height: unset !important;
        height: auto !important;
      }

      html.github-pages body.mobile-device.portrait #loginBackBtn {
        padding: 14px 16px !important;
        font-size: 12px !important;
        min-height: unset !important;
        height: auto !important;
      }

      html.github-pages body.mobile-device.portrait .login-input,
      html.github-pages body.mobile-device.portrait #loginEmailInput,
      html.github-pages body.mobile-device.portrait #loginCodeInput {
        padding: 8px 16px !important; /* 70% of 12px vertical */
        font-size: 12px !important;
        min-height: unset !important;
        height: auto !important;
      }

      /* MOBILE PORTRAIT - Breadcrumbs: 12px */
      html.github-pages body.mobile-device.portrait #breadcrumbNav {
        font-size: 12px !important;
      }

      html.github-pages body.mobile-device.portrait #breadcrumbNav a,
      html.github-pages body.mobile-device.portrait #breadcrumbNav span {
        font-size: 12px !important;
      }

      /* MOBILE PORTRAIT - Table Open Detail View: Landscape layout (image left, text right) */
      html.github-pages body.mobile-device.portrait #detailView[data-table-open-detail="true"] .detail-layout {
        display: grid !important;
        grid-template-columns: minmax(0, 280px) minmax(0, 1fr) !important;
        grid-template-rows: auto !important;
        gap: 12px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: visible !important;
      }

      html.github-pages body.mobile-device.portrait #detailView[data-table-open-detail="true"] #detailImgContainer {
        grid-column: 1 !important;
        min-width: 0 !important;
      }

      html.github-pages body.mobile-device.portrait #detailView[data-table-open-detail="true"] #detailContentContainer {
        grid-column: 2 !important;
        min-width: 0 !important;
      }

      /* Override media query for GitHub Pages mobile portrait - ensure grid layout wins */
      @media (max-width: 768px) {
        html.github-pages body.mobile-device.portrait #detailView[data-table-open-detail="true"] .detail-layout {
          display: grid !important;
          grid-template-columns: minmax(0, 280px) minmax(0, 1fr) !important;
          grid-template-rows: auto !important;
        }

        /* Also apply to inline expanded table rows (Open Detail View style) */
        html.github-pages body.mobile-device.portrait .table-view .expanded-content-row .detail-layout {
          display: grid !important;
          grid-template-columns: minmax(0, 280px) minmax(0, 1fr) !important;
          grid-template-rows: auto !important;
        }
      }

      /* Grid layout for inline table expansions - outside media query for all screen sizes */
      html.github-pages body.mobile-device.portrait .table-view .expanded-content-row .detail-layout {
        display: grid !important;
        grid-template-columns: minmax(0, 280px) minmax(0, 1fr) !important;
        grid-template-rows: auto !important;
        gap: 12px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: visible !important;
      }

      html.github-pages body.mobile-device.portrait .table-view .expanded-content-row #detailImgContainer {
        grid-column: 1 !important;
        min-width: 0 !important;
      }

      html.github-pages body.mobile-device.portrait .table-view .expanded-content-row #detailContentContainer {
        grid-column: 2 !important;
        min-width: 0 !important;
      }

      /* MOBILE PORTRAIT - Table Open Detail View: Reduce internal padding to 5px top/bottom */
      html.github-pages body.mobile-device.portrait .table-view .expanded-content-row td > div {
        padding-top: 5px !important;
        padding-bottom: 5px !important;
      }

      /* MOBILE LANDSCAPE - Table Open Detail View: Reduce internal padding to 8px top/bottom */
      html.github-pages body.mobile-device.landscape .table-view .expanded-content-row td > div {
        padding-top: 8px !important;
        padding-bottom: 8px !important;
      }

      /* MOBILE LANDSCAPE - Table Type: Images 45px */
      html.github-pages body.mobile-device.landscape .table-cell-img {
        width: 45px !important;
        height: 45px !important;
      }

      /* MOBILE LANDSCAPE - Table Type: All text 90% and row height 80% */
      html.github-pages body.mobile-device.landscape .table-view .data-table th {
        font-size: 0.9em !important;
        padding-top: 5px !important;
        padding-bottom: 5px !important;
      }

      html.github-pages body.mobile-device.landscape .table-view .data-table td {
        font-size: 0.9em !important;
        padding-top: 5px !important;
        padding-bottom: 5px !important;
      }

      html.github-pages body.mobile-device.landscape .table-view .data-table tr {
        height: 80% !important;
      }

      /* MOBILE LANDSCAPE - List Type: Images 60% size */
      html.github-pages body.mobile-device.landscape .list-view .list-item-img-wrapper {
        width: 60px !important;
        height: 60px !important;
        min-width: 60px !important;
      }

    </style>

    <!-- PWA Configuration Note -->
    <script>
      // ============================================
      // IMPORTANT: Service Worker Limitation
      // ============================================
      // Google Apps Script cannot serve service workers with the correct MIME type
      // (it serves everything as text/html instead of application/javascript).
      // This means:
      //   - No true PWA "Install" prompt in Chrome/Edge
      //   - No offline functionality
      //   - Users can still use "Add to Home screen" for bookmark-style shortcuts
      //   - The manifest is still served for basic home screen icon support
      //
      // To get full PWA support, the app would need to be hosted on a platform
      // that can serve static files (GitHub Pages, Netlify, Vercel, etc.)
      // ============================================

      console.log('‚ÑπÔ∏è PWA Note: Service worker not available on Google Apps Script');
      console.log('‚ÑπÔ∏è Use "Add to Home screen" from browser menu for a shortcut');
    </script>
  </head>

  <body>
    <!-- PWA Install Banner (GitHub Pages only) -->
    <div id="pwaInstallBanner" class="pwa-install-banner" style="display: none;">
      <div class="pwa-install-content">
        <div class="pwa-install-icon">üì±</div>
        <div class="pwa-install-text">
          <strong>Install App</strong>
          <span>Add to your home screen for quick access</span>
        </div>
        <div class="pwa-install-buttons">
          <button id="pwaInstallBtn" class="pwa-install-btn">Install</button>
          <button id="pwaInstallDismiss" class="pwa-dismiss-btn">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Loading Screen Overlay -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loading-content">
        <div id="loadingText" class="loading-text">Patience discipline young Padawan !</div>
        <div class="loading-spinner-container">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <div class="shell">
      <!-- Top header -->
      <div class="top-header">
        <div class="left-block">
          <img id="appLogo" class="app-logo" src="" alt="" style="display: none;">
          <div class="app-text-block">
            <div id="appName" class="app-name">App name</div>

            <div class="catalog-row">
              <span class="catalog-label"></span>
              <span id="catalogName" class="catalog-name">Catalogue</span>
            </div>
          </div>
        </div>

        <!-- Center block for tab switcher -->
        <div class="center-block">
          <div id="tabSwitcherWrapper" class="tab-switcher-wrapper" style="display: none;">
            <button id="tabSwitcherBtn" class="tab-switcher-btn">
              <span id="currentTabName">Tab 1</span>
              <span>‚ñæ</span>
            </button>
            <div id="tabSwitcherMenu" class="tab-switcher-menu">
              <!-- Tab items will be dynamically populated here -->
            </div>
          </div>
        </div>

        <div id="userInfoBlock" class="right-block">
          <div>
            <span>Signed in:</span>
            <div class="user-pill">
              <span id="userEmail" class="user-email">email</span>
              <span id="userProfilePill" class="profile-badge">ROLE</span>
            </div>
          </div>
          <button id="logoutBtn" class="btn-toolbar" style="padding: 0 12px; height: 28px; font-size: 12px;">
            Logout
          </button>
        </div>
      </div>

      <!-- Filters row -->
      <div class="filters-row">
        <div class="filters-left">
          <!-- Back to list button (hidden by default, shown in detail view when no layers) -->
          <button id="backToListBtn" class="btn-toolbar" onclick="backToList()" style="display: none;">
            ‚Üê Back to list
          </button>

          <!-- Search input -->
          <div id="searchWrapper" class="search-wrapper">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="üîç Search..."
              autocomplete="off"
            >
            <button id="clearSearchBtn" class="clear-search-btn" style="display: none;" onclick="clearSearch()">‚úï</button>
          </div>

          <!-- Breadcrumb navigation (for layers) -->
          <div id="breadcrumbNav" style="display: none; margin-left: 8px; font-size: 13px; color: #64748b; align-items: center;">
            <!-- Breadcrumb items will be dynamically populated here -->
          </div>
        </div>

        <div class="filters-right">
          <button id="sheetLinkBtn" class="btn-toolbar" style="display: none;">üìä Sheet</button>

          <!-- Filter button with dropdown -->
          <div id="filterWrapper" class="dropdown-wrapper">
            <button id="filterBtn" class="btn-toolbar">
              üè∑Ô∏è Filter
              <span id="filterBadge" class="btn-badge" style="display: none;">0</span>
              <span>‚ñæ</span>
            </button>
            <div id="filterDropdown" class="dropdown-menu">
              <!-- Dynamic filter sections will be populated here -->
            </div>
          </div>

          <!-- Sort button with dropdown -->
          <div id="sortWrapper" class="dropdown-wrapper">
            <button id="sortBtn" class="btn-toolbar">
              ‚ÜïÔ∏è Sort
              <span id="sortLabel">None</span>
              <span>‚ñæ</span>
            </button>
            <div id="sortDropdown" class="dropdown-menu">
              <div class="dropdown-section">
                <div class="dropdown-section-title">Sort by</div>
                <div class="dropdown-item" data-sort="none">
                  <input type="radio" name="sortField" value="none" checked>
                  <span>No sorting</span>
                </div>
                <div class="dropdown-item" data-sort="Name">
                  <input type="radio" name="sortField" value="Name">
                  <span>Name</span>
                </div>
                <div class="dropdown-item" data-sort="Category">
                  <input type="radio" name="sortField" value="Category">
                  <span>Category</span>
                </div>
                <div class="dropdown-item" data-sort="Place">
                  <input type="radio" name="sortField" value="Place">
                  <span>Place</span>
                </div>
                <div class="dropdown-item" data-sort="Date">
                  <input type="radio" name="sortField" value="Date">
                  <span>Date</span>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-section">
                <div class="dropdown-section-title">Order</div>
                <div class="dropdown-item" data-order="asc">
                  <input type="radio" name="sortOrder" value="asc" checked>
                  <span>Ascending ‚Üë</span>
                </div>
                <div class="dropdown-item" data-order="desc">
                  <input type="radio" name="sortOrder" value="desc">
                  <span>Descending ‚Üì</span>
                </div>
              </div>
            </div>
          </div>

          <button id="addBtn" class="btn-toolbar btn-primary" style="display: none;">+ Add item</button>
        </div>
      </div>

      <!-- Cards grid & details -->
      <div id="gridView" class="grid"></div>
      <div id="detailView"></div>

      <!-- Bottom bar for portrait mode (tab switcher will move here) -->
      <div id="bottomBar" class="bottom-bar">
        <div id="bottomBarContent" class="bottom-bar-content">
          <!-- Tab switcher will be moved here in portrait mode via CSS -->
        </div>
      </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
      <div class="login-card">
        <div class="login-header">
          <div class="login-title" id="loginAppName">Catalogue</div>
          <div class="login-subtitle">Sign in to access the catalogue</div>
        </div>

        <!-- Step 1: Enter Email -->
        <div id="loginStepEmail" class="login-step active">
          <div id="loginMessage1" class="login-message" style="display: none;"></div>
          <div class="login-form">
            <div class="login-input-group">
              <label class="login-label" for="loginEmailInput">Email Address</label>
              <input
                type="email"
                id="loginEmailInput"
                class="login-input"
                placeholder="your@email.com"
                autocomplete="email"
              >
            </div>
            <button id="loginSendCodeBtn" class="login-btn login-btn-primary">
              Send Verification Code
            </button>
          </div>
        </div>

        <!-- Step 2: Enter Code -->
        <div id="loginStepCode" class="login-step">
          <div id="loginMessage2" class="login-message" style="display: none;"></div>
          <div class="login-form">
            <div class="login-input-group">
              <label class="login-label" for="loginCodeInput">Verification Code</label>
              <input
                type="text"
                id="loginCodeInput"
                class="login-input"
                placeholder="Enter 6-digit code"
                maxlength="6"
                pattern="[0-9]*"
                inputmode="numeric"
              >
              <div style="font-size: 12px; color: var(--text-soft); margin-top: 4px;">
                Check your email for the verification code
              </div>
            </div>
            <button id="loginVerifyBtn" class="login-btn login-btn-primary">
              Verify & Sign In
            </button>
          </div>
          <div class="login-back-btn">
            <button id="loginBackBtn">‚Üê Back to email</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editModal" class="modal">
      <div class="modal-box" style="min-width: 520px;">
        <div class="modal-header">
          <h2 id="editModalTitle">Edit item</h2>
          <button class="modal-close-x" onclick="closeEditModal()">‚úï</button>
        </div>
        <div id="editModalBody" class="modal-body">
          <!-- Fields dynamically populated -->
        </div>
        <div class="modal-footer">
          <button id="editCancelBtn" class="btn-secondary">Cancel</button>
          <button id="editSaveBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmOverlay" class="prompt-overlay">
      <div class="prompt-box">
        <h3 id="confirmTitle" class="prompt-title">Confirm</h3>
        <p id="confirmMessage" class="prompt-message">Are you sure?</p>
        <div class="prompt-actions">
          <button id="confirmCancel" class="prompt-btn cancel">Cancel</button>
          <button id="confirmOk" class="prompt-btn confirm">OK</button>
        </div>
      </div>
    </div>

    <!-- Prompt Dialog -->
    <div id="promptOverlay" class="prompt-overlay">
      <div class="prompt-box">
        <h3 id="promptTitle" class="prompt-title">Input</h3>
        <p id="promptMessage" class="prompt-message">Enter value:</p>
        <input type="text" id="promptInput" class="prompt-input">
        <div class="prompt-actions">
          <button id="promptCancel" class="prompt-btn cancel">Cancel</button>
          <button id="promptOk" class="prompt-btn confirm">OK</button>
        </div>
      </div>
    </div>


    <!-- Toast notification container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Fullscreen image viewer -->
    <div id="imgOverlay">
      <div id="imgOverlayInner">
        <div id="imgOverlayTransform">
          <img id="imgOverlayImg" alt="Full size">
        </div>
        <button id="imgOverlayClose">‚úï</button>
      </div>
    </div>

    <script>
      // ==================== TOAST NOTIFICATION SYSTEM ====================
      
      function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        
        let icon = '‚ÑπÔ∏è';
        if (type === 'success') icon = '‚úì';
        if (type === 'error') icon = '‚úï';
        if (type === 'warning') icon = '‚ö†';
        
        toast.innerHTML = `
          <div class="toast-icon">${icon}</div>
          <div class="toast-content">${message}</div>
          <button class="toast-close">√ó</button>
        `;
        
        container.appendChild(toast);
        
        // Close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.onclick = () => removeToast(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            removeToast(toast);
          }
        }, 4000);
      }
      
      function removeToast(toast) {
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
          }
        }, 300);
      }

      // ==================== LOADING SCREEN ====================

      function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
          loadingScreen.style.opacity = '0';
          loadingScreen.style.transition = 'opacity 0.3s ease-out';
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 300);
        }
      }

      // ==================== AUTHENTICATION & SESSION MANAGEMENT ====================

      // Session storage keys
      const SESSION_TOKEN_KEY = 'catalogueSessionToken';
      const SESSION_USER_KEY = 'catalogueSessionUser';
      const SESSION_EMAIL_KEY = 'catalogueLoginEmail';

      // Get session token from localStorage
      function getSessionToken() {
        return localStorage.getItem(SESSION_TOKEN_KEY);
      }

      // Get current tab's main sheet name
      function getCurrentMainSheetName() {
        if (tabsConfig.length > 0 && currentTabIndex >= 0 && currentTabIndex < tabsConfig.length) {
          return tabsConfig[currentTabIndex].mainSheetName || 'Main';
        }
        return 'Main';
      }

      // Get current tab's column config sheet name
      function getCurrentColumnConfigSheetName() {
        if (tabsConfig.length > 0 && currentTabIndex >= 0 && currentTabIndex < tabsConfig.length) {
          return tabsConfig[currentTabIndex].columnConfigSheetName || 'ColumnConfig';
        }
        return 'ColumnConfig';
      }

      // Save session token and user to localStorage
      function saveSession(token, user) {
        localStorage.setItem(SESSION_TOKEN_KEY, token);
        localStorage.setItem(SESSION_USER_KEY, JSON.stringify(user));
      }

      // Get user from localStorage
      function getStoredUser() {
        const userStr = localStorage.getItem(SESSION_USER_KEY);
        return userStr ? JSON.parse(userStr) : null;
      }

      // Clear session
      function clearSession() {
        localStorage.removeItem(SESSION_TOKEN_KEY);
        localStorage.removeItem(SESSION_USER_KEY);
        localStorage.removeItem(SESSION_EMAIL_KEY);
      }

      // Show login screen
      function showLoginScreen() {
        document.getElementById('loginScreen').classList.add('show');
        document.querySelector('.shell').style.display = 'none';
      }

      // Hide login screen
      function hideLoginScreen() {
        document.getElementById('loginScreen').classList.remove('show');
        document.querySelector('.shell').style.display = 'block';
      }

      // Show login message
      function showLoginMessage(step, message, type) {
        const messageEl = document.getElementById('loginMessage' + step);
        messageEl.textContent = message;
        messageEl.className = 'login-message ' + type;
        messageEl.style.display = 'block';
      }

      // Hide login message
      function hideLoginMessage(step) {
        const messageEl = document.getElementById('loginMessage' + step);
        messageEl.style.display = 'none';
      }

      // Switch login steps
      function switchLoginStep(toStep) {
        document.getElementById('loginStepEmail').classList.remove('active');
        document.getElementById('loginStepCode').classList.remove('active');
        document.getElementById('loginStep' + toStep).classList.add('active');
      }

      // Request OTP code
      function requestOTP() {
        const email = document.getElementById('loginEmailInput').value.trim();

        if (!email) {
          showLoginMessage(1, 'Please enter your email address.', 'error');
          return;
        }

        const btn = document.getElementById('loginSendCodeBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="login-loading"></span>Sending code...';
        hideLoginMessage(1);

        // Store email for code verification step
        localStorage.setItem(SESSION_EMAIL_KEY, email);

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = 'Send Verification Code';

            if (result.success) {
              showLoginMessage(1, result.message, 'success');
              setTimeout(() => {
                switchLoginStep('Code');
                hideLoginMessage(1);
              }, 1500);
            } else {
              showLoginMessage(1, result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = 'Send Verification Code';
            showLoginMessage(1, 'Error: ' + error.message, 'error');
          })
          .requestOTP(email);
      }

      // Verify OTP code
      function verifyOTP() {
        const email = localStorage.getItem(SESSION_EMAIL_KEY);
        const code = document.getElementById('loginCodeInput').value.trim();

        if (!code) {
          showLoginMessage(2, 'Please enter the verification code.', 'error');
          return;
        }

        if (!email) {
          showLoginMessage(2, 'Session expired. Please start over.', 'error');
          setTimeout(() => {
            switchLoginStep('Email');
            hideLoginMessage(2);
          }, 2000);
          return;
        }

        const btn = document.getElementById('loginVerifyBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="login-loading"></span>Verifying...';
        hideLoginMessage(2);

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Sign In';

            if (result.success) {
              // Save session
              saveSession(result.token, result.user);

              showLoginMessage(2, result.message, 'success');

              // Load the app with authentication (without full page reload)
              setTimeout(() => {
                hideLoginScreen();
                init(); // Reinitialize the app
              }, 800);
            } else {
              showLoginMessage(2, result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Sign In';
            showLoginMessage(2, 'Error: ' + error.message, 'error');
          })
          .verifyOTP(email, code);
      }

      // Logout function
      function logout() {
        const token = getSessionToken();

        if (token) {
          google.script.run
            .withSuccessHandler(function(result) {
              clearSession();
              location.reload();
            })
            .withFailureHandler(function(error) {
              clearSession();
              location.reload();
            })
            .logout(token);
        } else {
          clearSession();
          location.reload();
        }
      }

      // Back to email step
      function backToEmailStep() {
        switchLoginStep('Email');
        hideLoginMessage(2);
        document.getElementById('loginCodeInput').value = '';
      }

      // ==================== CUSTOM CONFIRM DIALOG ====================

      function showConfirm(title, message, onConfirm) {
        const overlay = document.getElementById('confirmOverlay');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const cancelBtn = document.getElementById('confirmCancel');
        const okBtn = document.getElementById('confirmOk');

        titleEl.textContent = title;
        messageEl.textContent = message;
        overlay.classList.add('show');

        // Remove old listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Add new listeners
        newCancelBtn.onclick = () => {
          overlay.classList.remove('show');
        };

        newOkBtn.onclick = () => {
          overlay.classList.remove('show');
          if (onConfirm) onConfirm();
        };

        // Close on overlay click
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
          }
        };
      }

      // ==================== CUSTOM PROMPT DIALOG ====================

      function showPrompt(title, message, defaultValue, onConfirm) {
        const overlay = document.getElementById('promptOverlay');
        const titleEl = document.getElementById('promptTitle');
        const messageEl = document.getElementById('promptMessage');
        const inputEl = document.getElementById('promptInput');
        const cancelBtn = document.getElementById('promptCancel');
        const okBtn = document.getElementById('promptOk');

        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = defaultValue || '';
        overlay.classList.add('show');

        // Focus input
        setTimeout(() => inputEl.focus(), 100);

        // Remove old listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        const handleConfirm = () => {
          const value = inputEl.value.trim();
          if (value) {
            overlay.classList.remove('show');
            if (onConfirm) onConfirm(value);
          }
        };

        // Add new listeners
        newCancelBtn.onclick = () => {
          overlay.classList.remove('show');
        };

        newOkBtn.onclick = handleConfirm;

        // Submit on Enter key
        inputEl.onkeypress = (e) => {
          if (e.key === 'Enter') {
            handleConfirm();
          }
        };

        // Close on overlay click
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
          }
        };
      }

      // ==================== INDEXEDDB CACHE MANAGER ====================
      class ImageCacheDB {
        constructor() {
          this.dbName = 'CatalogueImageCache';
          this.storeName = 'images';
          this.version = 1;
          this.db = null;
        }

        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              resolve();
            };
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(this.storeName)) {
                db.createObjectStore(this.storeName, { keyPath: 'fileId' });
              }
            };
          });
        }

        async get(fileId) {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(fileId);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        }

        async set(fileId, fullDataUrl, thumbnailDataUrl) {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const data = {
              fileId: fileId,
              full: fullDataUrl,
              thumbnail: thumbnailDataUrl,
              timestamp: Date.now()
            };
            const request = store.put(data);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }

        async clear() {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.clear();
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }
      }

      // Initialize IndexedDB cache
      const imageCacheDB = new ImageCacheDB();
      
      // Memory cache for current session (faster than IndexedDB lookup)
      const memoryCache = new Map();

      // ==================== LAZY LOADING WITH INTERSECTION OBSERVER ====================
      let imageObserver = null;

      function setupLazyLoading() {
        if ('IntersectionObserver' in window) {
          imageObserver = new IntersectionObserver((entries) => {

            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const wrapper = entry.target;
                const fileId = wrapper.dataset.fileId;
                const rawUrl = wrapper.dataset.rawUrl;

                if (fileId) {
                  loadImageViaProxy(fileId, wrapper);
                } else if (rawUrl) {
                  loadDirectImage(rawUrl, wrapper);
                }

                imageObserver.unobserve(wrapper);
              }
            });
          }, {
            rootMargin: '50px' // Start loading 50px before image enters viewport
          });
        }
      }


      // -------------------- State --------------------
      let allItems = [];
      let headers = [];
      let user = null;
      let settings = null;
      let columnConfig = [];

      // Helper to normalize view type from Google Sheet format to lowercase
      function normalizeViewType(viewValue) {
        if (!viewValue) return 'cards';
        const normalized = String(viewValue).toLowerCase();
        if (normalized === 'cards' || normalized === 'list' || normalized === 'table') {
          return normalized;
        }
        return 'cards'; // Default fallback for invalid values
      }

      // Helper to normalize and validate style based on view type
      function normalizeStyle(viewType, styleValue) {
        if (!styleValue) {
          // Return default style for view type
          if (viewType === 'cards') return 'Squared';
          if (viewType === 'list') return 'Simple';
          if (viewType === 'table') return 'Normal';
          return 'Squared';
        }

        // Define valid styles for each view type
        const validStyles = {
          'cards': ['Squared', 'Rectangle', 'Circle'],
          'list': ['Simple', 'Double', 'Triple'],
          'table': ['Normal', 'Open Detail View', 'No Detail View']
        };

        const allowed = validStyles[viewType] || [];
        const styleStr = String(styleValue);

        // Check if style is valid for this view type
        if (allowed.includes(styleStr)) {
          return styleStr;
        }

        // Style not valid for this view type - return default
        if (viewType === 'cards') return 'Squared';
        if (viewType === 'list') return 'Simple';
        if (viewType === 'table') return 'Normal';
        return 'Squared';
      }

      // Initialize display view types and styles from settings
      function initializeDisplayViewType() {
        if (settings) {
          // Initialize view types
          layer1ViewType = normalizeViewType(settings.layer1View);
          layer2ViewType = normalizeViewType(settings.layer2View);
          layer3ViewType = normalizeViewType(settings.layer3View);
          mainViewType = normalizeViewType(settings.mainView);

          // Initialize styles (validated against view types)
          layer1Style = normalizeStyle(layer1ViewType, settings.layer1Style);
          layer2Style = normalizeStyle(layer2ViewType, settings.layer2Style);
          layer3Style = normalizeStyle(layer3ViewType, settings.layer3Style);
          mainStyle = normalizeStyle(mainViewType, settings.mainStyle);

          console.log('‚úì View types loaded from Google Sheet:');
          console.log('  Layer 1 (D2):', settings.layer1View, '‚Üí', layer1ViewType, '| Style (F2):', settings.layer1Style, '‚Üí', layer1Style);
          console.log('  Layer 2 (D3):', settings.layer2View, '‚Üí', layer2ViewType, '| Style (F3):', settings.layer2Style, '‚Üí', layer2Style);
          console.log('  Layer 3 (D4):', settings.layer3View, '‚Üí', layer3ViewType, '| Style (F4):', settings.layer3Style, '‚Üí', layer3Style);
          console.log('  Main (D5):', settings.mainView, '‚Üí', mainViewType, '| Style (F5):', settings.mainStyle, '‚Üí', mainStyle);
        } else {
          console.log('‚ö†Ô∏è No settings found - using defaults (cards/Squared)');
        }
      }

      // Get the appropriate view type based on current layer index
      function getViewTypeForLayer(layerIndex) {
        if (layerIndex === 0) return layer1ViewType;
        if (layerIndex === 1) return layer2ViewType;
        if (layerIndex === 2) return layer3ViewType;
        return 'cards'; // Default for any additional layers
      }

      // Get the view type for main items
      function getMainViewType() {
        return mainViewType;
      }

      // Get the appropriate style based on current layer index
      function getStyleForLayer(layerIndex) {
        if (layerIndex === 0) return layer1Style;
        if (layerIndex === 1) return layer2Style;
        if (layerIndex === 2) return layer3Style;
        return 'Squared'; // Default for any additional layers
      }

      // Get the style for main items
      function getMainStyle() {
        return mainStyle;
      }

      // Dynamic column references (populated from columnConfig)
      let nameColumn = null;
      let descriptionColumn = null;
      let imageColumn = null;
      let categoryColumn = null;
      let placeColumn = null;
      let dateColumn = null;
      let externalLinkColumn = null;
      let addedByColumn = null;

      // Filter columns (columns with showInFilter = true)
      let filterColumns = [];
      let filterValues = {}; // { columnName: [selectedValue1, selectedValue2, ...] }
      let activeFilters = {}; // Active filters applied to the current view

      let sortField = "none";
      let sortOrder = "asc";

      let searchQuery = ""; // Search query for Primary Identifier

      // Navigation state for back button handling
      let currentView = "list"; // "list", "layer", or "detail"

      // Display view types for each layer and main items (cards, list, table)
      let layer1ViewType = "cards"; // Layer 1 view type - set from Google Sheet D12
      let layer2ViewType = "cards"; // Layer 2 view type - set from Google Sheet D13
      let layer3ViewType = "cards"; // Layer 3 view type - set from Google Sheet D14
      let mainViewType = "cards";   // Main items view type - set from Google Sheet D15

      // Display styles for each view type - set from Google Sheet F2-F5
      let layer1Style = "Squared";  // Layer 1 style - set from Google Sheet F2
      let layer2Style = "Squared";  // Layer 2 style - set from Google Sheet F3
      let layer3Style = "Squared";  // Layer 3 style - set from Google Sheet F4
      let mainStyle = "Squared";    // Main items style - set from Google Sheet F5

      // Table view state - for column-level filtering and sorting
      let tableColumnFilters = {}; // { columnName: [selectedValues...] }
      let tableSortColumn = null;   // Current sort column name
      let tableSortOrder = "asc";   // "asc" or "desc"
      let currentTableItems = [];   // Store original items for table filtering
      let activeTableMenuColumn = null; // Track which column menu is open
      let expandedRows = new Set(); // Track which rows are expanded (stores item index or identifier)

      // Layer navigation state
      let layerConfig = []; // Layer configuration from backend
      let layersData = {}; // All layer data by layer name
      let navigationStack = []; // Stack of navigation history: [{type: "layer", layerName: "Layer 1", item: {...}}, ...]
      let currentLayerIndex = -1; // Index in layerConfig (-1 = home, 0 = Layer 1, 1 = Layer 2, etc.)

      // Tab management state
      let tabsConfig = []; // Tab configuration from backend: [{tabName, layersSheetName, mainSheetName, columnConfigSheetName}, ...]
      let currentTabIndex = 0; // Index of currently active tab
      let tabStates = {}; // Store navigation state per tab: {tabIndex: {navigationStack, currentLayerIndex, currentView, currentDetailIndex, etc.}}

      // Tab data caching for performance
      let tabDataCache = {}; // Cache full tab data: {tabIndex: {layerConfig, layersData, items, columnConfig, headers}}
      let tabUniqueValuesCache = {}; // Cache computeUniqueValues results: {tabIndex: uniqueValuesMap}

      // Save state before searching to restore when search is cleared
      let preSearchNavigationStack = [];
      let preSearchLayerIndex = -1;
      let preSearchView = "list";
      let preSearchDetailItem = null;
      let preSearchDetailIndex = -1;

      let editingItemName = null;
      let imageProxyBaseUrl = "";

      // Detail view navigation tracking
      let currentDisplayedItems = [];
      let currentDetailIndex = -1;

      // -------------------- Helpers --------------------

      // Update filter and sort button visibility based on available columns
      function updateFilterSortVisibility() {
        const hasFilterColumns = filterColumns && filterColumns.length > 0;

        // Check if current view is table (main items or layers)
        const isMainTableView = currentView === "list" && getMainViewType() === 'table';
        const isLayerTableView = currentView === "layer" && currentLayerIndex >= 0 && getViewTypeForLayer(currentLayerIndex) === 'table';
        const isTableView = isMainTableView || isLayerTableView;

        // Hide filter/sort buttons if in table view (table has its own filters/sorting)
        // Otherwise show/hide based on whether there are filterable columns
        if (isTableView) {
          document.getElementById("filterWrapper").style.display = "none";
          document.getElementById("sortWrapper").style.display = "none";
        } else if (hasFilterColumns) {
          document.getElementById("filterWrapper").style.display = "inline-block";
          document.getElementById("sortWrapper").style.display = "inline-block";
        } else {
          document.getElementById("filterWrapper").style.display = "none";
          document.getElementById("sortWrapper").style.display = "none";
        }
      }

      function formatDate(dateValue) {
        if (!dateValue) return "";
        try {
          // If it's a string in YYYY-MM-DD format, parse it manually to avoid timezone issues
          if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
            const parts = dateValue.split('-');
            const year = parts[0];
            const month = parts[1];
            const day = parts[2].substring(0, 2); // Handle if there's time component
            return `${day}/${month}/${year}`;
          }

          const date = new Date(dateValue);
          if (isNaN(date.getTime())) return String(dateValue);

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${day}/${month}/${year}`;
        } catch (e) {
          return String(dateValue);
        }
      }

      function formatDateForInput(dateValue) {
        if (!dateValue) return "";
        try {
          // If already in YYYY-MM-DD format, return as-is
          if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateValue;
          }

          const date = new Date(dateValue);
          if (isNaN(date.getTime())) return String(dateValue);

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        } catch (e) {
          return String(dateValue);
        }
      }

      function loadColumnConfig() {
        // Reset column references
        nameColumn = null;
        descriptionColumn = null;
        imageColumn = null;
        categoryColumn = null;
        placeColumn = null;
        dateColumn = null;
        externalLinkColumn = null;
        addedByColumn = null;
        filterColumns = [];

        // Build column references from config
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          const place = config.itemPlace;
          const role = config.specialRole;

          if (place === "name") {
            nameColumn = config;
          } else if (place === "image") {
            imageColumn = config;
          } else if (place === "category") {
            categoryColumn = config;
          } else if (place === "place") {
            placeColumn = config;
          }

          // Check special roles
          if (role === "addedby") {
            addedByColumn = config;
          }

          // Find date column by type
          if (config.type === "date" && !dateColumn) {
            dateColumn = config;
          }

          // Build filter columns list
          if (config.showInFilter) {
            filterColumns.push(config);
            if (!filterValues[config.columnName]) {
              filterValues[config.columnName] = [];
            }
          }
        }

        // Set defaults if not found
        if (!nameColumn && headers.length > 0) {
          nameColumn = { columnName: headers[0], displayName: headers[0], specialRole: "name" };
        }

        // Update filter/sort button visibility based on configured columns
        updateFilterSortVisibility();
      }

      function computeUniqueValues(items) {
        // Compute unique values for all filter columns
        // Use provided items or default to allItems
        const sourceItems = items || allItems;

        // Check if we have cached unique values for current tab
        if (tabUniqueValuesCache[currentTabIndex]) {
          // Restore from cache
          const cachedValues = tabUniqueValuesCache[currentTabIndex];
          for (let i = 0; i < filterColumns.length; i++) {
            const config = filterColumns[i];
            if (cachedValues[config.columnName]) {
              config.uniqueValues = cachedValues[config.columnName];
            }
          }
          return;
        }

        // Compute unique values (not in cache)
        const uniqueValuesMap = {};
        for (let i = 0; i < filterColumns.length; i++) {
          const config = filterColumns[i];
          const valueSet = new Set();

          for (let j = 0; j < sourceItems.length; j++) {
            const item = sourceItems[j];
            const value = item[config.columnName];
            if (value != null && String(value).trim() !== "") {
              valueSet.add(String(value).trim());
            }
          }

          config.uniqueValues = Array.from(valueSet).sort();
          uniqueValuesMap[config.columnName] = config.uniqueValues;
        }

        // Cache the computed values for this tab
        tabUniqueValuesCache[currentTabIndex] = uniqueValuesMap;
      }

      // Check if a column has any non-empty values
      function isColumnUsed(columnName) {
        if (!columnName) return false;
        for (let i = 0; i < allItems.length; i++) {
          const val = allItems[i][columnName];
          if (val != null && String(val).trim() !== "") {
            return true;
          }
        }
        return false;
      }

      // --- DRIVE IMAGE HELPERS WITH PROGRESSIVE LOADING + INDEXEDDB + LAZY LOADING ---

      function extractDriveFileId(url) {
        if (!url) return null;
        url = String(url).trim();

        let m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return m[1];

        m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return m[1];

        if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;

        return null;
      }

      // Generate tiny thumbnail from full image (for progressive loading)
      function generateThumbnail(fullDataUrl) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Create 10x10 thumbnail (super tiny for fast loading)
            canvas.width = 10;
            canvas.height = 10;
            
            ctx.drawImage(img, 0, 0, 10, 10);
            resolve(canvas.toDataURL('image/jpeg', 0.5));
          };
          img.onerror = () => resolve(null);
          img.src = fullDataUrl;
        });
      }

      // OPTIMIZED: Check memory ‚Üí IndexedDB ‚Üí Network
      async function loadImageViaProxy(fileId, wrapper) {
        if (!fileId || !wrapper) return;

        try {
          // 1. Check memory cache (instant)
          if (memoryCache.has(fileId)) {
            const cached = memoryCache.get(fileId);
            applyProgressiveImage(wrapper, cached.thumbnail, cached.full);
            return;
          }

          // 2. Check IndexedDB (fast, persists across sessions)
          const dbCached = await imageCacheDB.get(fileId);
          if (dbCached && dbCached.full) {
            memoryCache.set(fileId, {
              full: dbCached.full,
              thumbnail: dbCached.thumbnail
            });
            applyProgressiveImage(wrapper, dbCached.thumbnail, dbCached.full);
            return;
          }

          // 3. Fetch from network (slow, only if not cached)
          // For GitHub Pages deployment, use API_CONFIG.APPS_SCRIPT_URL
          // For Apps Script deployment, use imageProxyBaseUrl from settings
          const base = (window.API_CONFIG && window.API_CONFIG.APPS_SCRIPT_URL &&
                       window.API_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE')
                       ? window.API_CONFIG.APPS_SCRIPT_URL.replace(/\/exec$/, '/exec')
                       : (imageProxyBaseUrl || "");
          const url = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

          console.log('Loading image from:', url);

          const response = await fetch(url);
          const json = await response.json();

          if (!json.ok) {
            console.error('Image fetch failed:', json.error || 'Unknown error', 'FileID:', fileId);
            wrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            return;
          }

          const fullDataUrl = "data:" + json.mime + ";base64," + json.data;
          
          // Generate thumbnail for progressive loading
          const thumbnailDataUrl = await generateThumbnail(fullDataUrl);

          // Store in both caches
          memoryCache.set(fileId, {
            full: fullDataUrl,
            thumbnail: thumbnailDataUrl
          });
          
          await imageCacheDB.set(fileId, fullDataUrl, thumbnailDataUrl);

          applyProgressiveImage(wrapper, thumbnailDataUrl, fullDataUrl);

        } catch (err) {
          console.error("Image load error:", err);
          wrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
        }
      }

      // Apply progressive loading effect (blur thumbnail ‚Üí sharp full image)
      function applyProgressiveImage(wrapper, thumbnailUrl, fullUrl) {
        wrapper.innerHTML = '';

        // Show blurred thumbnail first (if available)
        if (thumbnailUrl) {
          const placeholder = document.createElement('img');
          placeholder.className = 'card-img placeholder';
          placeholder.src = thumbnailUrl;
          wrapper.appendChild(placeholder);
        }

        // Load full image
        const fullImg = document.createElement('img');
        fullImg.className = 'card-img full';
        fullImg.onload = () => {
          fullImg.classList.add('loaded');
        };
        fullImg.src = fullUrl;
        wrapper.appendChild(fullImg);
      }

      // Load regular HTTPS images (non-Drive)
      function loadDirectImage(url, wrapper) {
        wrapper.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'card-img full loaded';
        img.src = url;
        img.loading = 'lazy';
        wrapper.appendChild(img);
      }

      // Apply background image (supports both regular URLs and Drive URLs)
      async function applyBackgroundImage(url) {
        if (!url) return;

        const fileId = extractDriveFileId(url);

        if (fileId) {
          // It's a Drive URL - fetch via proxy
          try {
            // For GitHub Pages deployment, use API_CONFIG.APPS_SCRIPT_URL
            // For Apps Script deployment, use imageProxyBaseUrl from settings
            const base = (window.API_CONFIG && window.API_CONFIG.APPS_SCRIPT_URL &&
                         window.API_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE')
                         ? window.API_CONFIG.APPS_SCRIPT_URL.replace(/\/exec$/, '/exec')
                         : (imageProxyBaseUrl || "");
            const proxyUrl = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

            const response = await fetch(proxyUrl);
            const json = await response.json();

            if (json.ok) {
              const dataUrl = "data:" + json.mime + ";base64," + json.data;
              document.body.style.backgroundImage = 'url("' + dataUrl + '")';
              document.body.style.backgroundSize = 'cover';
              document.body.style.backgroundPosition = 'center';
              document.body.style.backgroundAttachment = 'fixed';
            }
          } catch (err) {
            console.error("Error loading background image from Drive:", err);
          }
        } else {
          // Regular URL - apply directly
          document.body.style.backgroundImage = 'url("' + url + '")';
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundAttachment = 'fixed';
        }
      }

      async function applyLogoImage(url) {
        const logoEl = document.getElementById("appLogo");
        if (!logoEl) return;

        if (!url || url.trim() === "") {
          logoEl.style.display = "none";
          logoEl.src = "";
          return;
        }

        const fileId = extractDriveFileId(url);

        if (fileId) {
          // It's a Drive URL - fetch via proxy
          try {
            // For GitHub Pages deployment, use API_CONFIG.APPS_SCRIPT_URL
            // For Apps Script deployment, use imageProxyBaseUrl from settings
            const base = (window.API_CONFIG && window.API_CONFIG.APPS_SCRIPT_URL &&
                         window.API_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE')
                         ? window.API_CONFIG.APPS_SCRIPT_URL.replace(/\/exec$/, '/exec')
                         : (imageProxyBaseUrl || "");
            const proxyUrl = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

            const response = await fetch(proxyUrl);
            const json = await response.json();

            if (json.ok) {
              const dataUrl = "data:" + json.mime + ";base64," + json.data;
              logoEl.src = dataUrl;
              logoEl.style.display = "block";
            } else {
              logoEl.style.display = "none";
            }
          } catch (err) {
            console.error("Error loading logo from Drive:", err);
            logoEl.style.display = "none";
          }
        } else {
          // Regular URL - apply directly
          logoEl.src = url;
          logoEl.style.display = "block";
        }
      }

      // -------------------- Rendering --------------------

      function updateHeaderUI() {
        document.getElementById("appName").textContent =
          (settings && settings.appName) || "App";

        document.getElementById("catalogName").textContent =
          (settings && settings.catalogName) || "Catalogue";

        document.getElementById("userEmail").textContent =
          (user && user.email) || "";
        document.getElementById("userProfilePill").textContent =
          (user && user.profile) || "";

        document.title = (settings && settings.appName) || "Catalogue";

        // Apply logo if set in Settings C6
        if (settings && settings.logoUrl) {
          applyLogoImage(settings.logoUrl);
        }

        // Apply background image if set in Settings I5
        if (settings && settings.backgroundImageUrl && settings.backgroundImageUrl.trim() !== "") {
          applyBackgroundImage(settings.backgroundImageUrl);
        }

        // Update login/logout button visibility based on mode
        updateLoginButtonVisibility();
      }

      function updateLoginButtonVisibility() {
        const userInfoBlock = document.getElementById("userInfoBlock");
        if (!userInfoBlock) return;

        const appMode = window.currentAppMode || (settings && settings.appMode);
        const userEmailEl = document.getElementById("userEmail");
        const userProfilePill = document.getElementById("userProfilePill");
        const logoutBtn = document.getElementById("logoutBtn");

        // "Public all in Viewer" - hide login/logout completely
        if (appMode === "Public all in Viewer") {
          userInfoBlock.style.display = "none";
          return;
        }

        // "Private with Profiles" - always show (user must be logged in)
        if (appMode === "Private with Profiles") {
          userInfoBlock.style.display = "flex";
          // User info is already set by loadPrivateApp
          if (logoutBtn) {
            logoutBtn.textContent = "Logout";
            logoutBtn.onclick = logout;
          }
          return;
        }

        // "Public with Login" - show login button if not logged in, logout if logged in
        if (appMode === "Public with Login") {
          userInfoBlock.style.display = "flex";

          if (!user || !user.email) {
            // Not logged in - show "Viewer" and "Login" button
            if (userEmailEl) userEmailEl.textContent = "Viewer";
            if (userProfilePill) userProfilePill.style.display = "none";
            if (logoutBtn) {
              logoutBtn.textContent = "Login";
              logoutBtn.onclick = showLoginScreen;
            }
          } else {
            // Logged in - show user email and "Logout" button
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userProfilePill) {
              userProfilePill.textContent = user.profile || "Viewer";
              userProfilePill.style.display = "inline";
            }
            if (logoutBtn) {
              logoutBtn.textContent = "Logout";
              logoutBtn.onclick = logout;
            }
          }
          return;
        }

        // Default - show login/logout
        userInfoBlock.style.display = "flex";
      }

      function canEditItem(item) {
        if (!user) return false;
        if (user.profile === "Creator") return true;
        if (user.profile === "Editor") {
          return item["Added By"] === user.email;
        }
        return false;
      }

      function canDeleteItem(item) {
        return canEditItem(item);
      }

      function applyRoleVisibility() {
        if (!user) return;

        const addBtn = document.getElementById("addBtn");
        const sheetLinkBtn = document.getElementById("sheetLinkBtn");

        if (user.profile === "Viewer") {
          addBtn.style.display = "none";
          sheetLinkBtn.style.display = "none";
        } else if (user.profile === "Editor") {
          addBtn.style.display = "inline-flex";
          sheetLinkBtn.style.display = "none";
        } else if (user.profile === "Creator") {
          addBtn.style.display = "inline-flex";
          sheetLinkBtn.style.display = "inline-flex";
        }

        // Hide Filter button if no filter columns configured or used
        const filterBtn = document.getElementById("filterBtn");
        const hasFilterData = filterColumns.length > 0 && filterColumns.some(col =>
          col.uniqueValues && col.uniqueValues.length > 0
        );

        if (!hasFilterData) {
          filterBtn.style.display = "none";
        } else {
          filterBtn.style.display = "inline-flex";
        }
      }

      function updateChipsUI() {
        // Count total filters selected
        let totalFilters = 0;
        for (const columnName in filterValues) {
          totalFilters += filterValues[columnName].length;
        }

        const badge = document.getElementById("filterBadge");
        if (totalFilters > 0) {
          badge.textContent = totalFilters;
          badge.style.display = "inline-flex";
        } else {
          badge.style.display = "none";
        }

        // Update sort label
        const sortLabel = document.getElementById("sortLabel");
        if (sortField === "none") {
          sortLabel.textContent = "None";
        } else {
          // Find display name for sort field
          let displayName = sortField;
          for (let i = 0; i < columnConfig.length; i++) {
            if (columnConfig[i].columnName === sortField) {
              displayName = columnConfig[i].displayName || sortField;
              break;
            }
          }
          const orderText = sortOrder === "asc" ? "‚Üë" : "‚Üì";
          sortLabel.textContent = displayName + " " + orderText;
        }
      }

      function applyFiltersAndSorting() {
        // Get base items depending on current context
        let items;

        if (currentView === "layer") {
          // If in layer view, don't apply filters/sorting - just re-render current layer
          if (currentLayerIndex >= 0 && currentLayerIndex < layerConfig.length) {
            const layerName = layerConfig[currentLayerIndex].layerName;
            const parentFilterName = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].itemName : null;
            renderLayerView(currentLayerIndex, parentFilterName);
            return;
          }
        } else if (navigationStack.length > 0 && currentView === "list") {
          // If viewing Main items after layer navigation, start with those filtered items
          // Reconstruct the base filtered items from layer navigation
          const lastNav = navigationStack[navigationStack.length - 1];
          const mainColumnName = layerConfig[lastNav.layerIndex].mainColumnName;
          items = allItems.filter(item => {
            const colValue = item[mainColumnName];
            return colValue && String(colValue).trim() === lastNav.itemName;
          }).slice();
        } else {
          // Normal view - use all items
          items = allItems.slice();
        }

        // Apply all filters (items must match ALL selected filters)
        for (const columnName in filterValues) {
          const selected = filterValues[columnName];
          if (selected && selected.length > 0) {
            items = items.filter(function (it) {
              const itemValue = String(it[columnName] || "");
              return selected.indexOf(itemValue) !== -1;
            });
          }
        }

        // Apply search filter (Primary Identifier only)
        if (searchQuery && searchQuery.trim() !== "") {
          const query = searchQuery.toLowerCase().trim();
          items = items.filter(function (it) {
            if (!nameColumn) return true; // If no name column defined, show all
            const itemName = String(it[nameColumn.columnName] || "").toLowerCase();
            return itemName.indexOf(query) !== -1;
          });
        }

        // Sorting
        if (sortField !== "none") {
          // Check if this is a date column
          let isDateColumn = false;
          for (let i = 0; i < columnConfig.length; i++) {
            if (columnConfig[i].columnName === sortField && columnConfig[i].type === "date") {
              isDateColumn = true;
              break;
            }
          }

          items.sort(function (a, b) {
            let av = a[sortField];
            let bv = b[sortField];

            // Date sorting: oldest -> newest for asc
            if (isDateColumn || (dateColumn && sortField === dateColumn.columnName)) {
              let ad = av ? new Date(av) : null;
              let bd = bv ? new Date(bv) : null;
              if (!ad && !bd) return 0;
              if (!ad) return 1;
              if (!bd) return -1;
              return sortOrder === "asc" ? ad - bd : bd - ad;
            }

            // string compare
            av = av == null ? "" : String(av).toLowerCase();
            bv = bv == null ? "" : String(bv).toLowerCase();
            if (av < bv) return sortOrder === "asc" ? -1 : 1;
            if (av > bv) return sortOrder === "asc" ? 1 : -1;
            return 0;
          });
        }

        renderList(items);
      }

      function renderList(items) {
        const grid = document.getElementById("gridView");
        const det = document.getElementById("detailView");
        det.style.display = "none";
        grid.innerHTML = "";

        // Reset table widths when switching views
        if (typeof resetTableWidths === 'function') {
          resetTableWidths();
        }

        // Store items for detail view navigation
        currentDisplayedItems = items;
        currentDetailIndex = -1;

        if (!items.length) {
          grid.innerHTML =
            "<p style='color:#6b7280;font-size:13px;'>No items for this selection.</p>";
          return;
        }

        // Route to appropriate view renderer based on mainViewType
        const viewType = getMainViewType();
        if (viewType === 'list') {
          renderListView(items, grid);
        } else if (viewType === 'table') {
          renderTableView(items, grid);
        } else {
          // Default to cards view
          renderCardsView(items, grid);
        }

        // Update filter/sort button visibility based on view type
        updateFilterSortVisibility();
      }

      // Render Cards View (current default grid layout)
      function renderCardsView(items, grid) {
        grid.classList.add('grid');
        grid.classList.remove('list-view', 'table-view');

        // Get style for main items
        const style = getMainStyle();

        // Add style class to grid for Rectangle cards
        if (style === 'Rectangle') {
          grid.classList.add('grid-rectangle');
        } else {
          grid.classList.remove('grid-rectangle');
        }

        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const card = document.createElement("div");
          card.className = "card";

          // Apply style class based on card style
          if (style === 'Rectangle') {
            card.classList.add('style-rectangle');
          } else if (style === 'Circle') {
            card.classList.add('style-circle');
          }
          // Squared is default, no additional class needed

          // Create image wrapper for lazy loading
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "card-img-wrapper";

          if (imageColumn && item[imageColumn.columnName]) {
            const rawUrl = item[imageColumn.columnName];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              // LAZY LOADING: Store fileId and observe
              imgWrapper.dataset.fileId = fileId;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                // Fallback if IntersectionObserver not supported
                loadImageViaProxy(fileId, imgWrapper);
              }
            } else if (rawUrl) {
              // Direct HTTPS image
              imgWrapper.dataset.rawUrl = rawUrl;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadDirectImage(rawUrl, imgWrapper);
              }
            } else {
              imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            }
          } else {
            imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
          }

          card.appendChild(imgWrapper);

          const body = document.createElement("div");
          body.className = "card-body";

          const nameEl = document.createElement("div");
          nameEl.className = "card-name";
          nameEl.textContent = nameColumn ? (item[nameColumn.columnName] || "(no name)") : "(no name)";
          body.appendChild(nameEl);

          const sub = document.createElement("div");
          sub.className = "card-sub";
          const cat = categoryColumn ? (item[categoryColumn.columnName] || "") : "";
          const place = placeColumn ? (item[placeColumn.columnName] || "") : "";
          sub.textContent = [cat, place].filter(Boolean).join(" ‚Ä¢ ");
          body.appendChild(sub);

          card.appendChild(body);

          card.onclick = (function (it, idx) {
            return function () {
              showDetails(it, idx);
            };
          })(item, i);

          grid.appendChild(card);
        }
      }

      // Render List View (vertical list with image left, details right)
      function renderListView(items, grid) {
        grid.classList.remove('grid', 'table-view');
        grid.classList.add('list-view');

        // Get style for main items
        const style = getMainStyle();

        // Apply list style class
        if (style === 'Double') {
          grid.classList.add('style-double');
        } else if (style === 'Triple') {
          grid.classList.add('style-triple');
        } else {
          grid.classList.add('style-simple');
        }

        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const listItem = document.createElement("div");
          listItem.className = "list-item";

          // Image on the left
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "list-item-img-wrapper";

          if (imageColumn && item[imageColumn.columnName]) {
            const rawUrl = item[imageColumn.columnName];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              imgWrapper.dataset.fileId = fileId;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadImageViaProxy(fileId, imgWrapper);
              }
            } else if (rawUrl) {
              imgWrapper.dataset.rawUrl = rawUrl;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadDirectImage(rawUrl, imgWrapper);
              }
            } else {
              imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            }
          } else {
            imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
          }

          listItem.appendChild(imgWrapper);

          // Details on the right
          const detailsWrapper = document.createElement("div");
          detailsWrapper.className = "list-item-details";

          const nameEl = document.createElement("div");
          nameEl.className = "list-item-name";
          nameEl.textContent = nameColumn ? (item[nameColumn.columnName] || "(no name)") : "(no name)";
          detailsWrapper.appendChild(nameEl);

          const sub = document.createElement("div");
          sub.className = "list-item-sub";
          const cat = categoryColumn ? (item[categoryColumn.columnName] || "") : "";
          const place = placeColumn ? (item[placeColumn.columnName] || "") : "";
          sub.textContent = [cat, place].filter(Boolean).join(" ‚Ä¢ ");
          detailsWrapper.appendChild(sub);

          listItem.appendChild(detailsWrapper);

          listItem.onclick = (function (it, idx) {
            return function () {
              showDetails(it, idx);
            };
          })(item, i);

          grid.appendChild(listItem);
        }
      }

      // Render Table View (spreadsheet-style)
      function renderTableView(items, grid) {
        grid.classList.remove('grid', 'list-view');
        grid.classList.add('table-view');

        // Get style for main items
        const tableStyle = getMainStyle();

        // Store items for table filtering
        currentTableItems = items.slice();

        // Determine which columns to show based on whether we're in layer view or not
        let columnsToShow = [];

        if (currentView === "layer") {
          // In layer view: show only Primary Identifier, SubId1, SubId2
          columnsToShow = [nameColumn, categoryColumn, placeColumn].filter(col => col != null);
        } else {
          // In Main list: show columns where showOnTable is true
          columnsToShow = columnConfig.filter(col => col.showOnTable === true);

          // Fallback: if no columns have showOnTable=true (column doesn't exist yet),
          // show all columns with itemPlace set (backward compatibility)
          if (columnsToShow.length === 0) {
            columnsToShow = columnConfig.filter(col => {
              const itemPlace = col.itemPlace;
              return itemPlace && itemPlace !== "";
            });
          }
        }

        // Apply table column filters
        let filteredItems = applyTableFilters(items, columnsToShow);

        // Apply table sorting
        filteredItems = applyTableSort(filteredItems, columnsToShow);

        // Create table
        const table = document.createElement("table");
        table.className = "data-table";

        // Create header row with interactive controls
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        for (let i = 0; i < columnsToShow.length; i++) {
          const col = columnsToShow[i];
          const th = document.createElement("th");
          th.className = "table-header-cell";
          th.dataset.columnName = col.columnName; // Add data attribute for reliable identification

          // Add sort indicator if this column is sorted
          if (tableSortColumn === col.columnName) {
            th.classList.add(tableSortOrder === "asc" ? "sorted-asc" : "sorted-desc");
          }

          // Create header content
          const headerText = document.createElement("span");
          headerText.textContent = col.displayName || col.columnName;
          th.appendChild(headerText);

          // Add filter indicator if this column has active filters
          const activeFilters = tableColumnFilters[col.columnName];
          if (activeFilters && activeFilters.length > 0) {
            const filterBadge = document.createElement("span");
            filterBadge.className = "filter-indicator";
            filterBadge.textContent = "üîç";
            filterBadge.title = `${activeFilters.length} filter(s) active`;
            th.appendChild(filterBadge);
          }

          // Create dropdown menu
          const menu = createTableColumnMenu(col, columnsToShow);
          th.appendChild(menu);

          // Toggle menu on click
          th.onclick = (function(menuEl, columnName, headerCell) {
            return function(e) {
              e.stopPropagation();
              // Close all other menus
              document.querySelectorAll('.table-column-menu').forEach(m => {
                if (m !== menuEl) m.classList.remove('active');
              });
              const isOpening = !menuEl.classList.contains('active');
              menuEl.classList.toggle('active');

              // Track active menu and manage scroll lock
              if (isOpening) {
                activeTableMenuColumn = columnName;
                // Lock body scroll when dropdown opens
                lockScroll();
              } else {
                activeTableMenuColumn = null;
                // Restore body scroll when dropdown closes
                unlockScroll();
              }
            };
          })(menu, col.columnName, th);

          headerRow.appendChild(th);
        }

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create body
        const tbody = document.createElement("tbody");

        for (let i = 0; i < filteredItems.length; i++) {
          const item = filteredItems[i];
          const row = document.createElement("tr");
          row.className = "table-row";

          // Remove pointer cursor for "No Detail View" style
          if (tableStyle === 'No Detail View') {
            row.style.cursor = 'default';
          }

          for (let j = 0; j < columnsToShow.length; j++) {
            const col = columnsToShow[j];
            const td = document.createElement("td");
            const value = item[col.columnName] || "";

            // Handle different column types
            if (col.type === "image" && value) {
              // Image type: show small image
              const imgWrapper = document.createElement("div");
              // Image size: GitHub Pages uses 45px portrait/45px landscape, non-GitHub uses 90px portrait/60px default
              let imgSize = '60px'; // Default size
              if (document.documentElement.classList.contains('github-pages')) {
                // GitHub Pages: 45px for both mobile portrait and landscape
                if (document.body.classList.contains('mobile-device')) {
                  imgSize = '45px';
                }
              } else {
                // Non-GitHub Pages: 90px for mobile/tablet portrait
                if ((document.body.classList.contains('mobile-device') || document.body.classList.contains('tablet-device')) &&
                    document.body.classList.contains('portrait')) {
                  imgSize = '90px';
                }
              }
              imgWrapper.style.cssText = `width: ${imgSize}; height: ${imgSize}; position: relative; background: #e5e7eb; border-radius: 6px; overflow: hidden;`;

              const fileId = extractDriveFileId(value);
              if (fileId) {
                imgWrapper.dataset.fileId = fileId;
                if (imageObserver) {
                  imageObserver.observe(imgWrapper);
                } else {
                  loadImageViaProxy(fileId, imgWrapper);
                }
              } else if (value) {
                const img = document.createElement("img");
                img.className = "table-cell-img";
                img.src = value;
                img.loading = "lazy";
                imgWrapper.appendChild(img);
              }

              td.appendChild(imgWrapper);
              td.style.padding = "6px 16px"; // Reduce padding for image cells
            } else if (col.type === "url" && value) {
              // URL type: show clickable link with display name
              const link = document.createElement("a");
              link.className = "table-cell-link";
              link.href = value;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.textContent = col.displayName || col.columnName;
              link.onclick = (e) => {
                e.stopPropagation(); // Prevent row click
              };
              td.appendChild(link);
            } else if (col.type === "date" && value) {
              // Date type: format the date
              td.textContent = formatDate(value);
            } else {
              // Text, number, and other types: display as is
              td.textContent = value;
            }

            row.appendChild(td);
          }

          row.onclick = (function (it, idx, rowEl) {
            return function () {
              handleMainTableRowClick(it, idx, rowEl);
            };
          })(item, i, row);

          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        grid.appendChild(table);

        // Sync header widths with table after rendering
        const isGitHubPages = document.documentElement.classList.contains('github-pages');
        const isMobile = document.body.classList.contains('mobile-device');

        if (isGitHubPages && isMobile) {
          // GitHub Pages mobile: Use 100ms delay for CSS to apply
          setTimeout(() => {
            syncTableWidthToHeaders();
          }, 100);
        } else {
          // Non-GitHub Pages or desktop
          requestAnimationFrame(() => {
            syncTableWidthToHeaders();
          });
        }
      }

      // Synchronize top-header and filters-row width with table width
      // This ensures headers extend to match table width when table exceeds viewport
      function syncTableWidthToHeaders() {
        const grid = document.getElementById("gridView");
        const topHeader = document.querySelector(".top-header");
        const filtersRow = document.querySelector(".filters-row");
        const table = document.querySelector(".data-table");
        const shell = document.querySelector(".shell");

        // Only run if we're in table view and elements exist
        if (!grid || !grid.classList.contains('table-view') || !table || !topHeader || !filtersRow || !shell) {
          return;
        }

        // Get the actual table width (use offsetWidth for correct visible width)
        const tableWidth = table.offsetWidth;
        const shellPadding = parseInt(getComputedStyle(shell).paddingLeft) + parseInt(getComputedStyle(shell).paddingRight);
        const viewportWidth = window.innerWidth;

        // ALWAYS set headers to match table width on ALL devices
        // This makes headers "follow down" when scrolling
        const widthToSet = tableWidth + 'px';
        topHeader.style.width = widthToSet;
        topHeader.style.minWidth = widthToSet;
        filtersRow.style.width = widthToSet;
        filtersRow.style.minWidth = widthToSet;

        // CRITICAL FIX: Prevent shell width from exceeding viewport on GitHub Pages mobile
        // This prevents unwanted zoom when orientation changes
        const isGitHubPages = document.documentElement.classList.contains('github-pages');
        const isMobile = document.body.classList.contains('mobile-device');

        if (isGitHubPages && isMobile) {
          // On GitHub Pages mobile, NEVER set shell wider than viewport
          // This prevents zoom-in/zoom-out bugs during orientation changes
          const maxAllowedWidth = viewportWidth;
          const desiredShellWidth = tableWidth + shellPadding;

          if (desiredShellWidth <= maxAllowedWidth) {
            // Table fits in viewport - set shell to table width
            shell.style.width = `${desiredShellWidth}px`;
          } else {
            // Table exceeds viewport - let shell be 100% width (allow horizontal scroll)
            shell.style.width = '';
            shell.style.maxWidth = '';
          }
          shell.style.minWidth = '';
        } else {
          // Non-GitHub Pages or desktop: Use original behavior
          shell.style.width = `${tableWidth + shellPadding}px`;
          shell.style.minWidth = '';
        }
      }

      // Reset header and shell widths when switching away from table view
      function resetTableWidths() {
        const topHeader = document.querySelector(".top-header");
        const filtersRow = document.querySelector(".filters-row");
        const shell = document.querySelector(".shell");

        if (topHeader) {
          topHeader.style.width = '';
          topHeader.style.minWidth = '';
        }
        if (filtersRow) {
          filtersRow.style.width = '';
          filtersRow.style.minWidth = '';
        }
        if (shell) {
          shell.style.width = '';
          shell.style.minWidth = '';
        }
      }

      // Handle main table row click - either show details or expand inline
      function handleMainTableRowClick(item, index, rowElement) {
        const style = getMainStyle();
        const viewType = getMainViewType();

        // Check if this is a table view with "No Detail View" style - skip navigation
        if (viewType === 'table' && style === 'No Detail View') {
          // Do nothing - no detail view for this style
          return;
        }

        // Check if this is a table view with "Open Detail View" style
        if (viewType === 'table' && style === 'Open Detail View') {
          // Toggle row expansion to show detail view inline
          toggleMainRowExpansion(item, index, rowElement);
          return;
        }

        // Normal navigation behavior - show detail view
        showDetails(item, index);
      }

      // Toggle expansion of a main table row to show detail view inline
      function toggleMainRowExpansion(item, itemIndex, rowElement) {
        const rowId = `main-row-${itemIndex}`;

        // Check if this row is already expanded
        if (expandedRows.has(rowId)) {
          // Collapse: remove the expanded row
          expandedRows.delete(rowId);
          const expandedRow = rowElement.nextElementSibling;
          if (expandedRow && expandedRow.classList.contains('expanded-content-row')) {
            expandedRow.remove();
          }
          rowElement.classList.remove('row-expanded');
          return;
        }

        // Expand: add the expanded row with detail view
        expandedRows.add(rowId);
        rowElement.classList.add('row-expanded');

        // Render the detail view content
        const contentHtml = renderExpandedDetailView(item, itemIndex);

        // Create and insert the expanded row
        const expandedRow = document.createElement('tr');
        expandedRow.className = 'expanded-content-row';
        const numColumns = rowElement.children.length;
        expandedRow.innerHTML = `<td colspan="${numColumns}" style="padding: 0; background: #f9fafb; border-top: 2px solid #e5e7eb;">${contentHtml}</td>`;

        // Insert after the current row
        rowElement.parentNode.insertBefore(expandedRow, rowElement.nextSibling);

        // Load the image if present
        if (imageColumn && item[imageColumn.columnName]) {
          const imgWrapper = document.getElementById("inlineDetailImgWrapper_" + itemIndex);
          if (imgWrapper) {
            const rawUrl = item[imageColumn.columnName];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              loadDetailImage(fileId, imgWrapper);
            } else if (rawUrl) {
              loadDetailImageDirect(rawUrl, imgWrapper);
            }
          }
        }
      }

      // Render detail view content for expanded row
      function renderExpandedDetailView(item, index) {
        // Match the exact same structure as showDetails with image
        let html = '<div style="padding: 24px; position: relative;">';

        // Add 'no-image' class if there's no image
        const hasImage = imageColumn && item[imageColumn.columnName];
        const detailLayoutClass = hasImage ? 'detail-layout' : 'detail-layout no-image';

        // Use detail-layout grid structure (image on left, content on right)
        html += '<div class="' + detailLayoutClass + '">';

        // Image container
        html += '<div id="detailImgContainer">';
        if (hasImage) {
          html += '<div class="detail-img-wrapper" id="inlineDetailImgWrapper_' + index + '"></div>';
        } else {
          html += '<div class="detail-img-wrapper"></div>';
        }
        html += '</div>';

        // Content container
        html += '<div id="detailContentContainer">';

        // Title row with name
        html += '<div class="detail-title-row">' +
          '<div class="detail-name">' +
          (nameColumn ? (item[nameColumn.columnName] || "") : "") +
          '</div>' +
          '</div>';

        // Add SubID1 and SubID2 under the Primary Identifier
        const subBits = [];
        if (categoryColumn && item[categoryColumn.columnName]) subBits.push(item[categoryColumn.columnName]);
        if (placeColumn && item[placeColumn.columnName]) subBits.push(item[placeColumn.columnName]);

        if (subBits.length > 0) {
          html += '<div class="detail-subtitle">' +
            subBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Top Corner fields - collect all values with same styling as SubId
        const topCornerBits = [];
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "topcorner") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            topCornerBits.push(displayVal);
          }
        }

        if (topCornerBits.length > 0) {
          html += '<div class="detail-topcorner" style="position: absolute; top: 24px; right: 24px;">' +
            topCornerBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Long text Up fields (before two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextup") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field" style="margin-top: 16px;">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }

        // Create two-column layout for detail fields using inline styles (matches normal detail view)
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; background: #e2e8f0; padding: 20px; border-radius: 12px; border: 1px solid #cbd5e1;">';

        // Left column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailleft") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        // Right column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailright") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        html += '</div>'; // Close grid

        // Long text Down fields (after two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextdown") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field" style="margin-top: 16px;">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }

        // Bottom fields
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "bottom") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field" style="margin-top: 16px;">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }

        // Edit and Delete buttons (following user profile rules)
        if (user && user.profile !== "Viewer") {
          const editable = canEditItem(item);
          const deletable = canDeleteItem(item);

          if (editable || deletable) {
            html += '<div class="detail-actions" style="margin-top: 16px;">';
            if (editable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-secondary" onclick="openEdit(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">‚úè Edit</button>";
            }
            if (deletable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-danger" onclick="confirmDelete(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">üóë Delete</button>";
            }
            html += "</div>";
          }
        }

        html += '</div>'; // Close content container div
        html += '</div>'; // Close detail-layout
        html += '</div>'; // Close outer div
        return html;
      }

      // Create dropdown menu for table column
      function createTableColumnMenu(col, allColumns) {
        const menu = document.createElement("div");
        menu.className = "table-column-menu";

        // Top section with Close and Clear buttons side by side
        const topSection = document.createElement("div");
        topSection.className = "table-menu-section";
        topSection.style.borderBottom = "none";
        topSection.style.padding = "4px";

        const buttonRow = document.createElement("div");
        buttonRow.className = "table-menu-button-row";

        const closeBtn = document.createElement("button");
        closeBtn.className = "table-menu-button";
        closeBtn.textContent = "‚úï Close";
        closeBtn.style.color = "#6b7280";
        closeBtn.style.fontWeight = "600";
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeAllTableMenus();
          // Apply filters when closing
          rerenderTable();
        };
        buttonRow.appendChild(closeBtn);

        // Add Clear button if there are active filters or sorting on this column
        if (tableSortColumn === col.columnName || tableColumnFilters[col.columnName]) {
          const clearBtn = document.createElement("button");
          clearBtn.className = "table-menu-button";
          clearBtn.textContent = "Clear";
          clearBtn.onclick = (e) => {
            e.stopPropagation();
            if (tableSortColumn === col.columnName) {
              tableSortColumn = null;
              tableSortOrder = "asc";
            }
            delete tableColumnFilters[col.columnName];
            closeAllTableMenus();
            rerenderTable();
          };
          buttonRow.appendChild(clearBtn);
        }

        topSection.appendChild(buttonRow);
        menu.appendChild(topSection);

        // Sort section
        const sortSection = document.createElement("div");
        sortSection.className = "table-menu-section";

        const sortTitle = document.createElement("div");
        sortTitle.className = "table-menu-title";
        sortTitle.textContent = "SORT";
        sortSection.appendChild(sortTitle);

        const sortItemsRow = document.createElement("div");
        sortItemsRow.className = "table-menu-items-row";

        const sortAsc = document.createElement("div");
        sortAsc.className = "table-menu-item";
        sortAsc.textContent = "A ‚Üí Z";
        sortAsc.onclick = (e) => {
          e.stopPropagation();
          tableSortColumn = col.columnName;
          tableSortOrder = "asc";
          closeAllTableMenus();
          rerenderTable();
        };
        sortItemsRow.appendChild(sortAsc);

        const sortDesc = document.createElement("div");
        sortDesc.className = "table-menu-item";
        sortDesc.textContent = "Z ‚Üí A";
        sortDesc.onclick = (e) => {
          e.stopPropagation();
          tableSortColumn = col.columnName;
          tableSortOrder = "desc";
          closeAllTableMenus();
          rerenderTable();
        };
        sortItemsRow.appendChild(sortDesc);

        sortSection.appendChild(sortItemsRow);
        menu.appendChild(sortSection);

        // Filter section
        const filterSection = document.createElement("div");
        filterSection.className = "table-menu-section";

        const filterTitle = document.createElement("div");
        filterTitle.className = "table-menu-title";
        filterTitle.textContent = "Filter";
        filterSection.appendChild(filterTitle);

        // Get unique values for this column
        const uniqueValues = getUniqueColumnValues(currentTableItems, col.columnName);
        const selectedFilters = tableColumnFilters[col.columnName] || [];

        // "Select All" option
        const selectAllLabel = document.createElement("label");
        selectAllLabel.className = "table-filter-checkbox";
        const selectAllCheckbox = document.createElement("input");
        selectAllCheckbox.type = "checkbox";
        selectAllCheckbox.checked = selectedFilters.length === 0;
        selectAllCheckbox.onchange = (e) => {
          e.stopPropagation();

          // Read the checkbox state (browser has already toggled it)
          const isChecked = selectAllCheckbox.checked;

          console.log('Select All changed, new state:', isChecked);

          if (isChecked) {
            // Select all = remove filter (show everything)
            delete tableColumnFilters[col.columnName];
            // Check all individual checkboxes
            uniqueValues.forEach(value => {
              const checkbox = menu.querySelector(`input[data-filter-value="${CSS.escape(value)}"]`);
              if (checkbox) checkbox.checked = true;
            });
          } else {
            // Deselect all = filter to nothing (show nothing)
            tableColumnFilters[col.columnName] = [];
            // Uncheck all individual checkboxes
            uniqueValues.forEach(value => {
              const checkbox = menu.querySelector(`input[data-filter-value="${CSS.escape(value)}"]`);
              if (checkbox) checkbox.checked = false;
            });
          }
          // Don't rerender - let user continue selecting
        };
        selectAllLabel.appendChild(selectAllCheckbox);
        const selectAllText = document.createElement("span");
        selectAllText.textContent = "(Select All)";
        selectAllLabel.appendChild(selectAllText);
        filterSection.appendChild(selectAllLabel);

        // Individual value checkboxes
        uniqueValues.forEach(value => {
          const label = document.createElement("label");
          label.className = "table-filter-checkbox";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.dataset.filterValue = value; // Add data attribute for Select All to find it
          // If no filter exists, all are checked. If filter exists, check only if value is in filter
          if (selectedFilters.length === 0) {
            // No filter = all checked
            checkbox.checked = true;
          } else {
            // Filter exists = check only if this value is in the filter
            checkbox.checked = selectedFilters.includes(value);
          }

          checkbox.onchange = (e) => {
            e.stopPropagation();

            // Read the checkbox state (browser has already toggled it)
            const isChecked = checkbox.checked;

            console.log('Checkbox changed for', value, 'new state:', isChecked);

            // Update filter state without rerendering
            toggleTableColumnFilterWithoutRerender(col.columnName, value, isChecked);

            // Update "Select All" checkbox state
            const allChecked = uniqueValues.every(v => {
              const cb = menu.querySelector(`input[data-filter-value="${CSS.escape(v)}"]`);
              return cb && cb.checked;
            });
            selectAllCheckbox.checked = allChecked;
          };
          label.appendChild(checkbox);

          const text = document.createElement("span");
          text.textContent = value || "(blank)";
          label.appendChild(text);

          filterSection.appendChild(label);
        });

        menu.appendChild(filterSection);

        return menu;
      }

      // Get unique values from items for a column
      function getUniqueColumnValues(items, columnName) {
        const values = new Set();
        items.forEach(item => {
          const val = getItemValue(item, columnName);
          values.add(val != null ? String(val) : "");
        });
        return Array.from(values).sort();
      }

      // Toggle table column filter WITHOUT rerendering (for checkbox clicks)
      function toggleTableColumnFilterWithoutRerender(columnName, value, checked) {
        console.log('toggleTableColumnFilterWithoutRerender:', columnName, value, checked);

        if (!tableColumnFilters[columnName]) {
          // No filter exists yet - initialize with all unique values
          const allValues = getUniqueColumnValues(currentTableItems, columnName);
          tableColumnFilters[columnName] = [...allValues];
          console.log('Initialized filter with all values:', tableColumnFilters[columnName]);
        }

        if (checked) {
          // Add value to filter (show this value)
          if (!tableColumnFilters[columnName].includes(value)) {
            tableColumnFilters[columnName].push(value);
            console.log('Added value to filter:', value);
          }
        } else {
          // Remove value from filter (hide this value)
          const index = tableColumnFilters[columnName].indexOf(value);
          if (index > -1) {
            tableColumnFilters[columnName].splice(index, 1);
            console.log('Removed value from filter:', value);
          }
        }

        console.log('Filter state:', tableColumnFilters[columnName]);
        // Don't rerender - menu stays open for multiple selections
      }

      // Toggle table column filter WITH rerendering (for programmatic use)
      function toggleTableColumnFilter(columnName, value, checked) {
        toggleTableColumnFilterWithoutRerender(columnName, value, checked);
        rerenderTable();
      }

      // Get value from item (handles both regular items and layer items)
      function getItemValue(item, columnName) {
        // Check if this is a layer item
        if (item._isLayerItem && item._rawLayerItem) {
          return item._rawLayerItem[columnName];
        }
        return item[columnName];
      }

      // Apply table column filters
      function applyTableFilters(items, columnsToShow) {
        let filtered = items.slice();

        for (const columnName in tableColumnFilters) {
          const selectedValues = tableColumnFilters[columnName];
          if (selectedValues && selectedValues.length > 0) {
            filtered = filtered.filter(item => {
              const value = getItemValue(item, columnName);
              const itemValue = value != null ? String(value) : "";
              return selectedValues.includes(itemValue);
            });
          }
        }

        return filtered;
      }

      // Apply table sorting
      function applyTableSort(items, columnsToShow) {
        if (!tableSortColumn) return items;

        const sorted = items.slice();
        const colConfig = columnsToShow.find(c => c.columnName === tableSortColumn);
        const colType = colConfig ? colConfig.type : "text";

        sorted.sort((a, b) => {
          let av = getItemValue(a, tableSortColumn);
          let bv = getItemValue(b, tableSortColumn);

          // Date sorting: asc = oldest‚Üínewest, desc = newest‚Üíoldest
          if (colType === "date") {
            const ad = av ? new Date(av) : null;
            const bd = bv ? new Date(bv) : null;
            if (!ad && !bd) return 0;
            if (!ad) return 1;
            if (!bd) return -1;
            return tableSortOrder === "asc" ? ad - bd : bd - ad;
          }

          // Number sorting: asc = smallest‚Üíbiggest, desc = biggest‚Üísmallest
          if (colType === "number") {
            const an = av != null ? parseFloat(av) : null;
            const bn = bv != null ? parseFloat(bv) : null;
            if (isNaN(an) && isNaN(bn)) return 0;
            if (isNaN(an)) return 1;
            if (isNaN(bn)) return -1;
            return tableSortOrder === "asc" ? an - bn : bn - an;
          }

          // String sorting (text, url, image, etc.)
          av = av == null ? "" : String(av).toLowerCase();
          bv = bv == null ? "" : String(bv).toLowerCase();
          if (av < bv) return tableSortOrder === "asc" ? -1 : 1;
          if (av > bv) return tableSortOrder === "asc" ? 1 : -1;
          return 0;
        });

        return sorted;
      }

      // Re-render current table view
      function rerenderTable() {
        const grid = document.getElementById("gridView");
        grid.innerHTML = "";

        if (currentView === "layer") {
          // Re-render layer view
          const layerName = layerConfig[currentLayerIndex].layerName;
          const parentFilter = navigationStack.length > 0
            ? navigationStack[navigationStack.length - 1].itemName
            : null;
          const layerItems = getFilteredLayerItems(layerName, parentFilter);
          const standardizedItems = layerItems.map(item => ({
            _isLayerItem: true,
            _layerIndex: currentLayerIndex,
            _rawLayerItem: item,
            "Picture Link": item["Picture Link"],
            "Names": item["Names"],
            "Description": item["Description"]
          }));
          renderLayerTableView(standardizedItems, grid, currentLayerIndex);
        } else {
          // Re-render main table view
          renderTableView(currentTableItems, grid);
        }
        // Don't reopen menu - user closed it intentionally
      }

      // Close all table column menus
      function closeAllTableMenus() {
        document.querySelectorAll('.table-column-menu').forEach(menu => {
          menu.classList.remove('active');
        });
        activeTableMenuColumn = null;
        // Restore body scroll when menus are closed
        unlockScroll();
      }

      // Reopen the active menu after table rerender
      function reopenActiveTableMenu() {
        if (activeTableMenuColumn) {
          console.log('Reopening menu for column:', activeTableMenuColumn);
          // Find the th element for this column using data attribute
          const th = document.querySelector(`.table-header-cell[data-column-name="${activeTableMenuColumn}"]`);
          if (th) {
            const menu = th.querySelector('.table-column-menu');
            if (menu) {
              console.log('Menu found, setting active');
              // Menu position is handled by CSS (absolute positioning relative to header)
              menu.classList.add('active');
              // Lock body scroll when dropdown reopens
              lockScroll();
            } else {
              console.log('Menu not found in th');
            }
          } else {
            console.log('Header cell not found for column:', activeTableMenuColumn);
          }
        }
      }

      // --- SCROLL LOCK FUNCTIONS (for dropdown menus) ---
      // DISABLED: Setting body position:fixed breaks sticky table headers
      // Dropdowns use position:absolute relative to their header cells

      let scrollPosition = 0;
      let isScrollLocked = false;

      function lockScroll() {
        // DISABLED - was breaking sticky headers by setting body position:fixed
        return;
      }

      function unlockScroll() {
        // DISABLED - companion to lockScroll
        return;
      }

      // REMOVED: Scroll listener for updating dropdown position
      // No longer needed - dropdowns use position:absolute and automatically move with sticky header

      // --- LAYER NAVIGATION FUNCTIONS ---

      // Get filtered layer items based on parent layer selection
      function getFilteredLayerItems(layerName, parentFilterName) {
        const layerItems = layersData[layerName] || [];

        if (!parentFilterName) {
          // No parent filter - return all items
          return layerItems;
        }

        // Filter by "Part of Layer X" column
        // Find which parent layer this is (Layer 1, Layer 2, etc.)
        const currentLayerIndex = layerConfig.findIndex(lc => lc.layerName === layerName);
        if (currentLayerIndex <= 0) {
          // This is Layer 1 or not found - no parent filtering
          return layerItems;
        }

        // Get parent layer name
        const parentLayerName = layerConfig[currentLayerIndex - 1].layerName;
        const partOfColumnName = "Part of " + parentLayerName;

        // Filter items where "Part of Layer X" matches the parent item's Name
        return layerItems.filter(item => {
          const partOfValue = item[partOfColumnName];
          return partOfValue && String(partOfValue).trim() === parentFilterName;
        });
      }

      // Render a layer view respecting displayViewType
      function renderLayerView(layerIndex, parentFilterName) {
        const grid = document.getElementById("gridView");
        const det = document.getElementById("detailView");
        det.style.display = "none";
        grid.innerHTML = "";

        // Reset table widths when switching views
        if (typeof resetTableWidths === 'function') {
          resetTableWidths();
        }

        // Clear table filters when navigating to new view
        tableColumnFilters = {};
        tableSortColumn = null;
        tableSortOrder = "asc";
        activeTableMenuColumn = null;

        // Store navigation state
        currentView = "layer";
        currentLayerIndex = layerIndex;

        if (layerIndex < 0 || layerIndex >= layerConfig.length) {
          grid.innerHTML = "<p style='color:#6b7280;font-size:13px;'>Invalid layer.</p>";
          return;
        }

        const layerName = layerConfig[layerIndex].layerName;
        const layerItems = getFilteredLayerItems(layerName, parentFilterName);

        // Hide empty layers
        if (!layerItems.length) {
          grid.innerHTML = "<p style='color:#6b7280;font-size:13px;'>No items in this layer.</p>";
          return;
        }

        // Convert layer items to standard format for rendering
        const standardizedItems = layerItems.map(item => ({
          _isLayerItem: true,
          _layerIndex: layerIndex,
          _rawLayerItem: item,
          "Picture Link": item["Picture Link"],
          "Names": item["Names"],
          "Description": item["Description"]
        }));

        // Route to appropriate view renderer based on layer-specific view type
        const viewType = getViewTypeForLayer(layerIndex);
        if (viewType === 'list') {
          renderLayerListView(standardizedItems, grid, layerIndex);
        } else if (viewType === 'table') {
          renderLayerTableView(standardizedItems, grid, layerIndex);
        } else {
          // Default to cards view
          renderLayerCardsView(standardizedItems, grid, layerIndex);
        }

        // Update filter/sort button visibility based on view type
        updateFilterSortVisibility();
      }

      // Render layer items as cards
      function renderLayerCardsView(items, grid, layerIndex) {
        grid.classList.add('grid');
        grid.classList.remove('list-view', 'table-view');

        // Get style for this layer
        const style = getStyleForLayer(layerIndex);

        // Add style class to grid for Rectangle cards
        if (style === 'Rectangle') {
          grid.classList.add('grid-rectangle');
        } else {
          grid.classList.remove('grid-rectangle');
        }

        for (let i = 0; i < items.length; i++) {
          const standardItem = items[i];
          const item = standardItem._rawLayerItem;
          const card = document.createElement("div");
          card.className = "card";

          // Apply style class based on card style
          if (style === 'Rectangle') {
            card.classList.add('style-rectangle');
          } else if (style === 'Circle') {
            card.classList.add('style-circle');
          }
          // Squared is default, no additional class needed

          // Create image wrapper for lazy loading
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "card-img-wrapper";

          // Layer items have "Picture Link" column
          if (item["Picture Link"]) {
            const rawUrl = item["Picture Link"];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              imgWrapper.dataset.fileId = fileId;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadImageViaProxy(fileId, imgWrapper);
              }
            } else if (rawUrl) {
              imgWrapper.dataset.rawUrl = rawUrl;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadDirectImage(rawUrl, imgWrapper);
              }
            } else {
              imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            }
          } else {
            imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
          }

          card.appendChild(imgWrapper);

          const body = document.createElement("div");
          body.className = "card-body";

          const nameEl = document.createElement("div");
          nameEl.className = "card-name";
          nameEl.textContent = item["Names"] || "(no name)";
          body.appendChild(nameEl);

          if (item["Description"]) {
            const descEl = document.createElement("div");
            descEl.className = "card-sub";
            descEl.textContent = item["Description"];
            body.appendChild(descEl);
          }

          card.appendChild(body);

          card.onclick = (function (layerIdx, itm) {
            return function () {
              onLayerItemClick(layerIdx, itm);
            };
          })(layerIndex, item);

          grid.appendChild(card);
        }
      }

      // Render layer items as list
      function renderLayerListView(items, grid, layerIndex) {
        grid.classList.remove('grid', 'table-view');
        grid.classList.add('list-view');

        // Get style for this layer
        const style = getStyleForLayer(layerIndex);

        // Apply list style class
        if (style === 'Double') {
          grid.classList.add('style-double');
        } else if (style === 'Triple') {
          grid.classList.add('style-triple');
        } else {
          grid.classList.add('style-simple');
        }

        for (let i = 0; i < items.length; i++) {
          const standardItem = items[i];
          const item = standardItem._rawLayerItem;
          const listItem = document.createElement("div");
          listItem.className = "list-item";

          // Image on the left
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "list-item-img-wrapper";

          if (item["Picture Link"]) {
            const rawUrl = item["Picture Link"];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              imgWrapper.dataset.fileId = fileId;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadImageViaProxy(fileId, imgWrapper);
              }
            } else if (rawUrl) {
              imgWrapper.dataset.rawUrl = rawUrl;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadDirectImage(rawUrl, imgWrapper);
              }
            } else {
              imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            }
          } else {
            imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
          }

          listItem.appendChild(imgWrapper);

          const detailsWrapper = document.createElement("div");
          detailsWrapper.className = "list-item-details";

          const nameEl = document.createElement("div");
          nameEl.className = "list-item-name";
          nameEl.textContent = item["Names"] || "(no name)";
          detailsWrapper.appendChild(nameEl);

          if (item["Description"]) {
            const descEl = document.createElement("div");
            descEl.className = "list-item-sub";
            descEl.textContent = item["Description"];
            detailsWrapper.appendChild(descEl);
          }

          listItem.appendChild(detailsWrapper);

          listItem.onclick = (function (layerIdx, itm) {
            return function () {
              onLayerItemClick(layerIdx, itm);
            };
          })(layerIndex, item);

          grid.appendChild(listItem);
        }
      }

      // Render layer items as table
      function renderLayerTableView(items, grid, layerIndex) {
        grid.classList.remove('grid', 'list-view');
        grid.classList.add('table-view');

        // Get style for this layer
        const tableStyle = getStyleForLayer(layerIndex);

        // Store items for table filtering
        currentTableItems = items.slice();

        // Layer columns to show - include Picture Link if available
        const layerColumns = [
          { columnName: "Picture Link", displayName: "Image", type: "image" },
          { columnName: "Names", displayName: "Names", type: "text" },
          { columnName: "Description", displayName: "Description", type: "text" }
        ];

        // Apply table column filters
        let filteredItems = applyTableFilters(items, layerColumns);

        // Apply table sorting
        filteredItems = applyTableSort(filteredItems, layerColumns);

        const table = document.createElement("table");
        table.className = "data-table";

        // Create header row with interactive controls
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        for (let i = 0; i < layerColumns.length; i++) {
          const col = layerColumns[i];
          const th = document.createElement("th");
          th.className = "table-header-cell";
          th.dataset.columnName = col.columnName; // Add data attribute for reliable identification

          // Add sort indicator if this column is sorted
          if (tableSortColumn === col.columnName) {
            th.classList.add(tableSortOrder === "asc" ? "sorted-asc" : "sorted-desc");
          }

          // Create header content
          const headerText = document.createElement("span");
          headerText.textContent = col.displayName;
          th.appendChild(headerText);

          // Add filter indicator if this column has active filters
          const activeFilters = tableColumnFilters[col.columnName];
          if (activeFilters && activeFilters.length > 0) {
            const filterBadge = document.createElement("span");
            filterBadge.className = "filter-indicator";
            filterBadge.textContent = "üîç";
            filterBadge.title = `${activeFilters.length} filter(s) active`;
            th.appendChild(filterBadge);
          }

          // Create dropdown menu
          const menu = createTableColumnMenu(col, layerColumns);
          th.appendChild(menu);

          // Toggle menu on click
          th.onclick = (function(menuEl, columnName, headerCell) {
            return function(e) {
              e.stopPropagation();
              // Close all other menus
              document.querySelectorAll('.table-column-menu').forEach(m => {
                if (m !== menuEl) m.classList.remove('active');
              });
              const isOpening = !menuEl.classList.contains('active');
              menuEl.classList.toggle('active');

              // Track active menu and manage scroll lock
              if (isOpening) {
                activeTableMenuColumn = columnName;
                // Lock body scroll when dropdown opens
                lockScroll();
              } else {
                activeTableMenuColumn = null;
                // Restore body scroll when dropdown closes
                unlockScroll();
              }
            };
          })(menu, col.columnName, th);

          headerRow.appendChild(th);
        }

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        for (let i = 0; i < filteredItems.length; i++) {
          const standardItem = filteredItems[i];
          const item = standardItem._rawLayerItem;
          const row = document.createElement("tr");
          row.className = "table-row";

          // Render each column
          for (let j = 0; j < layerColumns.length; j++) {
            const col = layerColumns[j];
            const td = document.createElement("td");
            const value = item[col.columnName] || "";

            // Handle different column types
            if (col.type === "image" && value) {
              // Image type: show small image
              const imgWrapper = document.createElement("div");
              // Image size: GitHub Pages uses 45px portrait/45px landscape, non-GitHub uses 90px portrait/60px default
              let imgSize = '60px'; // Default size
              if (document.documentElement.classList.contains('github-pages')) {
                // GitHub Pages: 45px for both mobile portrait and landscape
                if (document.body.classList.contains('mobile-device')) {
                  imgSize = '45px';
                }
              } else {
                // Non-GitHub Pages: 90px for mobile/tablet portrait
                if ((document.body.classList.contains('mobile-device') || document.body.classList.contains('tablet-device')) &&
                    document.body.classList.contains('portrait')) {
                  imgSize = '90px';
                }
              }
              imgWrapper.style.cssText = `width: ${imgSize}; height: ${imgSize}; position: relative; background: #e5e7eb; border-radius: 6px; overflow: hidden;`;

              const fileId = extractDriveFileId(value);
              if (fileId) {
                imgWrapper.dataset.fileId = fileId;
                if (imageObserver) {
                  imageObserver.observe(imgWrapper);
                } else {
                  loadImageViaProxy(fileId, imgWrapper);
                }
              } else if (value) {
                const img = document.createElement("img");
                img.className = "table-cell-img";
                img.src = value;
                img.loading = "lazy";
                imgWrapper.appendChild(img);
              }

              td.appendChild(imgWrapper);
              td.style.padding = "6px 16px"; // Reduce padding for image cells
            } else {
              // Text and other types: display as is
              td.textContent = value;
            }

            row.appendChild(td);
          }

          row.onclick = (function (layerIdx, itm, rowEl, idx) {
            return function () {
              onLayerItemClick(layerIdx, itm, rowEl, idx);
            };
          })(layerIndex, item, row, i);

          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        grid.appendChild(table);

        // Sync header widths with table after rendering
        // On GitHub Pages mobile, add delay to ensure CSS has fully applied
        const isGitHubPages = document.documentElement.classList.contains('github-pages');
        const isMobile = document.body.classList.contains('mobile-device');

        if (isGitHubPages && isMobile) {
          // Match the delay used during orientation changes (100ms)
          // This ensures CSS for portrait/landscape has fully applied before calculating widths
          setTimeout(() => {
            syncTableWidthToHeaders();
          }, 100);
        } else {
          requestAnimationFrame(() => {
            syncTableWidthToHeaders();
          });
        }
      }

      // Handle layer item click - navigate to next layer or show filtered main items
      function onLayerItemClick(layerIndex, item, rowElement, itemIndex) {
        const itemName = item["Names"];
        const style = getStyleForLayer(layerIndex);
        const viewType = getViewTypeForLayer(layerIndex);

        // Check if this is a table view with "Open Detail View" style
        if (viewType === 'table' && style === 'Open Detail View') {
          // Toggle row expansion
          toggleLayerRowExpansion(layerIndex, item, rowElement, itemIndex);
          return;
        }

        // Normal navigation behavior
        // Add to navigation stack
        navigationStack.push({
          type: "layer",
          layerIndex: layerIndex,
          itemName: itemName
        });

        // Check if there's a next layer
        if (layerIndex + 1 < layerConfig.length) {
          // Navigate to next layer, filtered by this item
          const nextLayerName = layerConfig[layerIndex + 1].layerName;
          const filteredItems = getFilteredLayerItems(nextLayerName, itemName);

          // Hide empty layers - if no items, skip to main items
          if (filteredItems.length === 0) {
            console.log('Layer', nextLayerName, 'is empty, showing main items filtered by', itemName);
            showMainItemsFilteredByLayer(layerIndex, itemName);
          } else {
            // Show next layer
            renderLayerView(layerIndex + 1, itemName);

            // Update UI for back button
            updateLayerNavigationUI();

            // Push history state
            history.pushState({
              view: "layer",
              layerIndex: layerIndex + 1,
              parentFilter: itemName
            }, "", "");
          }
        } else {
          // This is the last layer - show filtered main items
          showMainItemsFilteredByLayer(layerIndex, itemName);
        }
      }

      // Toggle expansion of a layer table row to show next layer inline
      function toggleLayerRowExpansion(layerIndex, item, rowElement, itemIndex) {
        const itemName = item["Names"];
        const rowId = `layer-${layerIndex}-row-${itemIndex}`;

        // Check if this row is already expanded
        if (expandedRows.has(rowId)) {
          // Collapse: remove the expanded row
          expandedRows.delete(rowId);
          const expandedRow = rowElement.nextElementSibling;
          if (expandedRow && expandedRow.classList.contains('expanded-content-row')) {
            expandedRow.remove();
          }
          rowElement.classList.remove('row-expanded');
          return;
        }

        // Expand: add the expanded row
        expandedRows.add(rowId);
        rowElement.classList.add('row-expanded');

        // Determine what to show in the expanded row
        let contentHtml = '';

        // Check if there's a next layer
        if (layerIndex + 1 < layerConfig.length) {
          // Show next layer items filtered by this item
          const nextLayerName = layerConfig[layerIndex + 1].layerName;
          const filteredItems = getFilteredLayerItems(nextLayerName, itemName);

          if (filteredItems.length === 0) {
            contentHtml = '<div style="padding: 20px; text-align: center; color: #6b7280;">No items found in next layer</div>';
          } else {
            // Render the filtered items as cards/list based on next layer's view type
            const nextViewType = getViewTypeForLayer(layerIndex + 1);
            const nextStyle = getStyleForLayer(layerIndex + 1);
            contentHtml = renderExpandedLayerContent(filteredItems, layerIndex + 1, nextViewType, nextStyle, itemName);
          }
        } else {
          // This is the last layer - show filtered main items
          const mainColumnName = layerConfig[layerIndex].mainColumnName;
          const filteredItems = allItems.filter(mainItem => {
            const colValue = mainItem[mainColumnName];
            return colValue && String(colValue).trim() === itemName;
          });

          if (filteredItems.length === 0) {
            contentHtml = '<div style="padding: 20px; text-align: center; color: #6b7280;">No main items found</div>';
          } else {
            // Render the filtered main items as cards/list based on main view type
            contentHtml = renderExpandedMainContent(filteredItems, mainViewType, mainStyle);
          }
        }

        // Create and insert the expanded row
        const expandedRow = document.createElement('tr');
        expandedRow.className = 'expanded-content-row';
        const numColumns = rowElement.children.length;
        expandedRow.innerHTML = `<td colspan="${numColumns}" style="padding: 0; background: #f9fafb; border-top: 2px solid #e5e7eb;">${contentHtml}</td>`;

        // Insert after the current row
        rowElement.parentNode.insertBefore(expandedRow, rowElement.nextSibling);
      }

      // Render expanded layer content as a grid of cards/list
      function renderExpandedLayerContent(items, layerIndex, viewType, style, parentFilterName) {
        // Convert layer items to standardized format
        const standardizedItems = items.map(layerItem => {
          return {
            [nameColumn]: layerItem["Names"] || "",
            [descriptionColumn]: layerItem["Description"] || "",
            [imageColumn]: layerItem["Picture Link"] || "",
            _rawLayerItem: layerItem
          };
        });

        // Create a container div
        let html = '<div style="padding: 20px; max-height: 600px; overflow-y: auto;">';

        if (viewType === 'cards') {
          html += '<div class="grid" style="gap: 16px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">';

          for (let i = 0; i < standardizedItems.length; i++) {
            const item = standardizedItems[i];
            const cardHtml = createCardHtml(item, style, layerIndex, true);
            html += cardHtml;
          }

          html += '</div>';
        } else {
          // List view
          html += '<div style="display: flex; flex-direction: column; gap: 12px;">';

          for (let i = 0; i < standardizedItems.length; i++) {
            const item = standardizedItems[i];
            const name = item[nameColumn] || "";
            const description = item[descriptionColumn] || "";
            const image = item[imageColumn] || "";

            html += `
              <div style="display: flex; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer;"
                   onclick="onLayerItemClick(${layerIndex}, ${JSON.stringify(item._rawLayerItem).replace(/"/g, '&quot;')})">
                ${image ? `<div style="width: 60px; height: 60px; flex-shrink: 0;"><img src="${image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;"></div>` : ''}
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #1f2937;">${name}</div>
                  ${description ? `<div style="color: #6b7280; font-size: 14px; margin-top: 4px;">${description}</div>` : ''}
                </div>
              </div>
            `;
          }

          html += '</div>';
        }

        html += '</div>';
        return html;
      }

      // Render expanded main items content
      function renderExpandedMainContent(items, viewType, style) {
        // Create a container div
        let html = '<div style="padding: 20px; max-height: 600px; overflow-y: auto;">';

        if (viewType === 'cards') {
          html += '<div class="grid" style="gap: 16px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">';

          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const cardHtml = createCardHtml(item, style, -1, true);
            html += cardHtml;
          }

          html += '</div>';
        } else {
          // List view
          html += '<div style="display: flex; flex-direction: column; gap: 12px;">';

          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const name = item[nameColumn] || "";
            const description = item[descriptionColumn] || "";
            const image = item[imageColumn] || "";

            html += `
              <div style="display: flex; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer;"
                   onclick="showDetails(${JSON.stringify(item).replace(/"/g, '&quot;')}, ${i})">
                ${image ? `<div style="width: 60px; height: 60px; flex-shrink: 0;"><img src="${image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;"></div>` : ''}
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #1f2937;">${name}</div>
                  ${description ? `<div style="color: #6b7280; font-size: 14px; margin-top: 4px;">${description}</div>` : ''}
                </div>
              </div>
            `;
          }

          html += '</div>';
        }

        html += '</div>';
        return html;
      }

      // Helper function to create card HTML for expanded rows
      function createCardHtml(item, style, layerIndex, isInExpandedRow) {
        const name = item[nameColumn] || "";
        const description = item[descriptionColumn] || "";
        const image = item[imageColumn] || "";

        // Basic card structure
        let cardClass = 'card';
        if (style === 'Circle') cardClass += ' card-circle';

        const cardHtml = `
          <div class="${cardClass}" style="cursor: pointer; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; transition: all 0.2s;">
            ${image ? `<div style="width: 100%; aspect-ratio: 1; margin-bottom: 12px;"><img src="${image}" style="width: 100%; height: 100%; object-fit: cover; ${style === 'Circle' ? 'border-radius: 50%;' : 'border-radius: 8px;'}"></div>` : ''}
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${name}</div>
            ${description ? `<div style="color: #6b7280; font-size: 14px;">${description}</div>` : ''}
          </div>
        `;

        return cardHtml;
      }

      // Show main items filtered by the selected layer item
      function showMainItemsFilteredByLayer(layerIndex, itemName) {
        // Get the column name to filter by from layerConfig
        const mainColumnName = layerConfig[layerIndex].mainColumnName;

        // Filter main items where the column matches the selected layer item name
        const filteredItems = allItems.filter(item => {
          const colValue = item[mainColumnName];
          return colValue && String(colValue).trim() === itemName;
        });

        // Store for detail navigation
        currentDisplayedItems = filteredItems;
        currentDetailIndex = -1;

        // Clear table filters when navigating to new view
        tableColumnFilters = {};
        tableSortColumn = null;
        tableSortOrder = "asc";
        activeTableMenuColumn = null;

        // Render the filtered items
        currentView = "list";
        renderList(filteredItems);

        // Update UI for back button
        updateLayerNavigationUI();

        // Push history state
        history.pushState({
          view: "list",
          layerFiltered: true
        }, "", "");
      }

      // Update UI elements for layer navigation
      function updateLayerNavigationUI() {
        // Hide back button when layers exist (breadcrumb handles navigation)
        document.getElementById("backToListBtn").style.display = "none";

        // Hide filter and sort when in layer view (show when in final filtered list)
        if (currentView === "layer") {
          document.getElementById("filterWrapper").style.display = "none";
          document.getElementById("sortWrapper").style.display = "none";
        } else {
          // Show filter/sort only if columns are configured
          updateFilterSortVisibility();
        }

        // Update breadcrumb
        updateBreadcrumb();
      }

      // Update breadcrumb navigation
      function updateBreadcrumb() {
        const breadcrumbNav = document.getElementById("breadcrumbNav");

        if (navigationStack.length === 0 && currentView !== "layer") {
          // No breadcrumb needed
          breadcrumbNav.style.display = "none";
          return;
        }

        // Build breadcrumb path
        let breadcrumbHTML = '<a href="#" onclick="navigateToHome(); return false;" style="color: #64748b; text-decoration: none; font-weight: 500;">Home</a>';

        for (let i = 0; i < navigationStack.length; i++) {
          const nav = navigationStack[i];
          breadcrumbHTML += ' <span style="color: #cbd5e1; margin: 0 6px;">‚Ä∫</span> ';
          breadcrumbHTML += '<a href="#" onclick="navigateToBreadcrumb(' + i + '); return false;" style="color: #64748b; text-decoration: none;">' + nav.itemName + '</a>';
        }

        breadcrumbNav.innerHTML = breadcrumbHTML;
        breadcrumbNav.style.display = "flex";
      }

      // Navigate to a specific breadcrumb level
      function navigateToBreadcrumb(stackIndex) {
        // Trim navigation stack to the clicked level
        navigationStack = navigationStack.slice(0, stackIndex + 1);

        const nav = navigationStack[stackIndex];
        if (nav.type === "layer") {
          // Navigate to the next layer after this item
          if (nav.layerIndex + 1 < layerConfig.length) {
            const parentFilter = nav.itemName;
            renderLayerView(nav.layerIndex + 1, parentFilter);
            updateLayerNavigationUI();
          } else {
            // This was the last layer - show filtered main items
            showMainItemsFilteredByLayer(nav.layerIndex, nav.itemName);
          }
        }
      }

      // Navigate back from layer or filtered view
      function backFromLayer() {
        if (navigationStack.length === 0) {
          // No history - go to home (Layer 1 or main list)
          navigateToHome();
          return;
        }

        // Pop last navigation
        navigationStack.pop();

        if (navigationStack.length === 0) {
          // Back to home
          navigateToHome();
        } else {
          // Go back to previous layer
          const lastNav = navigationStack[navigationStack.length - 1];
          if (lastNav.type === "layer") {
            // Reconstruct parent filter from navigation stack
            const parentFilter = navigationStack.length >= 2
              ? navigationStack[navigationStack.length - 2].itemName
              : null;
            renderLayerView(lastNav.layerIndex, parentFilter);
            updateLayerNavigationUI();
          }
        }
      }

      // Navigate to home (Layer 1 or main list)
      function navigateToHome() {
        navigationStack = [];
        currentLayerIndex = -1;

        if (layerConfig.length > 0) {
          // Show Layer 1
          renderLayerView(0, null);
          document.getElementById("backToListBtn").style.display = "none";
          document.getElementById("filterWrapper").style.display = "none";
          document.getElementById("sortWrapper").style.display = "none";
        } else {
          // No layers - show main list
          currentView = "list";
          applyFiltersAndSorting();
          document.getElementById("backToListBtn").style.display = "none";
          // Show filter/sort only if columns are configured
          updateFilterSortVisibility();
        }

        updateBreadcrumb();
      }

      // -------------------- Tab Management Functions --------------------

      // Initialize tabs UI and populate tab switcher
      function initializeTabs() {
        // Show tab switcher only if more than one tab is configured
        const tabSwitcherWrapper = document.getElementById("tabSwitcherWrapper");

        if (tabsConfig.length <= 1) {
          tabSwitcherWrapper.style.display = "none";
          return;
        }

        tabSwitcherWrapper.style.display = "inline-block";

        // Update current tab name
        updateCurrentTabName();

        // Populate tab menu
        renderTabMenu();

        // Position tab switcher based on current orientation
        if (window.handleTabSwitcherPosition) {
          window.handleTabSwitcherPosition();
        }
      }

      // Update the displayed current tab name
      function updateCurrentTabName() {
        const currentTabNameEl = document.getElementById("currentTabName");
        if (currentTabIndex >= 0 && currentTabIndex < tabsConfig.length) {
          currentTabNameEl.textContent = tabsConfig[currentTabIndex].tabName;
        }
      }

      // Render the tab menu items
      function renderTabMenu() {
        const tabMenu = document.getElementById("tabSwitcherMenu");
        tabMenu.innerHTML = "";

        for (let i = 0; i < tabsConfig.length; i++) {
          const tab = tabsConfig[i];
          const item = document.createElement("div");
          item.className = "tab-menu-item" + (i === currentTabIndex ? " active" : "");
          item.textContent = tab.tabName;
          item.onclick = function(e) {
            e.stopPropagation();
            console.log('üñ±Ô∏è Tab menu item clicked:', tab.tabName, 'index:', i);
            switchToTab(i);
          };
          tabMenu.appendChild(item);
        }
      }

      // Save current tab state before switching
      function saveCurrentTabState() {
        tabStates[currentTabIndex] = {
          navigationStack: [...navigationStack],
          currentLayerIndex: currentLayerIndex,
          currentView: currentView,
          currentDetailIndex: currentDetailIndex,
          currentDisplayedItems: [...currentDisplayedItems],
          searchQuery: searchQuery,
          activeFilters: {...activeFilters},
          sortField: sortField,
          sortOrder: sortOrder
        };

        console.log('üì¶ Saved state for tab', currentTabIndex, ':', tabStates[currentTabIndex]);
      }

      // Restore tab state after switching
      function restoreTabState(tabIndex) {
        if (tabStates[tabIndex]) {
          const state = tabStates[tabIndex];
          navigationStack = [...state.navigationStack];
          currentLayerIndex = state.currentLayerIndex;
          currentView = state.currentView;
          currentDetailIndex = state.currentDetailIndex;
          currentDisplayedItems = [...state.currentDisplayedItems];
          searchQuery = state.searchQuery || "";
          activeFilters = {...state.activeFilters} || {};
          sortField = state.sortField || "none";
          sortOrder = state.sortOrder || "asc";

          // Update search input
          document.getElementById("searchInput").value = searchQuery;

          console.log('üìÇ Restored state for tab', tabIndex, ':', state);
        } else {
          // No saved state - initialize fresh
          navigationStack = [];
          currentLayerIndex = -1;
          currentView = "list";
          currentDetailIndex = -1;
          currentDisplayedItems = [];
          searchQuery = "";
          activeFilters = {};
          sortField = "none";
          sortOrder = "asc";

          document.getElementById("searchInput").value = "";

          console.log('üÜï No saved state for tab', tabIndex, '- initializing fresh');
        }
      }

      // Switch to a different tab
      function switchToTab(newTabIndex) {
        console.log('üîÑ switchToTab called: newTabIndex=', newTabIndex, 'currentTabIndex=', currentTabIndex);

        if (newTabIndex === currentTabIndex) {
          // Same tab - just close the menu
          console.log('üìå Same tab selected, just closing menu');
          toggleTabMenu();
          return;
        }

        console.log('üîÑ Switching from tab', currentTabIndex, 'to tab', newTabIndex);

        try {
          // Save current tab state
          saveCurrentTabState();

          // Update current tab index
          currentTabIndex = newTabIndex;

          // Close the tab menu
          toggleTabMenu();

          // Load data for the new tab
          loadTabData(newTabIndex);
        } catch (error) {
          console.error('‚ùå Error in switchToTab:', error);
          showToast('Error switching tabs: ' + error.message, 'error');
        }
      }

      // Load data for a specific tab
      function loadTabData(tabIndex) {
        const token = getSessionToken();
        const tab = tabsConfig[tabIndex];

        console.log('üì• Loading data for tab:', tab.tabName);

        // Check if we have cached data for this tab
        if (tabDataCache[tabIndex]) {
          console.log('‚ö° Using cached data for tab:', tab.tabName);

          // Restore from cache
          const cachedData = tabDataCache[tabIndex];
          layerConfig = cachedData.layerConfig || [];
          layersData = cachedData.layersData || {};
          allItems = cachedData.items || [];
          columnConfig = cachedData.columnConfig || [];
          headers = cachedData.headers || [];

          // Restore settings if cached (includes tab-specific Type/Style)
          if (cachedData.settings) {
            settings = cachedData.settings;
            // Re-initialize display view types and styles from the cached settings
            initializeDisplayViewType();
            console.log('‚úÖ View types and styles restored from cache for tab:', tab.tabName);
          }

          // Initialize column configuration
          loadColumnConfig();
          computeUniqueValues(); // Will use cached unique values

          // Restore tab state or navigate to home
          restoreTabState(tabIndex);

          // Render the view based on restored state
          renderTabView();

          // Update UI
          updateCurrentTabName();
          renderTabMenu();
          updateBreadcrumb();
          updateChipsUI();
          updateFilterSortVisibility();

          return;
        }

        // No cache - need to fetch from backend
        console.log('üîë Session token:', token ? '(exists)' : '(missing)');
        console.log('üìã Tab config:', {
          layersSheetName: tab.layersSheetName,
          mainSheetName: tab.mainSheetName,
          columnConfigSheetName: tab.columnConfigSheetName
        });

        // Show loading indicator
        const gridView = document.getElementById("gridView");
        const detailView = document.getElementById("detailView");
        gridView.innerHTML = '<div style="text-align: center; padding: 60px; color: #9ca3af;">Loading...</div>';
        detailView.innerHTML = "";
        detailView.style.display = "none";

        // Call backend to get tab-specific data
        google.script.run
          .withSuccessHandler(function(tabData) {
            console.log('‚úÖ Tab data loaded for:', tab.tabName);

            // Update app data with tab-specific configuration
            layerConfig = tabData.layerConfig || [];
            layersData = tabData.layersData || {};
            allItems = tabData.items || [];
            columnConfig = tabData.columnConfig || [];
            headers = tabData.headers || [];

            // Update settings if provided (includes tab-specific Type/Style)
            if (tabData.settings) {
              settings = tabData.settings;
              // Re-initialize display view types and styles from the tab-specific settings
              initializeDisplayViewType();
              console.log('‚úÖ View types and styles updated for tab:', tab.tabName);
            }

            // Cache the data for future use
            tabDataCache[tabIndex] = {
              layerConfig: layerConfig,
              layersData: layersData,
              items: allItems,
              columnConfig: columnConfig,
              headers: headers,
              settings: tabData.settings
            };

            // Initialize column configuration
            loadColumnConfig();
            computeUniqueValues(); // Will compute and cache unique values

            // Restore tab state or navigate to home
            restoreTabState(tabIndex);

            // Render the view based on restored state
            renderTabView();

            // Update UI
            updateCurrentTabName();
            renderTabMenu();
            updateBreadcrumb();
            updateChipsUI();
            updateFilterSortVisibility();
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Error loading tab data:', error);
            console.error('‚ùå Error details:', {
              message: error.message,
              token: token ? '(exists)' : '(missing)',
              tabName: tab.tabName,
              tabConfig: tab
            });

            // If authentication error and we're in a mode that supports public access, reload the page
            if (error.message && error.message.includes('Authentication required')) {
              showToast('Session expired. Please refresh the page.', 'error');
            } else {
              showToast('Error loading tab data: ' + error.message, 'error');
            }

            gridView.innerHTML = '<div style="text-align: center; padding: 60px; color: #ef4444;">Error loading data</div>';
          })
          .getTabData(tab.layersSheetName, tab.mainSheetName, tab.columnConfigSheetName, token);
      }

      // Cache initial tab data (tab 0) that was loaded via getInitialData
      function cacheInitialTabData() {
        if (tabsConfig.length === 0) return;

        // Store initial tab data in cache so switching back is instant
        tabDataCache[0] = {
          layerConfig: layerConfig,
          layersData: layersData,
          items: allItems,
          columnConfig: columnConfig,
          headers: headers,
          settings: settings
        };
        console.log('üíæ Initial tab (tab 0) cached for instant switching');
      }

      // Preload other tabs in background for instant switching
      function preloadOtherTabs() {
        if (tabsConfig.length <= 1) return;

        console.log('üîÑ Starting background preload for', tabsConfig.length - 1, 'other tab(s)...');

        const token = getSessionToken();
        let preloadedCount = 0;

        // Preload tabs 1, 2, 3... (skip tab 0 which is already loaded)
        for (let i = 1; i < tabsConfig.length; i++) {
          const tabIndex = i;
          const tab = tabsConfig[tabIndex];

          // Skip if already cached
          if (tabDataCache[tabIndex]) {
            console.log('‚ö° Tab', tabIndex, '(' + tab.tabName + ') already cached');
            preloadedCount++;
            continue;
          }

          // Fetch tab data in background
          google.script.run
            .withSuccessHandler(function(tabData) {
              // Store in cache
              tabDataCache[tabIndex] = {
                layerConfig: tabData.layerConfig || [],
                layersData: tabData.layersData || {},
                items: tabData.items || [],
                columnConfig: tabData.columnConfig || [],
                headers: tabData.headers || [],
                settings: tabData.settings
              };
              preloadedCount++;
              console.log('‚úÖ Preloaded tab', tabIndex, '(' + tab.tabName + ') -', preloadedCount, 'of', tabsConfig.length - 1, 'done');
            })
            .withFailureHandler(function(error) {
              console.warn('‚ö†Ô∏è Failed to preload tab', tabIndex, '(' + tab.tabName + '):', error.message);
            })
            .getTabData(tab.layersSheetName, tab.mainSheetName, tab.columnConfigSheetName, token);
        }
      }

      // Helper function to render the current tab view
      function renderTabView() {
        if (currentView === "detail" && currentDetailIndex >= 0 && currentDisplayedItems[currentDetailIndex]) {
          showDetails(currentDisplayedItems[currentDetailIndex], currentDetailIndex);
        } else if (currentView === "layer" && currentLayerIndex >= 0) {
          // Reconstruct layer view from navigation stack
          if (navigationStack.length > 0) {
            const lastNav = navigationStack[navigationStack.length - 1];
            const parentFilter = navigationStack.length >= 2
              ? navigationStack[navigationStack.length - 2].itemName
              : null;
            renderLayerView(lastNav.layerIndex, parentFilter);
          } else {
            renderLayerView(currentLayerIndex, null);
          }
        } else {
          // Navigate to home (Layer 1 or main list)
          navigateToHome();
        }
      }

      // Toggle tab switcher menu
      function toggleTabMenu() {
        const menu = document.getElementById("tabSwitcherMenu");
        menu.classList.toggle("show");
      }

      function showDetails(item, index) {
        const det = document.getElementById("detailView");
        const grid = document.getElementById("gridView");
        det.style.display = "block";
        grid.innerHTML = "";

        // Reset table-specific header widths when entering detail view
        if (typeof resetTableWidths === 'function') {
          resetTableWidths();
        }

        // Set data attribute for portrait side-by-side layout ONLY when Type=Table AND Style=Open Detail View
        const viewType = getMainViewType();
        const style = getMainStyle();
        if (viewType === 'table' && style === 'Open Detail View') {
          det.setAttribute('data-table-open-detail', 'true');
        } else {
          det.removeAttribute('data-table-open-detail');
        }

        // Store current detail index for navigation
        if (index !== undefined) {
          currentDetailIndex = index;
        }

        // Update navigation state and push history for back button
        currentView = "detail";
        history.pushState({ view: "detail", index: index }, "", "");

        // Show back button only if no layers (breadcrumb handles navigation when layers exist)
        if (layerConfig.length === 0) {
          document.getElementById("backToListBtn").style.display = "inline-flex";
        } else {
          document.getElementById("backToListBtn").style.display = "none";
        }
        document.getElementById("filterWrapper").style.display = "none";
        document.getElementById("sortWrapper").style.display = "none";

        // Add 'no-image' class if there's no image
        const hasImage = imageColumn && item[imageColumn.columnName];
        const detailLayoutClass = hasImage ? 'detail-layout' : 'detail-layout no-image';

        let html =
          '<div class="' + detailLayoutClass + '">' +
          '<button id="prevItemBtn" class="nav-arrow-btn nav-arrow-left" onclick="navigateToPrevious()" title="Previous item">&lt;</button>' +
          '<button id="nextItemBtn" class="nav-arrow-btn nav-arrow-right" onclick="navigateToNext()" title="Next item">&gt;</button>' +
          '<div id="detailImgContainer">';

        if (hasImage) {
          html += '<div class="detail-img-wrapper" id="detailImgWrapper"></div>';
        } else {
          html += '<div class="detail-img-wrapper"></div>';
        }

        html +=
          "</div>" +
          '<div id="detailContentContainer">' +
          '<div class="detail-title-row">' +
          '<div class="detail-name">' +
          (nameColumn ? (item[nameColumn.columnName] || "") : "") +
          "</div>" +
          "</div>";

        // Add SubID1 and SubID2 under the Primary Identifier (like in card view)
        const subBits = [];
        if (categoryColumn && item[categoryColumn.columnName]) subBits.push(item[categoryColumn.columnName]);
        if (placeColumn && item[placeColumn.columnName]) subBits.push(item[placeColumn.columnName]);

        if (subBits.length > 0) {
          html += '<div class="detail-subtitle">' +
            subBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Top Corner fields - collect all values with same styling as SubId
        const topCornerBits = [];
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "topcorner") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            topCornerBits.push(displayVal);
          }
        }

        if (topCornerBits.length > 0) {
          html += '<div class="detail-topcorner" style="position: absolute; top: 4px; right: 16px;">' +
            topCornerBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Long text Up fields (before two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextup") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field" style="margin-top: 16px;">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }

        // Create two-column layout for detail fields
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; background: #e2e8f0; padding: 20px; border-radius: 12px; border: 1px solid #cbd5e1;">';

        // Left column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailleft") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        // Right column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailright") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        html += '</div>'; // Close grid

        // Long text Down fields (after two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextdown") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink" || config.specialRole === "formulaexternallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field" style="margin-top: 16px;">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }

        // External Link fields that don't have an itemPlace (special role only)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.specialRole !== "externallink" && config.specialRole !== "formulaexternallink") continue;
          // Skip if it already has an itemPlace and was rendered above
          if (config.itemPlace && config.itemPlace !== "") continue;

          const url = item[config.columnName];
          if (url && String(url).trim() !== "") {
            const linkLabel = config.displayName || config.columnName;
            html +=
              '<div class="detail-field" style="margin-top: 12px;">' +
              '<a href="' +
              url +
              '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
              "üîó " + linkLabel +
              "</a>" +
              "</div>";
          }
        }

        // Bottom fields (like "Added by" placement)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "bottom") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            html +=
              '<div class="detail-field" style="margin-top:10px;font-size:11px;color:#9ca3af;">' +
              displayVal +
              "</div>";
          }
        }

        if (user && user.profile !== "Viewer") {
          const editable = canEditItem(item);
          const deletable = canDeleteItem(item);

          if (editable || deletable) {
            html += '<div class="detail-actions">';
            if (editable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-secondary" onclick="openEdit(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">‚úè Edit</button>";
            }
            if (deletable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-danger" onclick="confirmDelete(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">üóë Delete</button>";
            }
            html += "</div>";
          }
        }

        html += "</div></div>";
        det.innerHTML = html;

        // Update navigation button visibility
        updateNavigationButtons();

        // Load detail image with progressive loading
        const imgWrapper = document.getElementById("detailImgWrapper");
        if (imgWrapper && imageColumn && item[imageColumn.columnName]) {
          const rawUrl = item[imageColumn.columnName];
          const fileId = extractDriveFileId(rawUrl);

          if (fileId) {
            loadDetailImage(fileId, imgWrapper);
          } else if (rawUrl) {
            loadDetailImageDirect(rawUrl, imgWrapper);
          }
        }
      }

      // Navigate to next item in detail view
      function navigateToNext() {
        if (currentDetailIndex < 0 || currentDetailIndex >= currentDisplayedItems.length - 1) {
          return; // Already at last item or invalid index
        }
        const nextIndex = currentDetailIndex + 1;
        const nextItem = currentDisplayedItems[nextIndex];
        showDetails(nextItem, nextIndex);
      }

      // Navigate to previous item in detail view
      function navigateToPrevious() {
        if (currentDetailIndex <= 0) {
          return; // Already at first item or invalid index
        }
        const prevIndex = currentDetailIndex - 1;
        const prevItem = currentDisplayedItems[prevIndex];
        showDetails(prevItem, prevIndex);
      }

      // Update navigation button visibility based on current position
      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevItemBtn");
        const nextBtn = document.getElementById("nextItemBtn");

        if (!prevBtn || !nextBtn) return;

        // Hide previous button if at first item
        if (currentDetailIndex <= 0) {
          prevBtn.style.display = "none";
        } else {
          prevBtn.style.display = "flex";
        }

        // Hide next button if at last item
        if (currentDetailIndex >= currentDisplayedItems.length - 1) {
          nextBtn.style.display = "none";
        } else {
          nextBtn.style.display = "flex";
        }
      }

      // Swipe detection for mobile navigation
      let touchStartX = 0;
      let touchEndX = 0;
      let touchStartY = 0;
      let touchEndY = 0;

      function initializeSwipeDetection() {
        const detailView = document.getElementById("detailView");
        if (!detailView) return;

        detailView.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        detailView.addEventListener('touchend', function(e) {
          touchEndX = e.changedTouches[0].screenX;
          touchEndY = e.changedTouches[0].screenY;
          handleSwipe();
        }, { passive: true });
      }

      function handleSwipe() {
        // Don't navigate if image viewer is open
        if (imageZoomState.isOpen) {
          return;
        }

        const swipeThreshold = 50; // Minimum distance for swipe
        const swipeDistanceX = touchEndX - touchStartX;
        const swipeDistanceY = touchEndY - touchStartY;

        // Only trigger if horizontal swipe is more dominant than vertical
        if (Math.abs(swipeDistanceX) > Math.abs(swipeDistanceY)) {
          if (Math.abs(swipeDistanceX) > swipeThreshold) {
            if (swipeDistanceX < 0) {
              // Swiped left - go to next
              navigateToNext();
            } else {
              // Swiped right - go to previous
              navigateToPrevious();
            }
          }
        }
      }

      // Load detail view image with progressive loading and fullscreen capability
      async function loadDetailImage(fileId, wrapper) {
        try {
          // Check caches
          if (memoryCache.has(fileId)) {
            const cached = memoryCache.get(fileId);
            applyDetailProgressiveImage(wrapper, cached.thumbnail, cached.full);
            return;
          }

          const dbCached = await imageCacheDB.get(fileId);
          if (dbCached && dbCached.full) {
            memoryCache.set(fileId, {
              full: dbCached.full,
              thumbnail: dbCached.thumbnail
            });
            applyDetailProgressiveImage(wrapper, dbCached.thumbnail, dbCached.full);
            return;
          }

          // If not cached, it should already be in memory from grid view
          // But fetch anyway as fallback
          // For GitHub Pages deployment, use API_CONFIG.APPS_SCRIPT_URL
          // For Apps Script deployment, use imageProxyBaseUrl from settings
          const base = (window.API_CONFIG && window.API_CONFIG.APPS_SCRIPT_URL &&
                       window.API_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE')
                       ? window.API_CONFIG.APPS_SCRIPT_URL.replace(/\/exec$/, '/exec')
                       : (imageProxyBaseUrl || "");
          const url = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

          const response = await fetch(url);
          const json = await response.json();

          if (!json.ok) return;

          const fullDataUrl = "data:" + json.mime + ";base64," + json.data;
          const thumbnailDataUrl = await generateThumbnail(fullDataUrl);

          memoryCache.set(fileId, {
            full: fullDataUrl,
            thumbnail: thumbnailDataUrl
          });
          
          await imageCacheDB.set(fileId, fullDataUrl, thumbnailDataUrl);

          applyDetailProgressiveImage(wrapper, thumbnailDataUrl, fullDataUrl);

        } catch (err) {
          console.error("Detail image load error:", err);
        }
      }

      function applyDetailProgressiveImage(wrapper, thumbnailUrl, fullUrl) {
        wrapper.innerHTML = '';

        if (thumbnailUrl) {
          const placeholder = document.createElement('img');
          placeholder.className = 'detail-img placeholder';
          placeholder.src = thumbnailUrl;
          wrapper.appendChild(placeholder);
        }

        const fullImg = document.createElement('img');
        fullImg.className = 'detail-img full';
        fullImg.onload = () => {
          fullImg.classList.add('loaded');
          // Remove placeholder after full image loads
          setTimeout(() => {
            const placeholders = wrapper.querySelectorAll('.placeholder');
            placeholders.forEach(p => p.remove());
          }, 400);
        };
        fullImg.src = fullUrl;
        fullImg.style.cursor = 'zoom-in';
        fullImg.onclick = () => openImageFullscreen(fullUrl);
        wrapper.appendChild(fullImg);
      }

      function loadDetailImageDirect(url, wrapper) {
        wrapper.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'detail-img full loaded';
        img.src = url;
        img.style.cursor = 'zoom-in';
        img.onclick = () => openImageFullscreen(url);
        wrapper.appendChild(img);
      }

      function backToList() {
        document.getElementById("detailView").style.display = "none";

        // Reset table widths when navigating back
        if (typeof resetTableWidths === 'function') {
          resetTableWidths();
        }

        // Check if we're in layer navigation
        if (navigationStack.length > 0 || currentLayerIndex >= 0) {
          // Navigate back through layers
          backFromLayer();
          return;
        }

        // Update navigation state
        currentView = "list";

        // Hide back button, show filter/sort only if columns configured
        document.getElementById("backToListBtn").style.display = "none";
        updateFilterSortVisibility();

        applyFiltersAndSorting();
      }

      function clearSearch() {
        searchQuery = "";
        document.getElementById("searchInput").value = "";
        document.getElementById("clearSearchBtn").style.display = "none";

        // Restore pre-search state
        restorePreSearchState();
      }

      // Restore navigation state from before search
      function restorePreSearchState() {
        if (layerConfig.length === 0) {
          // No layers - just show all items
          applyFiltersAndSorting();
          return;
        }

        // Restore layer navigation state
        navigationStack = [...preSearchNavigationStack];
        currentLayerIndex = preSearchLayerIndex;
        currentView = preSearchView;

        if (currentView === "detail" && preSearchDetailItem) {
          // Restore detail view - first restore the list, then show detail
          if (navigationStack.length > 0) {
            // Was viewing detail from filtered list
            const lastNav = navigationStack[navigationStack.length - 1];
            showMainItemsFilteredByLayer(lastNav.layerIndex, lastNav.itemName);
          } else {
            // Was viewing detail from home layer
            navigateToHome();
          }
          // Show the detail view after a brief delay to let list render
          setTimeout(() => {
            showDetails(preSearchDetailItem, preSearchDetailIndex);
          }, 50);
        } else if (currentView === "layer") {
          // Restore layer view
          const parentFilter = navigationStack.length > 0
            ? navigationStack[navigationStack.length - 1].itemName
            : null;
          renderLayerView(currentLayerIndex, parentFilter);
          updateLayerNavigationUI();
        } else if (currentView === "list" && navigationStack.length > 0) {
          // Restore filtered list from layer
          const lastNav = navigationStack[navigationStack.length - 1];
          showMainItemsFilteredByLayer(lastNav.layerIndex, lastNav.itemName);
        } else {
          // No saved state - go to home
          navigateToHome();
        }
      }

      // -------------------- Fullscreen viewer --------------------

      // -------------------- Image Zoom State --------------------

      let imageZoomState = {
        scale: 1,
        translateX: 0,
        translateY: 0,
        initialDistance: 0,
        initialScale: 1,
        lastTap: 0,
        isOpen: false,
        openedFromDetailView: false
      };

      function resetImageZoom() {
        const transform = document.getElementById("imgOverlayTransform");
        if (!transform) return;
        imageZoomState = {
          scale: 1,
          translateX: 0,
          translateY: 0,
          initialDistance: 0,
          initialScale: 1,
          lastTap: 0,
          isOpen: imageZoomState.isOpen,
          openedFromDetailView: imageZoomState.openedFromDetailView
        };
        transform.style.transform = "scale(1) translate(0, 0)";
        transform.style.transition = "transform 0.3s ease";
      }

      function applyImageTransform(smooth = false) {
        const transform = document.getElementById("imgOverlayTransform");
        if (!transform) return;

        // Constrain scale between 1x and 5x
        imageZoomState.scale = Math.max(1, Math.min(5, imageZoomState.scale));

        if (imageZoomState.scale === 1) {
          imageZoomState.translateX = 0;
          imageZoomState.translateY = 0;
        } else {
          // Constrain panning to prevent empty space around image
          const img = document.getElementById("imgOverlayImg");
          if (img && img.complete) {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Get the natural/original dimensions of the image
            // Calculate how the image is displayed (maintaining aspect ratio)
            const imgAspect = img.naturalWidth / img.naturalHeight;
            const viewportAspect = viewportWidth / viewportHeight;

            let baseWidth, baseHeight;
            if (imgAspect > viewportAspect) {
              // Image is wider - width constrained
              baseWidth = Math.min(img.naturalWidth, viewportWidth);
              baseHeight = baseWidth / imgAspect;
            } else {
              // Image is taller - height constrained
              baseHeight = Math.min(img.naturalHeight, viewportHeight);
              baseWidth = baseHeight * imgAspect;
            }

            // Calculate the scaled dimensions using the base size
            const scaledWidth = baseWidth * imageZoomState.scale;
            const scaledHeight = baseHeight * imageZoomState.scale;

            // Calculate maximum allowed translation
            // When zoomed, we can pan by half the difference between scaled size and viewport
            const maxTranslateX = Math.max(0, (scaledWidth - viewportWidth) / (2 * imageZoomState.scale));
            const maxTranslateY = Math.max(0, (scaledHeight - viewportHeight) / (2 * imageZoomState.scale));

            // Constrain translation within bounds
            imageZoomState.translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, imageZoomState.translateX));
            imageZoomState.translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, imageZoomState.translateY));
          }
        }

        if (smooth) {
          transform.style.transition = "transform 0.3s ease";
        } else {
          transform.style.transition = "none";
        }

        transform.style.transform = `scale(${imageZoomState.scale}) translate(${imageZoomState.translateX}px, ${imageZoomState.translateY}px)`;

        // Update cursor based on zoom level
        transform.style.cursor = imageZoomState.scale > 1 ? "grab" : "zoom-in";
      }

      function getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function setupImageZoom() {
        const transform = document.getElementById("imgOverlayTransform");
        if (!transform) return;

        // Pinch zoom handling
        transform.addEventListener("touchstart", (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            imageZoomState.initialDistance = getDistance(e.touches[0], e.touches[1]);
            imageZoomState.initialScale = imageZoomState.scale;
          } else if (e.touches.length === 1) {
            // Check for double-tap
            const now = Date.now();
            const timeSinceLastTap = now - imageZoomState.lastTap;

            if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
              e.preventDefault();
              // Double-tap detected - toggle zoom
              if (imageZoomState.scale > 1) {
                imageZoomState.scale = 1;
              } else {
                imageZoomState.scale = 2.5;
              }
              applyImageTransform(true);
            }

            imageZoomState.lastTap = now;
          }
        });

        transform.addEventListener("touchmove", (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = getDistance(e.touches[0], e.touches[1]);
            const scaleDelta = currentDistance / imageZoomState.initialDistance;
            imageZoomState.scale = imageZoomState.initialScale * scaleDelta;
            applyImageTransform(false);
          } else if (e.touches.length === 1 && imageZoomState.scale > 1) {
            // Allow panning when zoomed in
            e.preventDefault();
            const touch = e.touches[0];
            const movementX = e.touches[0].clientX - (imageZoomState.lastTouchX || touch.clientX);
            const movementY = e.touches[0].clientY - (imageZoomState.lastTouchY || touch.clientY);

            imageZoomState.translateX += movementX / imageZoomState.scale;
            imageZoomState.translateY += movementY / imageZoomState.scale;

            imageZoomState.lastTouchX = touch.clientX;
            imageZoomState.lastTouchY = touch.clientY;

            applyImageTransform(false);
          }
        });

        transform.addEventListener("touchend", (e) => {
          if (e.touches.length < 2) {
            imageZoomState.initialDistance = 0;
            imageZoomState.lastTouchX = null;
            imageZoomState.lastTouchY = null;
          }

          // Reset to 1x if zoomed out too far
          if (imageZoomState.scale < 1) {
            imageZoomState.scale = 1;
            applyImageTransform(true);
          }
        });

        // Desktop: Mouse wheel zoom
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        transform.addEventListener("wheel", (e) => {
          e.preventDefault();

          // Zoom in/out with mouse wheel
          const zoomSpeed = 0.1;
          if (e.deltaY < 0) {
            // Scroll up - zoom in
            imageZoomState.scale += zoomSpeed;
          } else {
            // Scroll down - zoom out
            imageZoomState.scale -= zoomSpeed;
          }

          applyImageTransform(true);
        }, { passive: false });

        // Desktop: Click and drag to pan
        transform.addEventListener("mousedown", (e) => {
          if (imageZoomState.scale > 1) {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            transform.style.cursor = "grabbing";
            e.preventDefault();
          }
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging && imageZoomState.scale > 1) {
            const movementX = e.clientX - dragStartX;
            const movementY = e.clientY - dragStartY;

            imageZoomState.translateX += movementX / imageZoomState.scale;
            imageZoomState.translateY += movementY / imageZoomState.scale;

            dragStartX = e.clientX;
            dragStartY = e.clientY;

            applyImageTransform(false);
          }
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            const transform = document.getElementById("imgOverlayTransform");
            if (transform) {
              transform.style.cursor = imageZoomState.scale > 1 ? "grab" : "zoom-in";
            }
          }
        });
      }

      function openImageFullscreen(src) {
        const overlay = document.getElementById("imgOverlay");
        const img = document.getElementById("imgOverlayImg");
        if (!overlay || !img || !src) return;
        img.src = src;
        overlay.style.display = "flex";
        // Prevent background scrolling when fullscreen viewer is open
        document.body.style.overflow = "hidden";
        // Reset zoom state for new image
        resetImageZoom();

        // Track that viewer is open and where it was opened from
        imageZoomState.isOpen = true;
        imageZoomState.openedFromDetailView = (currentView === "detail");

        // On mobile devices, push history state when opened from detail view
        // This allows the back button to close the enlarged image
        const isMobile = document.body.classList.contains('mobile-device') ||
                        document.body.classList.contains('tablet-device');
        if (isMobile && currentView === "detail") {
          history.pushState({ view: "imageViewer" }, "", "");
        }
      }

      function closeImageFullscreen(fromBackButton = false) {
        const overlay = document.getElementById("imgOverlay");
        if (overlay) overlay.style.display = "none";
        // Restore scrolling when fullscreen viewer is closed
        document.body.style.overflow = "";

        // Track that viewer is closed
        const wasOpen = imageZoomState.isOpen;
        const wasFromDetail = imageZoomState.openedFromDetailView;
        imageZoomState.isOpen = false;
        imageZoomState.openedFromDetailView = false;

        // Reset zoom state
        resetImageZoom();

        // If viewer was opened from detail view on mobile and we're NOT already handling back button
        // Then we need to go back to remove the imageViewer history state
        const isMobile = document.body.classList.contains('mobile-device') ||
                        document.body.classList.contains('tablet-device');
        if (!fromBackButton && wasOpen && wasFromDetail && isMobile) {
          history.back();
        }
      }

      // -------------------- Filter & Sort Dropdowns --------------------

      function populateFilterDropdown() {
        const filterDropdown = document.getElementById("filterDropdown");
        filterDropdown.innerHTML = "";

        // Generate filter sections for each filter column
        for (let i = 0; i < filterColumns.length; i++) {
          const config = filterColumns[i];
          if (!config.uniqueValues || config.uniqueValues.length === 0) continue;

          // Create section
          const section = document.createElement("div");
          section.className = "dropdown-section";

          const title = document.createElement("div");
          title.className = "dropdown-section-title";
          title.textContent = config.displayName || config.columnName;
          section.appendChild(title);

          const listContainer = document.createElement("div");

          config.uniqueValues.forEach(value => {
            const item = document.createElement("div");
            item.className = "dropdown-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "filter_" + config.columnName + "_" + value.replace(/\s/g, '_');
            checkbox.value = value;

            const selected = filterValues[config.columnName] || [];
            checkbox.checked = selected.indexOf(value) !== -1;

            checkbox.onchange = (e) => {
              e.stopPropagation();
              if (!filterValues[config.columnName]) {
                filterValues[config.columnName] = [];
              }

              const idx = filterValues[config.columnName].indexOf(value);
              if (checkbox.checked) {
                // Add to selection if not already there
                if (idx === -1) {
                  filterValues[config.columnName].push(value);
                }
              } else {
                // Remove from selection
                if (idx !== -1) {
                  filterValues[config.columnName].splice(idx, 1);
                }
              }

              updateChipsUI();
              applyFiltersAndSorting();
            };

            const label = document.createElement("span");
            label.textContent = value;

            item.onclick = (e) => {
              if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.onchange(e);
              }
            };

            item.appendChild(checkbox);
            item.appendChild(label);
            listContainer.appendChild(item);
          });

          section.appendChild(listContainer);
          filterDropdown.appendChild(section);
        }

        // Add divider and clear button
        if (filterColumns.length > 0) {
          const divider = document.createElement("div");
          divider.className = "dropdown-divider";
          filterDropdown.appendChild(divider);

          const actions = document.createElement("div");
          actions.className = "dropdown-actions";

          const clearBtn = document.createElement("button");
          clearBtn.className = "dropdown-btn";
          clearBtn.textContent = "Clear Filters";
          clearBtn.onclick = () => {
            filterValues = {};
            for (let i = 0; i < filterColumns.length; i++) {
              filterValues[filterColumns[i].columnName] = [];
            }
            populateFilterDropdown();
            updateChipsUI();
            applyFiltersAndSorting();
          };

          actions.appendChild(clearBtn);
          filterDropdown.appendChild(actions);
        }
      }

      function populateSortDropdown() {
        const sortDropdown = document.getElementById("sortDropdown");
        const firstSection = sortDropdown.querySelector(".dropdown-section");

        // Rebuild sort options based on showInSort configuration
        firstSection.innerHTML = '<div class="dropdown-section-title">Sort by</div>';

        // Always include "No sorting"
        const noneItem = document.createElement("div");
        noneItem.className = "dropdown-item";
        noneItem.dataset.sort = "none";
        const noneRadio = document.createElement("input");
        noneRadio.type = "radio";
        noneRadio.name = "sortField";
        noneRadio.value = "none";
        noneRadio.checked = sortField === "none";
        const noneLabel = document.createElement("span");
        noneLabel.textContent = "No sorting";
        noneItem.appendChild(noneRadio);
        noneItem.appendChild(noneLabel);
        firstSection.appendChild(noneItem);

        // Add sort options for columns with showInSort = true
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (!config.showInSort) continue;

          // Check if column has any values
          if (!isColumnUsed(config.columnName)) continue;

          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.dataset.sort = config.columnName;

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "sortField";
          radio.value = config.columnName;
          radio.checked = sortField === config.columnName;

          const label = document.createElement("span");
          label.textContent = config.displayName || config.columnName;

          item.appendChild(radio);
          item.appendChild(label);
          firstSection.appendChild(item);
        }

        // Re-attach event listeners for sort field
        firstSection.querySelectorAll('input[name="sortField"]').forEach(radio => {
          radio.onchange = function() {
            sortField = this.value;

            // Hide Order section when "No sorting" is selected, SHOW when sorting is active
            const orderDivider = sortDropdown.querySelector('.dropdown-divider');
            const orderSection = sortDropdown.querySelectorAll('.dropdown-section')[1]; // Second section is Order

            if (sortField === 'none') {
              if (orderDivider) orderDivider.style.display = 'none';
              if (orderSection) orderSection.style.display = 'none';
            } else {
              // EXPLICITLY show - set to 'block' to ensure visibility
              if (orderDivider) {
                orderDivider.style.display = 'block';
                orderDivider.style.visibility = 'visible';
                orderDivider.style.opacity = '1';
              }
              if (orderSection) {
                orderSection.style.display = 'block';
                orderSection.style.visibility = 'visible';
                orderSection.style.opacity = '1';
              }
            }

            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        firstSection.querySelectorAll('.dropdown-item').forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });

        // Re-attach event listeners for sort order
        const orderRadios = sortDropdown.querySelectorAll('input[name="sortOrder"]');
        orderRadios.forEach(radio => {
          radio.onchange = function() {
            sortOrder = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        const orderItems = sortDropdown.querySelectorAll('[data-order]');
        orderItems.forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });
      }

      function toggleDropdown(dropdownId, buttonId) {
        const dropdown = document.getElementById(dropdownId);
        const isShowing = dropdown.classList.contains("show");
        
        // Close all dropdowns first
        document.querySelectorAll(".dropdown-menu").forEach(d => {
          d.classList.remove("show");
        });
        
        // Toggle current dropdown
        if (!isShowing) {
          dropdown.classList.add("show");

          // Populate filter dropdown when opened
          if (dropdownId === "filterDropdown") {
            // If in layer view, recompute unique values from current layer items
            if (currentView === "layer" && currentLayerIndex >= 0 && currentLayerIndex < layerConfig.length) {
              const layerName = layerConfig[currentLayerIndex].layerName;
              const parentFilterName = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].itemName : null;
              const layerItems = getFilteredLayerItems(layerName, parentFilterName);
              computeUniqueValues(layerItems);
            } else if (navigationStack.length > 0 && currentDisplayedItems && currentDisplayedItems.length > 0) {
              // If we navigated through layers and viewing filtered Main items, use currentDisplayedItems
              computeUniqueValues(currentDisplayedItems);
            } else {
              // Otherwise use all items
              computeUniqueValues(allItems);
            }
            populateFilterDropdown();
          }

          // Populate sort dropdown when opened
          if (dropdownId === "sortDropdown") {
            populateSortDropdown();
          }
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function(e) {
        if (!e.target.closest(".btn-toolbar") && !e.target.closest(".dropdown-menu")) {
          document.querySelectorAll(".dropdown-menu").forEach(d => {
            d.classList.remove("show");
          });
        }
      });



      // -------------------- Add / Edit / Delete Items --------------------

      function openAdd() {
        editingItemName = null;
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const body = document.getElementById("editModalBody");
        title.textContent = "Add item";
        body.innerHTML = "";

        // Show only columns that are not "addedby" or "formula" (read-only)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];

          // Skip auto-filled and read-only columns
          if (config.specialRole === "addedby" || config.specialRole === "formula" || config.specialRole === "formulaexternallink") {
            continue;
          }

          let val = "";
          // Pre-fill if single filter value selected
          if (filterValues[config.columnName] && filterValues[config.columnName].length === 1) {
            val = filterValues[config.columnName][0];
          }

          const displayName = config.displayName || config.columnName;
          const inputType = config.type === "date" ? "date" : "text";
          body.innerHTML +=
            "<label>" +
            displayName +
            "</label>" +
            '<input type="' + inputType + '" id="field_' +
            config.columnName +
            '" value="' +
            (val || "") +
            '" data-column="' +
            config.columnName +
            '" placeholder="' + (config.type === "date" ? "" : "Enter " + displayName.toLowerCase()) + '">';
        }

        modal.style.display = "flex";
        document.getElementById("editSaveBtn").onclick = saveAddOrEdit;
      }

      function openEdit(name) {
        editingItemName = name;
        const token = getSessionToken();

        // Open modal immediately with loading state
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const body = document.getElementById("editModalBody");
        title.textContent = "Edit item";
        body.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Loading...</div>';
        modal.style.display = "flex";

        // Fetch data
        google.script.run
          .withSuccessHandler(function (item) {
            if (!item) {
              closeEditModal();
              showToast("Item not found.", "error");
              return;
            }

            body.innerHTML = "";

            // Show only columns that are not "addedby" or "formula" (read-only)
            for (let i = 0; i < columnConfig.length; i++) {
              const config = columnConfig[i];

              // Skip auto-filled and read-only columns
              if (config.specialRole === "addedby" || config.specialRole === "formula" || config.specialRole === "formulaexternallink") {
                continue;
              }

              let val = item[config.columnName] || "";
              const displayName = config.displayName || config.columnName;
              const inputType = config.type === "date" ? "date" : "text";

              // Format date for input[type="date"] (YYYY-MM-DD)
              if (config.type === "date" && val) {
                val = formatDateForInput(val);
              }

              body.innerHTML +=
                "<label>" +
                displayName +
                "</label>" +
                '<input type="' + inputType + '" id="field_' +
                config.columnName +
                '" value="' +
                String(val).replace(/"/g, "&quot;") +
                '" data-column="' +
                config.columnName +
                '" placeholder="' + (config.type === "date" ? "" : "Enter " + displayName.toLowerCase()) + '">';
            }

            document.getElementById("editSaveBtn").onclick = saveAddOrEdit;
          })
          .withFailureHandler(function(error) {
            closeEditModal();
            showToast("Error: " + error.message, "error");
          })
          .getItemByName(name, token, getCurrentMainSheetName(), getCurrentColumnConfigSheetName());
      }

      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function saveAddOrEdit() {
        const obj = {};
        const token = getSessionToken();

        // Collect values from all field inputs
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];

          // Skip auto-filled and read-only columns
          if (config.specialRole === "addedby" || config.specialRole === "formula" || config.specialRole === "formulaexternallink") {
            continue;
          }

          const el = document.getElementById("field_" + config.columnName);
          if (el) {
            obj[config.columnName] = el.value;
          }
        }

        if (!editingItemName) {
          // Adding new item
          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeEditModal();
              google.script.run
                .withSuccessHandler(function (data) {
                  allItems = data || [];
                  computeUniqueValues();
                  applyFiltersAndSorting();
                })
                .getMainData(getCurrentMainSheetName());
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .addMainRow(obj, token, getCurrentMainSheetName(), getCurrentColumnConfigSheetName());
        } else {
          // Editing existing item
          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeEditModal();
              google.script.run
                .withSuccessHandler(function (data) {
                  allItems = data || [];
                  computeUniqueValues();
                  applyFiltersAndSorting();
                })
                .getMainData(getCurrentMainSheetName());
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .editItem(editingItemName, obj, token, getCurrentMainSheetName());
        }
      }

      function confirmDelete(name) {
        showConfirm(
          "Delete Item",
          "Are you sure you want to delete this item? This action cannot be undone.",
          function() {
            const token = getSessionToken();

            google.script.run
              .withSuccessHandler(function (msg) {
                showToast(msg, "success");
                backToList();
                google.script.run
                  .withSuccessHandler(function (data) {
                    allItems = data || [];
                    computeUniqueValues();
                    applyFiltersAndSorting();
                  })
                  .getMainData(getCurrentMainSheetName());
              })
              .withFailureHandler(function(error) {
                showToast("Error: " + error.message, "error");
              })
              .deleteItem(name, token, getCurrentMainSheetName());
          }
        );
      }

      async function init() {
        console.log('=== App Initialization Starting ===');

        // Initialize IndexedDB
        try {
          await imageCacheDB.init();
          console.log('‚úì IndexedDB cache initialized');
        } catch (err) {
          console.warn('IndexedDB not available:', err);
        }

        // Setup lazy loading
        setupLazyLoading();

        // First, check app mode (public or private)
        google.script.run
          .withSuccessHandler(function (appSettings) {
            console.log('App mode:', appSettings.appMode);

            // Store app mode globally
            window.currentAppMode = appSettings.appMode;

            // If public mode (no login at all), skip login and load data directly
            if (appSettings.appMode === "Public all in Viewer") {
              console.log('Public mode - loading app without authentication...');
              loadPublicApp();
              return;
            }

            // If public with login option
            if (appSettings.appMode === "Public with Login") {
              console.log('Public with Login mode...');

              // Check if user has a session token (previously logged in)
              const token = getSessionToken();

              if (token) {
                console.log('Session token found - loading as authenticated user...');
                loadPrivateApp(token);
              } else {
                console.log('No session - loading as public viewer with login option...');
                loadPublicAppWithLoginOption();
              }
              return;
            }

            // Private mode - check for existing session
            const token = getSessionToken();

            // If no token, show login screen
            if (!token) {
              showLoginScreen();
              console.log('No session token - showing login screen');
              return;
            }

            console.log('Session token found - loading app...');
            loadPrivateApp(token);
          })
          .withFailureHandler(function(error) {
            console.error('Error checking app mode:', error);
            showToast('Error loading app settings', 'error');
          })
          .getSettings();
      }

      function loadPublicApp() {
        google.script.run
          .withSuccessHandler(function (payload) {
            user = payload.user;
            settings = payload.settings;
            headers = payload.headers || [];
            allItems = payload.items || [];
            columnConfig = payload.columnConfig || [];

            // Store layer configuration and data
            layerConfig = payload.layerConfig || [];
            layersData = payload.layersData || {};

            // Store tabs configuration (if available)
            tabsConfig = payload.tabsConfig || [];

            // Debug: Log layer data
            console.log('üìä Layer Config:', layerConfig);
            console.log('üìä Layers Data:', layersData);
            console.log('üìä Has Layers:', layerConfig.length > 0);
            console.log('üìë Tabs Config:', tabsConfig);
            console.log('üìë Has Tabs:', tabsConfig.length > 0);

            console.log('Public viewer loaded:', user.email, user.profile);

            if (settings) {
              // Use deployment URL from Settings C5
              imageProxyBaseUrl = settings.deploymentUrl || "";

              if (!imageProxyBaseUrl) {
                console.warn('‚ö†Ô∏è No deployment URL configured in Settings C5! Images may not load correctly.');
                console.warn('Please add your /exec URL to Settings sheet cell C5');
              } else {
                console.log('‚úì Image proxy URL set to:', imageProxyBaseUrl);
              }

              // Update app title
              if (settings.appName) {
                document.title = settings.appName;
                document.getElementById('loginAppName').textContent = settings.appName;
              }
            }

            // Initialize display view type
            initializeDisplayViewType();

            // Load column configuration
            loadColumnConfig();
            computeUniqueValues();
            updateHeaderUI();
            applyRoleVisibility();
            updateChipsUI();

            // Initialize tabs if configured
            initializeTabs();

            // Cache initial tab data and preload other tabs for instant switching
            cacheInitialTabData();
            preloadOtherTabs();

            // Show layers if configured, otherwise show main list
            navigateToHome();

            // Hide login screen and show app
            hideLoginScreen();

            // Hide loading screen - app is ready
            hideLoadingScreen();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading public app:', error);
            showToast('Error loading catalogue: ' + error.message, 'error');
          })
          .getInitialData(null);  // No token needed in public mode
      }

      function loadPublicAppWithLoginOption() {
        // Load app in public mode but keep login UI visible
        google.script.run
          .withSuccessHandler(function (payload) {
            user = payload.user;  // Will be null since no token
            settings = payload.settings;
            headers = payload.headers || [];
            allItems = payload.items || [];
            columnConfig = payload.columnConfig || [];

            // Store layer configuration and data
            layerConfig = payload.layerConfig || [];
            layersData = payload.layersData || {};

            // Store tabs configuration (if available)
            tabsConfig = payload.tabsConfig || [];

            // Debug: Log layer data
            console.log('üìä Layer Config:', layerConfig);
            console.log('üìä Layers Data:', layersData);
            console.log('üìä Has Layers:', layerConfig.length > 0);
            console.log('üìë Tabs Config:', tabsConfig);
            console.log('üìë Has Tabs:', tabsConfig.length > 0);

            // Setup image proxy if available
            if (settings && settings.deploymentUrl) {
              imageProxyBaseUrl = settings.deploymentUrl;

              if (settings.appName) {
                document.title = settings.appName;
                document.getElementById('loginAppName').textContent = settings.appName;
              }
            }

            // Initialize display view type
            initializeDisplayViewType();

            // Load column configuration
            loadColumnConfig();
            computeUniqueValues();
            updateHeaderUI();
            applyRoleVisibility();
            updateChipsUI();

            // Initialize tabs if configured
            initializeTabs();

            // Cache initial tab data and preload other tabs for instant switching
            cacheInitialTabData();
            preloadOtherTabs();

            // Show layers if configured, otherwise show main list
            navigateToHome();

            // Hide login screen and show app
            hideLoginScreen();

            // Hide loading screen - app is ready
            hideLoadingScreen();

            // Show login button in header for "Public with Login" mode
            updateLoginButtonVisibility();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading public app with login option:', error);
            showToast('Error loading catalogue: ' + error.message, 'error');
          })
          .getInitialData(null);  // No token needed initially
      }

      function loadPrivateApp(token) {
        google.script.run
          .withSuccessHandler(function (payload) {
            user = payload.user;
            settings = payload.settings;
            headers = payload.headers || [];
            allItems = payload.items || [];
            columnConfig = payload.columnConfig || [];

            // Store layer configuration and data
            layerConfig = payload.layerConfig || [];
            layersData = payload.layersData || {};

            // Store tabs configuration (if available)
            tabsConfig = payload.tabsConfig || [];

            // Debug: Log layer data
            console.log('üìä Layer Config:', layerConfig);
            console.log('üìä Layers Data:', layersData);
            console.log('üìä Has Layers:', layerConfig.length > 0);
            console.log('üìë Tabs Config:', tabsConfig);
            console.log('üìë Has Tabs:', tabsConfig.length > 0);

            // Check if user is still authenticated
            if (!user) {
              console.log('Session expired - showing login screen');
              clearSession();
              showLoginScreen();
              return;
            }

            console.log('User authenticated:', user.email, user.profile);

            if (settings) {
              // Use deployment URL from Settings C5
              imageProxyBaseUrl = settings.deploymentUrl || "";

              if (!imageProxyBaseUrl) {
                console.warn('‚ö†Ô∏è No deployment URL configured in Settings C5! Images may not load correctly.');
                console.warn('Please add your /exec URL to Settings sheet cell C5');
              } else {
                console.log('‚úì Image proxy URL set to:', imageProxyBaseUrl);
              }

              // Update app title
              if (settings.appName) {
                document.title = settings.appName;
                document.getElementById('loginAppName').textContent = settings.appName;
              }
            }

            // Initialize display view type
            initializeDisplayViewType();

            // Load column configuration
            loadColumnConfig();
            computeUniqueValues();
            updateHeaderUI();
            applyRoleVisibility();
            updateChipsUI();

            // Initialize tabs if configured
            initializeTabs();

            // Cache initial tab data and preload other tabs for instant switching
            cacheInitialTabData();
            preloadOtherTabs();

            // Show layers if configured, otherwise show main list
            navigateToHome();

            // Hide login screen and show app
            hideLoginScreen();

            // Hide loading screen - app is ready
            hideLoadingScreen();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading app:', error);
            clearSession();
            showLoginScreen();
            showToast('Error loading catalogue: ' + error.message, 'error');
          })
          .getInitialData(token);
      }

      // Event wiring
      window.onload = function () {
        // Login event handlers
        document.getElementById('loginSendCodeBtn').onclick = requestOTP;
        document.getElementById('loginVerifyBtn').onclick = verifyOTP;
        document.getElementById('loginBackBtn').onclick = backToEmailStep;
        document.getElementById('logoutBtn').onclick = logout;

        // Allow Enter key to submit
        document.getElementById('loginEmailInput').onkeypress = function(e) {
          if (e.key === 'Enter') requestOTP();
        };
        document.getElementById('loginCodeInput').onkeypress = function(e) {
          if (e.key === 'Enter') verifyOTP();
        };

        // CRUD event handlers
        document.getElementById("addBtn").onclick = function () {
          if (
            !user ||
            (user.profile !== "Creator" && user.profile !== "Editor")
          ) {
            showToast("Only Creator or Editor can add items.", "warning");
            return;
          }
          openAdd();
        };
        document.getElementById("editCancelBtn").onclick = closeEditModal;

        // Sheet link button (Creator only)
        document.getElementById("sheetLinkBtn").onclick = function() {
          if (settings && settings.sheetUrl) {
            window.open(settings.sheetUrl, '_blank');
          } else {
            // If no sheetUrl in settings, construct from spreadsheet ID
            const ssId = SpreadsheetApp.getActiveSpreadsheet() ? SpreadsheetApp.getActiveSpreadsheet().getId() : null;
            if (ssId) {
              window.open('https://docs.google.com/spreadsheets/d/' + ssId + '/edit', '_blank');
            } else {
              showToast("Google Sheet URL not available.", "warning");
            }
          }
        };

        // Tab switcher button
        document.getElementById("tabSwitcherBtn").onclick = function(e) {
          e.stopPropagation();
          toggleTabMenu();
        };

        init();

        // Initialize swipe detection for mobile detail view navigation
        initializeSwipeDetection();

        // Global click handler to close table menus and tab menu when clicking outside
        document.addEventListener('click', function(e) {
          // Check if click is inside a table menu or on a table header
          const clickedInsideMenu = e.target.closest('.table-column-menu');
          const clickedOnHeader = e.target.closest('.table-header-cell');

          // Only close menus if click was outside both menu and header
          if (!clickedInsideMenu && !clickedOnHeader) {
            const wasMenuOpen = activeTableMenuColumn !== null;
            closeAllTableMenus();
            // If a menu was open and we're in table view, apply filters
            if (wasMenuOpen && (document.querySelector('.table-view') || document.querySelector('.data-table'))) {
              rerenderTable();
            }
          }

          // Close tab menu if clicking outside
          const clickedInsideTabMenu = e.target.closest('.tab-switcher-menu');
          const clickedOnTabBtn = e.target.closest('.tab-switcher-btn');
          if (!clickedInsideTabMenu && !clickedOnTabBtn) {
            const tabMenu = document.getElementById("tabSwitcherMenu");
            if (tabMenu && tabMenu.classList.contains('show')) {
              tabMenu.classList.remove('show');
            }
          }
        });

        // Filter dropdown
        document.getElementById("filterBtn").onclick = function(e) {
          e.stopPropagation();
          toggleDropdown("filterDropdown", "filterBtn");
        };

        // Sort dropdown
        document.getElementById("sortBtn").onclick = function(e) {
          e.stopPropagation();
          toggleDropdown("sortDropdown", "sortBtn");
        };

        // Sort field radio buttons
        document.querySelectorAll('input[name="sortField"]').forEach(radio => {
          radio.onchange = function() {
            sortField = this.value;

            // Hide Order section when "No sorting" is selected, SHOW when sorting is active
            const sortDropdown = document.getElementById('sortDropdown');
            if (sortDropdown) {
              const orderDivider = sortDropdown.querySelector('.dropdown-divider');
              const orderSection = sortDropdown.querySelectorAll('.dropdown-section')[1]; // Second section is Order

              console.log('Sort field changed to:', sortField);
              console.log('Order section found:', orderSection);
              console.log('Order divider found:', orderDivider);

              if (sortField === 'none') {
                if (orderDivider) {
                  orderDivider.style.display = 'none';
                  console.log('Hiding order divider');
                }
                if (orderSection) {
                  orderSection.style.display = 'none';
                  console.log('Hiding order section');
                }
              } else {
                // EXPLICITLY show - set to 'block' to ensure visibility
                if (orderDivider) {
                  orderDivider.style.display = 'block';
                  orderDivider.style.visibility = 'visible';
                  orderDivider.style.opacity = '1';
                  console.log('Showing order divider');
                }
                if (orderSection) {
                  orderSection.style.display = 'block';
                  orderSection.style.visibility = 'visible';
                  orderSection.style.opacity = '1';
                  console.log('Showing order section');
                }
              }
            }

            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        // Initialize: Hide Order section on page load (default is "No sorting")
        (() => {
          const sortDropdown = document.getElementById('sortDropdown');
          const orderDivider = sortDropdown.querySelector('.dropdown-divider');
          const orderSection = sortDropdown.querySelectorAll('.dropdown-section')[1];
          if (sortField === 'none') {
            if (orderDivider) orderDivider.style.display = 'none';
            if (orderSection) orderSection.style.display = 'none';
          }
        })();

        // Sort order radio buttons
        document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
          radio.onchange = function() {
            sortOrder = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        // Make sort items clickable (not just radio button)
        document.querySelectorAll('#sortDropdown .dropdown-item').forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });

        // Real-time search input
        document.getElementById("searchInput").oninput = function() {
          const previousSearchQuery = searchQuery;
          searchQuery = this.value;

          // Show/hide clear button
          const clearBtn = document.getElementById("clearSearchBtn");
          if (searchQuery && searchQuery.trim() !== "") {
            // Save state before first search character
            if (!previousSearchQuery || previousSearchQuery.trim() === "") {
              preSearchNavigationStack = [...navigationStack];
              preSearchLayerIndex = currentLayerIndex;
              preSearchView = currentView;
              preSearchDetailIndex = currentDetailIndex;
              // Save reference to current displayed items for detail view restoration
              if (currentView === "detail" && currentDetailIndex >= 0) {
                preSearchDetailItem = currentDisplayedItems[currentDetailIndex];
              } else {
                preSearchDetailItem = null;
              }
            }

            clearBtn.style.display = "block";
            applyFiltersAndSorting(); // Show search results
          } else {
            clearBtn.style.display = "none";
            // Search cleared - restore previous layer state
            restorePreSearchState();
          }
        };

        // Handle browser back button
        window.addEventListener("popstate", function(e) {
          // Check if image viewer is open first
          if (imageZoomState.isOpen && imageZoomState.openedFromDetailView) {
            // Close the enlarged image viewer
            e.preventDefault();
            closeImageFullscreen(true); // Pass true to indicate this is from back button
            return;
          }

          if (currentView === "detail") {
            // User pressed back while in detail view - go back to list or layer
            e.preventDefault();
            backToList();
          } else if (currentView === "layer") {
            // User pressed back while in layer view - go to previous layer or home
            e.preventDefault();
            backFromLayer();
          } else if (currentView === "list") {
            // User pressed back while in list view
            if (navigationStack.length > 0) {
              // We're in a filtered list from layers - go back to layer
              e.preventDefault();
              backFromLayer();
            } else {
              // Prevent navigation, stay in app
              e.preventDefault();
              history.pushState({ view: "list" }, "", "");
            }
          }
        });

        // Initialize home state for back button handling
        history.replaceState({ view: "list" }, "", "");

        const overlay = document.getElementById("imgOverlay");
        const closeBtn = document.getElementById("imgOverlayClose");
        if (closeBtn) {
          closeBtn.onclick = closeImageFullscreen;
        }
        if (overlay) {
          overlay.addEventListener("click", function (e) {
            if (e.target.id === "imgOverlay") {
              closeImageFullscreen();
            }
          });
        }

        // Initialize image zoom handlers
        setupImageZoom();

        // ==================== PWA INSTALL BANNER LOGIC (GitHub Pages Only) ====================
        // Only run on GitHub Pages - check for the github-pages class on html element
        if (document.documentElement.classList.contains('github-pages')) {
          let deferredPrompt = null;
          const pwaInstallBanner = document.getElementById('pwaInstallBanner');
          const pwaInstallBtn = document.getElementById('pwaInstallBtn');
          const pwaInstallDismiss = document.getElementById('pwaInstallDismiss');

          // Fetch theme color from manifest.json and apply to CSS variables
          fetch('./manifest.json')
            .then(response => response.json())
            .then(manifest => {
              if (manifest.theme_color) {
                const themeColor = manifest.theme_color;
                // Create a darker variant for gradient (darken by ~15%)
                const darkerColor = darkenColor(themeColor, 15);
                document.documentElement.style.setProperty('--pwa-theme-color', themeColor);
                document.documentElement.style.setProperty('--pwa-theme-color-dark', darkerColor);
                console.log('üì± PWA: Theme color loaded from manifest:', themeColor);
              }
            })
            .catch(err => console.warn('üì± PWA: Could not load manifest.json for theme color', err));

          // Helper function to darken a hex color
          function darkenColor(hex, percent) {
            hex = hex.replace('#', '');
            const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - Math.round(2.55 * percent));
            const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - Math.round(2.55 * percent));
            const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - Math.round(2.55 * percent));
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
          }

          // Check if app is already installed (stored permanently in localStorage)
          const appInstalled = localStorage.getItem('pwaAppInstalled');
          // Check if user dismissed banner this session (sessionStorage - resets on page refresh)
          const bannerDismissedThisSession = sessionStorage.getItem('pwaInstallBannerDismissed');

          // Listen for the beforeinstallprompt event
          window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± PWA: beforeinstallprompt event fired');
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Store the event for later use
            deferredPrompt = e;

            // Show the install banner if app not installed and not dismissed this session
            if (!appInstalled && !bannerDismissedThisSession && pwaInstallBanner) {
              pwaInstallBanner.style.display = 'block';
              console.log('üì± PWA: Showing install banner');
            }
          });

          // Handle install button click
          if (pwaInstallBtn) {
            pwaInstallBtn.addEventListener('click', async () => {
              console.log('üì± PWA: Install button clicked');
              if (!deferredPrompt) {
                console.log('üì± PWA: No deferred prompt available');
                return;
              }

              // Hide the banner
              if (pwaInstallBanner) {
                pwaInstallBanner.style.display = 'none';
              }

              // Show the install prompt
              deferredPrompt.prompt();

              // Wait for the user to respond to the prompt
              const { outcome } = await deferredPrompt.userChoice;
              console.log('üì± PWA: User choice:', outcome);

              // Clear the deferred prompt
              deferredPrompt = null;
            });
          }

          // Handle dismiss button click - only hides for current session
          if (pwaInstallDismiss) {
            pwaInstallDismiss.addEventListener('click', () => {
              console.log('üì± PWA: Banner dismissed for this session');
              if (pwaInstallBanner) {
                pwaInstallBanner.style.display = 'none';
              }
              // Only remember dismissal for this session (will show again on refresh)
              sessionStorage.setItem('pwaInstallBannerDismissed', 'true');
            });
          }

          // Listen for successful installation
          window.addEventListener('appinstalled', () => {
            console.log('üì± PWA: App was successfully installed');
            // Hide the banner
            if (pwaInstallBanner) {
              pwaInstallBanner.style.display = 'none';
            }
            // Clear the deferred prompt
            deferredPrompt = null;
            // Mark as installed permanently so banner never shows again
            localStorage.setItem('pwaAppInstalled', 'true');
          });

          console.log('üì± PWA: Install banner logic initialized');
        }


      };
    </script>

    <!-- Service Worker Registration (GitHub Pages PWA Support) -->
    <script>
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then((registration) => {
              console.log('‚úÖ Service Worker registered successfully:', registration.scope);

              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('üîÑ Service Worker update found');

                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('‚ú® New Service Worker installed, refresh to update');
                    // Optionally show a notification to the user
                  }
                });
              });
            })
            .catch((error) => {
              console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
            });
        });
      } else {
        console.warn('‚ö†Ô∏è Service Workers are not supported in this browser');
      }
    </script>
  </body>
        </html>
